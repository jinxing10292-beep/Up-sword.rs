
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Up Sword</title>
    <link rel="icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <link rel="shortcut icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Pretendard í°íŠ¸ ë° ê¸°ë³¸ í…Œë§ˆ ì„¤ì • */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* ì»¨í…Œì´ë„ˆ ë””ìì¸ */
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #1a202c; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ê²€ ì´ë¯¸ì§€ ì˜ì—­ */
        .img-area { background: #edf2f7; height: 260px; margin: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); transition: transform 0.1s; }
        
        /* ê°•í™” ì •ë³´ ì˜ì—­ */
        .info-area { padding: 0 24px 24px; text-align: center; }
        #s-name { font-size: 24px; font-weight: 800; color: #2d3748; }
        #s-desc { font-size: 14px; color: #718096; margin: 8px 0 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #f8fafc; padding: 12px; border-radius: 16px; font-size: 13px; font-weight: 600; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-group { padding: 0 20px 24px; display: flex; gap: 12px; }
        .btn-main { flex: 2; padding: 18px; border-radius: 16px; border: none; background: #2d3748; color: white; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #1a202c; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #1a202c; }
        .btn-sub { flex: 1; padding: 18px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; color: #4a5568; font-weight: 700; cursor: pointer; }
        .btn-items { padding: 12px; border-radius: 12px; border: 2px solid #9f7aea; background: #faf5ff; color: #553c9a; font-weight: 700; cursor: pointer; margin-bottom: 12px; }
        .btn-items:hover { background: #f3e8ff; }
    .gold-wrap { display: flex; align-items: center; gap: 10px; }
    .code-btn { padding: 5px 12px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
    .money-float { position: absolute; animation: floatUp 1s forwards; font-weight: bold; font-size: 14px; pointer-events: none; }
    @keyframes floatUp { to { transform: translateY(-30px); opacity: 0; } }

        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .hammering { animation: shake 0.15s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 50% { transform: rotate(3deg); } 100% { transform: rotate(0); } }
        #full-effect { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: 900; pointer-events: none; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* ë§¤í¬ë¡œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .macro-panel { background: #f8fafc; border-radius: 16px; margin: 0 20px 20px; padding: 15px; border: 2px solid #e2e8f0; }
        .macro-header h3 { margin: 0 0 15px 0; color: #2d3748; font-size: 16px; }
        .macro-controls { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .macro-input-group { display: flex; align-items: center; gap: 10px; }
        .macro-input-group label { font-weight: 600; font-size: 14px; }
        .macro-input-group input { width: 60px; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center; }
        .macro-buttons { display: flex; gap: 8px; }
        .macro-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .macro-btn.start { background: #48bb78; color: white; }
        .macro-btn.stop { background: #f56565; color: white; }
        .macro-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .macro-log { border-top: 1px solid #e2e8f0; padding-top: 12px; }
        .log-header { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #2d3748; }
        .log-content { max-height: 200px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 12px; }
        .log-entry { margin-bottom: 4px; padding: 2px 0; }
        .log-success { color: #48bb78; }
        .log-fail { color: #f56565; }
        .log-destroy { color: #e53e3e; font-weight: 600; }
        
        /* ë§¤í¬ë¡œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .macro-panel { background: white; margin: 20px; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .macro-header h3 { margin: 0 0 15px 0; color: #2d3748; text-align: center; }
        .macro-controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .macro-input-group { display: flex; align-items: center; gap: 10px; }
        .macro-input-group label { font-weight: 600; color: #4a5568; min-width: 80px; }
        .macro-input-group input { flex: 1; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        .macro-buttons { display: flex; gap: 10px; }
        .macro-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.2s; }
        .macro-btn.start { background: #48bb78; color: white; }
        .macro-btn.start:hover { background: #38a169; }
        .macro-btn.stop { background: #f56565; color: white; }
        .macro-btn.stop:hover { background: #e53e3e; }
        .macro-btn:disabled { background: #cbd5e0; color: #a0aec0; cursor: not-allowed; }
        .macro-log { border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .log-header { background: #f7fafc; padding: 10px 15px; font-weight: 600; color: #2d3748; border-bottom: 1px solid #e2e8f0; }
        .log-content { max-height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; line-height: 1.4; }
        .log-entry { margin-bottom: 5px; }
        .log-success { color: #38a169; }
        .log-fail { color: #e53e3e; }
        .log-destroy { color: #d69e2e; font-weight: bold; }
        .log-info { color: #3182ce; }
        
        /* ê°•í™” íˆìŠ¤í† ë¦¬ íŒ¨ë„ */
        .history-panel { margin: 20px; padding: 15px; background: #f8fafc; border-radius: 12px; }
        .history-panel h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: #2d3748; }
        .history-grid { display: flex; gap: 5px; flex-wrap: wrap; }
        .history-item { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: white; }
        .history-success { background: #48bb78; }
        .history-fail { background: #cbd5e0; }
        .history-destroy { background: #f56565; }
        
        /* ì½¤ë³´ íš¨ê³¼ */
        @keyframes comboAnim {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        /* ê°œì„ ëœ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes successGlow {
            0% { filter: drop-shadow(0 0 0 rgba(72, 187, 120, 0)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 30px rgba(72, 187, 120, 1)); transform: scale(1.1); }
            100% { filter: drop-shadow(0 0 0 rgba(72, 187, 120, 0)); transform: scale(1); }
        }
        
        @keyframes failShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        @keyframes destroyExplode {
            0% { opacity: 1; transform: scale(1) rotate(0deg); }
            50% { opacity: 0.5; transform: scale(1.5) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        
        .success-effect { animation: successGlow 1s ease-out; }
        .fail-effect { animation: failShake 0.5s ease-out; }
        .destroy-effect { animation: destroyExplode 1s ease-out; }
        
        /* ì´ë²¤íŠ¸ ë°°ë„ˆ */
        .event-banner {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        /* ì½¤ë³´ ì¹´ìš´í„° */
        .combo-counter {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 18px;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            display: none;
        }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 50px;">ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</div>
<div id="full-effect"></div>
<div id="eventBanner" style="display: none;" class="event-banner"></div>
<div id="comboCounter" class="combo-counter"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button onclick="location.href='home.html'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" title="í™ˆìœ¼ë¡œ">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-size: 14px;">...</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color:#f1c40f; font-weight: bold; margin-right: 10px;">0G</span>
            <span id="u-money" style="color:#9b59b6; font-weight: bold;">0M</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
            <button id="adminBtn" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; display:none; margin-left: 10px;">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </div>

    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>

    <div class="info-area">
        <div id="s-name">ê²€ ì •ë³´</div>
        <div id="s-desc">ê²€ ì„¤ëª…</div>
        <div class="stats-grid">
            <div><i class="fa-solid fa-hammer"></i> <span id="stat-cost">0</span></div>
            <div><i class="fa-solid fa-sack-dollar"></i> <span id="stat-sell">0</span></div>
            <div><i class="fa-solid fa-percent"></i> <span id="stat-rate">0</span></div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-items" onclick="location.href='items.html'">ğŸ“¦ ì•„ì´í…œ ì‚¬ìš©</button>
    </div>
    
    <!-- ê°•í™” íˆìŠ¤í† ë¦¬ íŒ¨ë„ -->
    <div class="history-panel">
        <h3>ğŸ“Š ìµœê·¼ ê°•í™” ê¸°ë¡</h3>
        <div id="enhanceHistory" class="history-grid">
            <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
    </div>
    
    <!-- ë§¤í¬ë¡œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div class="macro-panel" id="macroPanel" style="display:none;">
        <div class="macro-header">
            <h3>ğŸ¤– ìë™ ê°•í™” ë§¤í¬ë¡œ</h3>
        </div>
        <div class="macro-controls">
            <div class="macro-input-group">
                <label>ëª©í‘œ ë ˆë²¨:</label>
                <input type="number" id="targetLevel" min="1" max="20" value="10">
            </div>
            <div class="macro-buttons">
                <button id="startMacroBtn" class="macro-btn start" onclick="startMacro()">ì‹œì‘</button>
                <button id="stopMacroBtn" class="macro-btn stop" onclick="stopMacro()" disabled>ì¤‘ì§€</button>
            </div>
        </div>
        <div class="macro-log">
            <div class="log-header">ê°•í™” ë¡œê·¸</div>
            <div class="log-content" id="macroLog"></div>
        </div>
    </div>
    
    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-sub" onclick="handleStore()">ë³´ê´€í•˜ê¸°</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {};
    let isAdmin = false;
    let allUsers = [];
    let isUpgrading = false; // Flag to track if an upgrade is in progress
    const variantNameCache = new Map(); // key: `${weapon_key}:${level}` => name
    
    // ë§¤í¬ë¡œ ê´€ë ¨ ë³€ìˆ˜ë“¤
    let macroActive = false;
    let macroTargetLevel = 10;
    let macroLog = [];
    let macroInterval = null;
    let hasMacro = false; // ë§¤í¬ë¡œ êµ¬ë§¤ ì—¬ë¶€
    
    // ì½¤ë³´ ì‹œìŠ¤í…œ
    let comboCount = 0;
    let comboMultiplier = 1.0;
    
    // ê°•í™” íˆìŠ¤í† ë¦¬
    let enhanceHistory = [];

    async function getVariantName(weaponKey, level) {
        const cl = Math.max(0, Math.min(20, parseInt(level || 0, 10)));
        const cacheKey = `${weaponKey}:${cl}`;
        if (variantNameCache.has(cacheKey)) return variantNameCache.get(cacheKey);
        
        try {
            // Use local sword_names.json instead of non-existent weapon_variants table
            const response = await fetch('sword_names.json');
            const swordData = await response.json();
            
            // Find matching sword by type and level
            const weaponType = getWeaponType();
            const matchingSword = swordData.swords.find(s => 
                s.type === weaponType && s.level === cl
            );
            
            const name = matchingSword ? matchingSword.name : `${weaponType === 'hidden' ? '[HIDDEN] ' : ''}ê²€ +${cl}`;
            variantNameCache.set(cacheKey, name);
            return name;
        } catch (error) {
            console.warn('ê²€ ì´ë¦„ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¦„ ì‚¬ìš©:', error);
            const weaponType = getWeaponType();
            const fallbackName = `${weaponType === 'hidden' ? '[HIDDEN] ' : ''}ê²€ +${cl}`;
            variantNameCache.set(cacheKey, fallbackName);
            return fallbackName;
        }
    }

    function getWeaponType() {
        return (user && user.current_weapon_type) ? user.current_weapon_type : 'normal';
    }

    function getWeaponName(type, level) {
        const arr = WEAPON_NAMES[type] || WEAPON_NAMES.normal;
        const idx = Math.max(0, Math.min(20, parseInt(level || 0, 10)));
        return arr[idx] || arr[0];
    }

    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }

            const { data: p, error: profileError } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            if (profileError || !p) {
                console.warn('í”„ë¡œí•„ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¡œë“œ ì‹¤íŒ¨, í”„ë¡œí•„ ìƒì„± ì‹œë„:', profileError);
                // í”„ë¡œí•„ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ í”„ë¡œí•„ì„ ìƒì„±í•´ë³´ê³  ê³„ì† ì§„í–‰
                try {
                    const nickname = session.user.user_metadata?.nickname || session.user.email?.split('@')[0] || 'Player';
                    const insertData = {
                        id: session.user.id,
                        nickname: nickname,
                        gold: 10000,
                        money: 0,
                        current_sword_lvl: 0
                    };
                    const { error: insertErr } = await supabaseClient.from('profiles').insert(insertData);
                    if (insertErr) {
                        console.error('í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨:', insertErr);
                        alert('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                        await supabaseClient.auth.signOut();
                        location.href = "login.html";
                        return;
                    }
                    const { data: newProfile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
                    user = newProfile;
                } catch (e) {
                    console.error('í”„ë¡œí•„ ìƒì„± ì¤‘ ì˜¤ë¥˜:', e);
                    alert('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                    await supabaseClient.auth.signOut();
                    location.href = "login.html";
                    return;
                }
            } else {
                user = p;
            }

            // ì•ˆì „í•œ ê¸°ë³¸ê°’ ì„¤ì • - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ null/undefinedì¸ ê²½ìš°ì—ë§Œ 0ìœ¼ë¡œ ì„¤ì •
            if (user.current_sword_lvl === null || user.current_sword_lvl === undefined) {
                console.log('ê²€ ë ˆë²¨ì´ null/undefinedì´ë¯€ë¡œ 0ìœ¼ë¡œ ì´ˆê¸°í™”');
                user.current_sword_lvl = 0;
                // ë°ì´í„°ë² ì´ìŠ¤ì—ë„ ëª…ì‹œì ìœ¼ë¡œ 0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                await supabaseClient.from('profiles').update({ current_sword_lvl: 0 }).eq('id', user.id);
            } else {
                // ìœ íš¨í•œ ë ˆë²¨ ê°’ì´ ìˆëŠ” ê²½ìš° ë¡œê·¸ ì¶œë ¥
                console.log('ê¸°ì¡´ ê²€ ë ˆë²¨ ìœ ì§€:', user.current_sword_lvl);
            }

            // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© í”Œë˜ê·¸ ì´ˆê¸°í™” (ë¡œì»¬ ì¶”ì ìš©)
            if (user.used_enhance_scroll === undefined) {
                user.used_enhance_scroll = false;
            }

            if (!user.current_weapon_type) {
                user.current_weapon_type = 'normal';
                await supabaseClient.from('profiles').update({ current_weapon_type: 'normal' }).eq('id', user.id);
            }

            if (!user.current_weapon_key) {
                user.current_weapon_key = 'sword_01';
                await supabaseClient.from('profiles').update({ current_weapon_key: 'sword_01' }).eq('id', user.id);
            }

            const { data: sData } = await supabaseClient.from('sword_data').select('*').order('level');
            sData.forEach(d => swords[d.level] = d);

            // Check if user is admin
            isAdmin = user.email === 'admin@example.com'; // ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë³€ê²½ í•„ìš”
            if (isAdmin) {
                document.getElementById('adminBtn').style.display = 'block';
                document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
                await loadAllUsers();
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
            
            // ì•„ì´í…œ ì‚¬ìš© í™•ì¸
            checkForItemUsage();
            
            // ë§¤í¬ë¡œ ë³´ìœ  í™•ì¸
            checkMacroOwnership();
            
            // ì´ë²¤íŠ¸ íƒ€ì„ ì²´í¬
            checkEventTime();
        } catch (e) { alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
    
    // ë§¤í¬ë¡œ ë³´ìœ  í™•ì¸
    async function checkMacroOwnership() {
        try {
            // profiles í…Œì´ë¸”ì—ì„œ has_macro í•„ë“œ í™•ì¸ (ì˜êµ¬ ì†Œìœ )
            hasMacro = user.has_macro || false;
            
            console.log('ë§¤í¬ë¡œ ì†Œìœ  ìƒíƒœ í™•ì¸:', {
                userId: user.id,
                hasMacro: hasMacro,
                userHasMacro: user.has_macro
            });
            
            if (hasMacro) {
                document.getElementById('macroPanel').style.display = 'block';
                console.log('ë§¤í¬ë¡œ íŒ¨ë„ í‘œì‹œë¨');
            } else {
                document.getElementById('macroPanel').style.display = 'none';
                console.log('ë§¤í¬ë¡œ ë¯¸ì†Œìœ  - íŒ¨ë„ ìˆ¨ê¹€');
            }
        } catch (e) {
            console.error('ë§¤í¬ë¡œ í™•ì¸ ì˜¤ë¥˜:', e);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•ˆì „í•˜ê²Œ ë§¤í¬ë¡œ íŒ¨ë„ ìˆ¨ê¹€
            document.getElementById('macroPanel').style.display = 'none';
        }
    }

    function getSellPrice(level) {
        // ìƒˆë¡œìš´ íŒë§¤ê°€ ê³µì‹: (ê°•í™”ë¹„ìš© + ê¸°ì¡´íŒë§¤ë¹„ìš©) Ã— ê°•í™”í™•ë¥ ì—­ìˆ˜ Ã— 0.8 (20% ê°ì†Œ)
        const enhanceCost = getEnhancementCost(level);
        const successRate = getSuccessRate(level);
        
        let basePrice;
        if (level === 20) {
            basePrice = 10000000; // 20ë ˆë²¨ ê³ ì •ê°€
        } else {
            const cube = level * level * level;
            if (level >= 15) {
                basePrice = cube * 200;
            } else if (level >= 10) {
                basePrice = cube * 100;
            } else {
                basePrice = cube * 50;
            }
        }
        
        // ìƒˆë¡œìš´ ê³µì‹: (ê°•í™”ë¹„ìš© + ê¸°ì¡´íŒë§¤ê°€) Ã— ì„±ê³µí™•ë¥ ì—­ìˆ˜ Ã— 0.8 (20% í• ì¸)
        const probabilityMultiplier = successRate > 0 ? (100 / successRate) : 1;
        // Apply existing 20% factor, then reduce final sell price by additional 5%
        const newPrice = Math.floor((enhanceCost + basePrice) * probabilityMultiplier * 0.8 * 0.95);
        
        return newPrice;
    }

    // ì•„ì´í…œ ì‚¬ìš© ê´€ë ¨ í•¨ìˆ˜ë“¤
    function checkForItemUsage() {
        const useItemId = sessionStorage.getItem('useItemId');
        const userItemId = sessionStorage.getItem('userItemId');
        
        // null ì²´í¬ ë° ìœ íš¨ì„± ê²€ì‚¬
        if (useItemId && userItemId && useItemId !== 'null' && userItemId !== 'null') {
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
            sessionStorage.removeItem('useItemId');
            sessionStorage.removeItem('userItemId');
            
            // ì•„ì´í…œ ì‚¬ìš© í™•ì¸
            showItemUsageConfirm(useItemId, userItemId);
        } else {
            // ì˜ëª»ëœ ê°’ì´ ìˆìœ¼ë©´ í´ë¦¬ì–´
            sessionStorage.removeItem('useItemId');
            sessionStorage.removeItem('userItemId');
        }
    }
    
    function showItemUsageConfirm(itemId, userItemId) {
        const itemNames = {
            'enhance_scroll_1': 'í™•ì • ê°•í™”ê¶Œ (1~5ê°•)',
            'enhance_scroll_2': 'í™•ì • ê°•í™”ê¶Œ (6~10ê°•)',
            'enhance_scroll_3': 'í™•ì • ê°•í™”ê¶Œ (11~15ê°•)',
            'enhance_scroll_4': 'í™•ì • ê°•í™”ê¶Œ (16~20ê°•)',
            'protect_scroll_1': 'íŒŒê´´ ë°©ì§€ê¶Œ (1~10ê°•)',
            'protect_scroll_2': 'íŒŒê´´ ë°©ì§€ê¶Œ (11~15ê°•)',
            'protect_scroll_3': 'íŒŒê´´ ë°©ì§€ê¶Œ (16~20ê°•)',
            'maintain_scroll_1': 'ë ˆë²¨ ìœ ì§€ê¶Œ (11~15ê°•)',
            'maintain_scroll_2': 'ë ˆë²¨ ìœ ì§€ê¶Œ (16~20ê°•)'
        };
        
        const itemName = itemNames[itemId] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ';
        const currentLevel = user.current_sword_lvl;
        
        // ì•„ì´í…œ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        const canUse = checkItemUsability(itemId, currentLevel);
        
        if (!canUse.usable) {
            alert(`ì´ ì•„ì´í…œì€ í˜„ì¬ ë ˆë²¨(${currentLevel}ê°•)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n${canUse.reason}`);
            return;
        }
        
        if (confirm(`${itemName}ì„(ë¥¼) ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ê²€ ë ˆë²¨: ${currentLevel}ê°•`)) {
            useItemForEnhancement(itemId, userItemId);
        }
    }
    
    function checkItemUsability(itemId, currentLevel) {
        const itemRanges = {
            'enhance_scroll_1': { min: 1, max: 5 },
            'enhance_scroll_2': { min: 6, max: 10 },
            'enhance_scroll_3': { min: 11, max: 15 },
            'enhance_scroll_4': { min: 16, max: 20 },
            'protect_scroll_1': { min: 1, max: 10 },
            'protect_scroll_2': { min: 11, max: 15 },
            'protect_scroll_3': { min: 16, max: 20 },
            'maintain_scroll_1': { min: 11, max: 15 },
            'maintain_scroll_2': { min: 16, max: 20 }
        };
        
        const range = itemRanges[itemId];
        if (!range) {
            return { usable: false, reason: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.' };
        }
        
        // ê°•í™”ì„ì€ ëª¨ë“  ë ˆë²¨ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
        if (itemId.startsWith('stone_')) {
            if (currentLevel >= 20) {
                return { usable: false, reason: 'ì´ë¯¸ ìµœëŒ€ ê°•í™” ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' };
            }
            return { usable: true };
        }
        
        if (currentLevel < range.min || currentLevel > range.max) {
            return { 
                usable: false, 
                reason: `ì´ ì•„ì´í…œì€ ${range.min}~${range.max}ê°•ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.` 
            };
        }
        
        if (currentLevel >= 20) {
            return { usable: false, reason: 'ì´ë¯¸ ìµœëŒ€ ê°•í™” ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' };
        }
        
        return { usable: true };
    }
    
    async function useItemForEnhancement(itemId, userItemId) {
        if (isUpgrading) return;
        
        try {
            isUpgrading = true;
            
            // ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ
            const { data: item } = await supabaseClient
                .from('user_items')
                .select('*')
                .eq('id', userItemId)
                .single();
            
            if (!item) {
                alert('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                isUpgrading = false;
                return;
            }
            
            if (item.quantity <= 0) {
                alert('ì•„ì´í…œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                isUpgrading = false;
                return;
            }
            
            // ì•„ì´í…œ íš¨ê³¼ ì ìš©
            const result = applyItemEffect(itemId);
            
            if (result.success) {
                // ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ ë˜ëŠ” ì‚­ì œ
                if (item.quantity > 1) {
                    await supabaseClient
                        .from('user_items')
                        .update({ quantity: item.quantity - 1 })
                        .eq('id', userItemId)
                        .select();
                } else {
                    await supabaseClient
                        .from('user_items')
                        .delete()
                        .eq('id', userItemId)
                        .select();
                }
                
                // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© ì‹œ íŒë§¤ê°€ í˜ë„í‹° í”Œë˜ê·¸ ì„¤ì •
                const usedEnhanceScroll = itemId.startsWith('enhance_scroll_');
                
                // ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸
                // ì•ˆì „ì¥ì¹˜: ë ˆë²¨ í•˜ë½ ë°©ì§€
                if (result.newLevel < user.current_sword_lvl && !result.weaponType) {
                    console.warn('ì•„ì´í…œ ì‚¬ìš© ì‹œ ë ˆë²¨ í•˜ë½ ë°©ì§€');
                    result.newLevel = user.current_sword_lvl;
                }
                
                const updateData = {
                    current_sword_lvl: result.newLevel,
                    current_weapon_type: result.weaponType || user.current_weapon_type,
                    current_weapon_key: result.weaponKey || user.current_weapon_key
                };
                
                // Note: used_enhance_scroll is tracked locally only (not in database)
                
                const { error: updateErr } = await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('id', user.id);
                
                if (updateErr) {
                    throw updateErr;
                }
                
                // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                user.current_sword_lvl = result.newLevel;
                if (result.weaponType) user.current_weapon_type = result.weaponType;
                if (result.weaponKey) user.current_weapon_key = result.weaponKey;
                if (usedEnhanceScroll) user.used_enhance_scroll = true;
                
                // UI ì—…ë°ì´íŠ¸
                updateUI();
                
                // ì„±ê³µ ë©”ì‹œì§€
                alert(result.message + (usedEnhanceScroll ? '\nâ€» í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ íŒë§¤ê°€ 50% ê°ì†Œë©ë‹ˆë‹¤.' : ''));
            } else {
                alert(result.message);
            }
            
        } catch (e) {
            alert('ì•„ì´í…œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        } finally {
            isUpgrading = false;
        }
    }
    
    function applyItemEffect(itemId) {
        const currentLevel = user.current_sword_lvl;
        
        if (itemId.startsWith('enhance_scroll_')) {
            // í™•ì • ê°•í™”ê¶Œ - ë¬´ì¡°ê±´ 100% ì„±ê³µ
            return {
                success: true,
                newLevel: currentLevel + 1,
                message: `í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ ê°•í™” ì„±ê³µ! [+${currentLevel + 1}ë ˆë²¨]`
            };
        } else if (itemId.startsWith('protect_scroll_') || itemId.startsWith('maintain_scroll_')) {
            // ë³´í˜¸ ì•„ì´í…œ - íŒŒê´´ì™€ í•˜ë½ì„ ì™„ì „íˆ ë°©ì§€
            const rates = getEnhancementRates(currentLevel);
            const random = Math.random() * 100;
            
            let newLevel = currentLevel;
            let message = "";
            
            // ì„±ê³µ í™•ë¥ ë§Œ ì ìš©, ì‹¤íŒ¨ ì‹œ ë ˆë²¨ ìœ ì§€ (íŒŒê´´/í•˜ë½ 0%)
            if (random <= rates.success) {
                newLevel = currentLevel + 1;
                message = `ë³´í˜¸ ì•„ì´í…œ ì‚¬ìš©ìœ¼ë¡œ ê°•í™” ì„±ê³µ! [+${newLevel}ë ˆë²¨]`;
            } else {
                // ì‹¤íŒ¨í•´ë„ ë ˆë²¨ ìœ ì§€ (ë³´í˜¸ íš¨ê³¼)
                message = "ê°•í™” ì‹¤íŒ¨í–ˆì§€ë§Œ ë³´í˜¸ ì•„ì´í…œìœ¼ë¡œ ë ˆë²¨ ìœ ì§€!";
            }
            
            return {
                success: true,
                newLevel,
                weaponType: null,
                weaponKey: null,
                message
            };
        }
        
        return {
            success: false,
            message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.'
        };
    }

    async function updateUI() {
        const currentLevel = user.current_sword_lvl;
        const item = getSwordDataForLevel(currentLevel);
        const upgradeCost = getEnhancementCost(currentLevel);
        const sellPrice = getSellPrice(currentLevel);
        const successRate = getSuccessRate(currentLevel);

        const weaponType = getWeaponType();
        const weaponKey = user.current_weapon_key || 'sword_01';
        const isHidden = weaponType === 'hidden';

        // If a temporary hidden flag was set (e.g., just awarded), clear it once
        // the user obtains a non-zero level weapon so the hidden state doesn't persist.
        try {
            const tmpHidden = sessionStorage.getItem('hidden_temporary');
            if (tmpHidden && user.current_sword_lvl > 0 && user.current_weapon_type === 'hidden') {
                // Reset to normal weapon on server and locally
                try {
                    const { error: clearErr } = await supabaseClient.from('profiles')
                        .update({ current_weapon_type: 'normal', current_weapon_key: 'sword_01' })
                        .eq('id', user.id);
                    if (!clearErr) {
                        sessionStorage.removeItem('hidden_temporary');
                        user.current_weapon_type = 'normal';
                        user.current_weapon_key = 'sword_01';
                    } else {
                        console.warn('failed to clear temporary hidden on server:', clearErr);
                    }
                } catch (e) {
                    console.warn('error clearing temporary hidden:', e);
                }
            }
        } catch (e) {
            console.warn('hidden_temporary check error:', e);
        }
        
        document.getElementById('u-nick').innerText = ((user.nickname && user.nickname.trim()) ? user.nickname : 'í”Œë ˆì´ì–´') + 'ë‹˜';
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString() + "G";
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString() + "M";
        
        try {
            const name = await getVariantName(weaponKey, currentLevel);
            document.getElementById('s-name').innerText = `[+${currentLevel}] ${weaponType === 'hidden' ? '[HIDDEN] ' : ''}${name}`;
        } catch (e) {
            // Fallback if name loading fails
            document.getElementById('s-name').innerText = `[+${currentLevel}] ${weaponType === 'hidden' ? '[HIDDEN] ' : ''}ê²€`;
        }
        
        document.getElementById('s-desc').innerText = item.description;
        
        // íˆë“  ê²€ì€ ë¨¸ë‹ˆë¡œ ë¹„ìš© í‘œì‹œ
        if (isHidden) {
            const costInMoney = Math.ceil(upgradeCost / 1000);
            document.getElementById('stat-cost').innerText = costInMoney.toLocaleString() + "M";
        } else {
            document.getElementById('stat-cost').innerText = upgradeCost.toLocaleString() + "G";
        }
        
        document.getElementById('stat-sell').innerText = sellPrice.toLocaleString() + "G";
        document.getElementById('stat-rate').innerText = successRate + "%";
        
        // ì´ë¯¸ì§€ URLì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
        const imageUrl = item.image_url || 'https://via.placeholder.com/300x300?text=Sword';
        document.getElementById('s-img').src = imageUrl;
    }

    function getSwordDataForLevel(level) {
        const lv = Math.max(0, Math.min(20, parseInt(level || 0, 10)));
        if (swords[lv]) return swords[lv];

        for (let i = lv; i >= 0; i--) {
            if (swords[i]) return swords[i];
        }
        
        // ê¸°ë³¸ê°’ ë°˜í™˜
        return swords[1] || {
            level: lv,
            description: `+${lv} ê°•í™” ê²€`,
            image_url: 'https://via.placeholder.com/300x300?text=Sword'
        };
    }
    
    function getSuccessRate(level) {
        const rates = [
            85,  // 0 â†’ 1 (80â†’85)
            80,  // 1 â†’ 2 (75â†’80)
            75,  // 2 â†’ 3 (70â†’75)
            70,  // 3 â†’ 4 (65â†’70)
            65,  // 4 â†’ 5 (60â†’65)
            60,  // 5 â†’ 6 (55â†’60)
            55,  // 6 â†’ 7 (50â†’55)
            50,  // 7 â†’ 8 (45â†’50)
            45,  // 8 â†’ 9 (40â†’45)
            40,  // 9 â†’ 10 (35â†’40)
            35,  // 10 â†’ 11 (30â†’35)
            30,  // 11 â†’ 12 (25â†’30)
            25,  // 12 â†’ 13 (20â†’25)
            20,  // 13 â†’ 14 (15â†’20)
            17,  // 14 â†’ 15 (12â†’17)
            15,  // 15 â†’ 16 (10â†’15)
            13,  // 16 â†’ 17 (8â†’13)
            10,  // 17 â†’ 18 (5â†’10)
            8,   // 18 â†’ 19 (3â†’8)
            5    // 19 â†’ 20 (1â†’5)
        ];
        return rates[level] || 0;
    }

    function getEnhancementCost(level) {
        // Enhancement costs from PRD - 1% í• ì¸ ì ìš©
        const baseCosts = [
            100,        // 0 â†’ 1
            200,        // 1 â†’ 2
            400,        // 2 â†’ 3
            800,        // 3 â†’ 4
            1600,       // 4 â†’ 5
            3200,       // 5 â†’ 6
            6400,       // 6 â†’ 7
            12800,      // 7 â†’ 8
            25600,      // 8 â†’ 9
            51200,      // 9 â†’ 10
            102400,     // 10 â†’ 11
            204800,     // 11 â†’ 12
            409600,     // 12 â†’ 13
            819200,     // 13 â†’ 14
            1638400,    // 14 â†’ 15
            3276800,    // 15 â†’ 16
            6553600,    // 16 â†’ 17
            13107200,   // 17 â†’ 18
            26214400,   // 18 â†’ 19
            52428800    // 19 â†’ 20
        ];
        const baseCost = baseCosts[level] || 0;
        return Math.floor(baseCost * 0.99); // 1% í• ì¸
    }

    async function handleUpgrade() {
        console.log('=== ê°•í™” ì‹œì‘ ===');
        console.log('isUpgrading:', isUpgrading);
        console.log('user:', user);
        
        if (isUpgrading) {
            console.log('ì´ë¯¸ ê°•í™” ì¤‘');
            return;
        }
        
        if (!user) {
            console.error('user ë°ì´í„° ì—†ìŒ');
            alert('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const currentLevel = user.current_sword_lvl;
        const currentSword = swords[currentLevel];
        const isHidden = user.current_weapon_type === 'hidden';
        
        console.log('í˜„ì¬ ë ˆë²¨:', currentLevel);
        console.log('í˜„ì¬ ê²€:', currentSword);
        console.log('íˆë“  ê²€ ì—¬ë¶€:', isHidden);
        
        // Get enhancement rates and cost based on current level
        const rates = getEnhancementRates(currentLevel);
        const upgradeCost = getEnhancementCost(currentLevel);
        const costInMoney = Math.ceil(upgradeCost / 1000); // 1000G = 1M
        
        console.log('ê°•í™” í™•ë¥ :', rates);
        console.log('ê°•í™” ë¹„ìš©:', upgradeCost);
        console.log('ë³´ìœ  ê³¨ë“œ:', user.gold);
        console.log('ë³´ìœ  ë¨¸ë‹ˆ:', user.money);
        
        if (upgradeCost <= 0) return alert("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!");
        if (currentLevel >= 20) return alert("ìµœëŒ€ ê°•í™” ë ˆë²¨(20)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!");
        
        // íˆë“  ê²€ì€ ë¨¸ë‹ˆë¡œ, ì¼ë°˜ ê²€ì€ ê³¨ë“œë¡œ ê°•í™”
        if (isHidden) {
            if (user.money < costInMoney) return alert(`ë¨¸ë‹ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${costInMoney}M)`);
        } else {
            if (user.gold < upgradeCost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        }
        
        isUpgrading = true; // Set upgrading flag

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        
        // ë¹„ìš© ì°¨ê°
        if (isHidden) {
            user.money -= costInMoney;
        } else {
            user.gold -= upgradeCost;
        }
        
        // ì´ë²¤íŠ¸ íƒ€ì„ ì²´í¬ ë° ì„±ê³µë¥  ë³´ë„ˆìŠ¤ ì ìš©
        const eventMultiplier = getEventMultiplier();
        if (eventMultiplier > 1) {
            rates.success = Math.min(rates.success * eventMultiplier, 100);
        }
        
        // ê°•í™”ì„ ì‹œìŠ¤í…œ ì œê±° - ë” ì´ìƒ ê°•í™”ì„ ë³´ë„ˆìŠ¤ ì—†ìŒ
        
        // Determine enhancement result
        const result = determineEnhancementResult(rates);
        let newLevel = currentLevel;
        let message = "";
        let nextWeaponType = getWeaponType();
        let nextWeaponKey = user.current_weapon_key || 'sword_01';
        let hiddenSwordBonus = false;
        
        switch(result) {
            case 'success':
                newLevel = currentLevel + 1;
                
                // ì½¤ë³´ ì‹œìŠ¤í…œ ì ìš©
                comboCount++;
                // Reduce combo growth: 5% per combo and cap the multiplier
                comboMultiplier = Math.min(1 + (comboCount * 0.05), 1.5);

                // Smaller bonus to avoid large inflation
                const bonusGold = Math.floor(upgradeCost * (comboMultiplier - 1) * 0.5);
                if (bonusGold > 0) {
                    user.gold += bonusGold;
                    message = `ê°•í™” ì„±ê³µ! [+${newLevel}ë ˆë²¨] ğŸ”¥ ${comboCount}ì½¤ë³´! (+${bonusGold.toLocaleString()}G ë³´ë„ˆìŠ¤)`;
                } else {
                    message = `ê°•í™” ì„±ê³µ! [+${newLevel}ë ˆë²¨]`;
                }
                
                // ì½¤ë³´ UI í‘œì‹œ
                if (comboCount >= 3) {
                    showComboEffect(comboCount);
                }
                updateComboCounter();
                
                // ì¼ë°˜ ê°•í™” ì„±ê³µ ì‹œ í™•ì • ê°•í™”ê¶Œ í”Œë˜ê·¸ ì´ˆê¸°í™”
                user.used_enhance_scroll = false;
                
                // ë¯¸ì…˜/ì—…ì  ì—…ë°ì´íŠ¸
                try {
                    incrementUserMissionByKey('enhance_success', 1);
                    incrementUserAchievementByKey('enhance_success', 1);
                    
                    // ë ˆë²¨ë³„ ì—…ì 
                    if (newLevel >= 10) {
                        incrementUserAchievementByKey('enhance_10', 1);
                    }
                    if (newLevel >= 15) {
                        incrementUserAchievementByKey('enhance_15', 1);
                    }
                    if (newLevel >= 20) {
                        incrementUserAchievementByKey('enhance_20', 1);
                    }
                } catch (e) {
                    console.warn('ë¯¸ì…˜/ì—…ì  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
                }
                break;
            case 'maintain':
                message = "ê°•í™” ì‹¤íŒ¨!";
                // ì½¤ë³´ ì´ˆê¸°í™”
                comboCount = 0;
                comboMultiplier = 1.0;
                updateComboCounter();
                break;
            case 'destroy':
                newLevel = 0;
                // íˆë“  ê²€ í™•ë¥  ì²´í¬ (1%)
                if (Math.random() < 0.01) {
                    nextWeaponType = 'hidden';
                    const n = Math.floor(Math.random() * 3) + 1;
                    nextWeaponKey = `hidden_sword_${String(n).padStart(2,'0')}`;
                    user.money += 100; // 100ë¨¸ë‹ˆ ì§€ê¸‰
                    message = "ê°•í™” ì‹¤íŒ¨! (ê²€ íŒŒê´´) - íˆë“  ê²€ íšë“! (+100M)";
                    hiddenSwordBonus = true;
                } else {
                    nextWeaponType = 'normal';
                    const n = Math.floor(Math.random() * 30) + 1;
                    nextWeaponKey = `sword_${String(n).padStart(2,'0')}`;
                    message = "ê°•í™” ì‹¤íŒ¨! (ê²€ íŒŒê´´)";
                }
                // íŒŒê´´ ì‹œì—ë„ í”Œë˜ê·¸ ì´ˆê¸°í™”
                user.used_enhance_scroll = false;
                // ì½¤ë³´ ì´ˆê¸°í™”
                comboCount = 0;
                comboMultiplier = 1.0;
                updateComboCounter();
                break;
            default:
                // ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ëŠ” ìœ ì§€ë¡œ ì²˜ë¦¬
                message = "ê°•í™” ì‹¤íŒ¨!";
                // ì½¤ë³´ ì´ˆê¸°í™”
                comboCount = 0;
                comboMultiplier = 1.0;
                updateComboCounter();
                break;
        }
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        addToHistory(result);
        
        // Update user data
        // ì•ˆì „ì¥ì¹˜: newLevelì´ í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ë‚®ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€ (íŒŒê´´ ì œì™¸)
        if (result !== 'destroy' && newLevel < currentLevel) {
            console.warn('ë ˆë²¨ í•˜ë½ ë°©ì§€: newLevelì„ currentLevelë¡œ ì„¤ì •');
            newLevel = currentLevel;
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ë¨¼ì € ìˆ˜í–‰í•˜ê³  ì—ëŸ¬ ì²´í¬
        // ì•ˆì „ ê²€ì‚¬ ë° ë””ë²„ê·¸ ë¡œê¹… ì¶”ê°€: ì„œë²„ 400 ì‘ë‹µ ì›ì¸ì´ payload ë˜ëŠ” id ëˆ„ë½ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
        // ì•ˆì „í•œ íƒ€ì… ë³€í™˜: Supabase(PostgREST)ëŠ” íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ 400ì„ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        const safeGold = Number(user.gold);
        const safeMoney = Number(user.money);
        const safeLevel = Number(newLevel);

        if (!user || !user.id) {
            console.error('ì‚¬ìš©ì IDê°€ ì—†ì–´ ì—…ë°ì´íŠ¸ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.', user);
            alert('ì‚¬ìš©ì ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            isUpgrading = false;
            img.classList.remove('hammering');
            return;
        }

        if (!Number.isFinite(safeGold) || !Number.isFinite(safeMoney) || !Number.isFinite(safeLevel)) {
            console.error('ì—…ë°ì´íŠ¸í•  ìˆ«ì í•„ë“œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', { safeGold, safeMoney, safeLevel, user, newLevel });
            alert('ì„œë²„ì— ë³´ë‚¼ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
            isUpgrading = false;
            img.classList.remove('hammering');
            return;
        }

        // ì¼ë¶€ Supabase ìŠ¤í‚¤ë§ˆì—ì„œ `current_weapon_type` ë˜ëŠ” `current_weapon_key`ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ì„œë²„ì—ì„œ 400(PGRST204)ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë¨¼ì € ì¡´ì¬ê°€ í™•ì‹¤í•œ í•„ë“œë§Œ ì „ì†¡í•©ë‹ˆë‹¤.
        const updatePayload = {
            gold: Math.trunc(safeGold),
            money: Math.trunc(safeMoney),
            current_sword_lvl: Math.trunc(safeLevel)
        };

        // JSON ì§ë ¬í™”ë¡œ ì „ì†¡ ì „ ìœ íš¨í•œ JSONì¸ì§€ í™•ì¸
        try {
            console.log('profiles update payload (json):', JSON.stringify(updatePayload));
        } catch (e) {
            console.error('updatePayload ì§ë ¬í™” ì‹¤íŒ¨:', e, updatePayload);
        }
        console.log('profiles update user.id:', user && user.id);

        const { error } = await supabaseClient
            .from('profiles')
            .update(updatePayload)
            .eq('id', user.id);

        if (error) {
            console.error('ê°•í™” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            // ì¶”ê°€ ë””ë²„ê·¸: ì„œë²„ ì‘ë‹µì´ í¬í•¨ëœ ì „ì²´ ì—ëŸ¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            try { console.error('error.details or message:', error.details || error.message || error); } catch(e){}
            alert('ê°•í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì˜ ë„¤íŠ¸ì›Œí¬/ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            isUpgrading = false;
            img.classList.remove('hammering');
            return;
        }

        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í™•ì¸ì„ ìœ„í•œ ì¶”ê°€ ê²€ì¦
        console.log('ê°•í™” ê²°ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
            level: newLevel,
            weaponType: nextWeaponType,
            weaponKey: nextWeaponKey,
            gold: user.gold
        });

        setTimeout(() => {
            img.classList.remove('hammering');
            // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            user.current_sword_lvl = newLevel;
            user.current_weapon_type = nextWeaponType;
            user.current_weapon_key = nextWeaponKey;
            
            // ê°œì„ ëœ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
            playEnhanceAnimation(result);
            
            showEffect(result === 'success', message);
            updateUI();
            isUpgrading = false; // Reset upgrading flag after completion

            // If the sword was destroyed, run the hidden-sword check (1% chance)
            if (result === 'destroy') {
                try { setTimeout(() => checkForHiddenSword(), 300); } catch (e) { console.warn('checkForHiddenSword error:', e); }
            }
        }, 600);
    }

    async function handleStore() {
        if (isUpgrading) return alert("ê°•í™” ì¤‘ì—ëŠ” ë³´ê´€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const level = parseInt(user.current_sword_lvl || 0, 10);
        if (level <= 0) return alert("0ê°• ìƒíƒœëŠ” ë³´ê´€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const type = getWeaponType();
        const key = user.current_weapon_key || 'sword_01';
        
        // ê²€ ì´ë¦„ ë°ì´í„°ì—ì„œ sword_idì™€ ì‹¤ì œ ì´ë¦„ ì°¾ê¸°
        let swordId = null;
        let actualName = `${type === 'hidden' ? '[HIDDEN] ' : ''}${key}`;
        
        try {
            const swordData = await fetch('sword_names.json').then(r => r.json());
            const matchingSword = swordData.swords.find(s => 
                s.type === type && s.level === level
            );
            
            if (matchingSword) {
                swordId = matchingSword.id;
                actualName = matchingSword.name;
            } else {
                // ê¸°ë³¸ê°’ ì„¤ì •
                swordId = type === 'normal' ? (level + 1) : (841 + level);
            }
        } catch (e) {
            swordId = type === 'normal' ? (level + 1) : (841 + level);
        }

        try {
            // user_swords í…Œì´ë¸”ì— ê²€ ì €ì¥ (ìµœì†Œ í•„ë“œë§Œ ì‚¬ìš©)
            const payload = {
                user_id: user.id,
                sword_id: swordId,
                is_hidden: type === 'hidden'
            };

            const { data, error } = await supabaseClient
                .from('user_swords')
                .insert(payload)
                .select()
                .single();
            
            if (error) throw error;

            // update discoveries (max discovered level)
            const { data: existing } = await supabaseClient
                .from('user_weapon_discoveries')
                .select('max_discovered_level')
                .eq('user_id', user.id)
                .eq('weapon_type', type)
                .eq('weapon_key', key)
                .maybeSingle();

            const nextMax = Math.max(existing?.max_discovered_level || 0, level);
            if (!existing) {
                await supabaseClient.from('user_weapon_discoveries').insert({
                    user_id: user.id,
                    weapon_type: type,
                    weapon_key: key,
                    max_discovered_level: nextMax
                });
            } else if (nextMax > (existing.max_discovered_level || 0)) {
                await supabaseClient.from('user_weapon_discoveries')
                    .update({ max_discovered_level: nextMax })
                    .eq('user_id', user.id)
                    .eq('weapon_type', type)
                    .eq('weapon_key', key);
            }

            // reset current sword to 0 after storing
            const { error: resetErr } = await supabaseClient.from('profiles')
                .update({ current_sword_lvl: 0, current_weapon_type: 'normal', current_weapon_key: 'sword_01' })
                .eq('id', user.id);
            
            if (resetErr) throw resetErr;
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            user.current_sword_lvl = 0;
            user.current_weapon_type = 'normal';
            user.current_weapon_key = 'sword_01';
            updateUI();

            // Clear any temporary hidden flag so the hidden state won't persist
            try { sessionStorage.removeItem('hidden_temporary'); } catch (e) { /* ignore */ }
            alert('í˜„ì¬ ê²€ì„ ì¸ë²¤í† ë¦¬ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤.');
            
            // ë³´ê´€ í›„ íˆë“  ê²€ í™•ë¥  ì²´í¬
            setTimeout(() => checkForHiddenSword(), 500);
        } catch (e) {
            console.error('ë³´ê´€ ì˜¤ë¥˜:', e);
            alert('ë³´ê´€ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
        }
    }
    
    function getEnhancementRates(level) {
        // Format: { success: %, maintain: %, destroy: % } - ì „ì²´ì ìœ¼ë¡œ ë” ì–´ë µê²Œ ì¡°ì •
        const rates = [
            { success: 80, maintain: 20, destroy: 0 },   // 0 â†’ 1
            { success: 75, maintain: 25, destroy: 0 },   // 1 â†’ 2
            { success: 70, maintain: 30, destroy: 0 },   // 2 â†’ 3
            { success: 65, maintain: 35, destroy: 0 },   // 3 â†’ 4
            { success: 60, maintain: 38, destroy: 2 },   // 4 â†’ 5
            { success: 55, maintain: 40, destroy: 5 },   // 5 â†’ 6
            { success: 50, maintain: 40, destroy: 10 },  // 6 â†’ 7
            { success: 45, maintain: 40, destroy: 15 },  // 7 â†’ 8
            { success: 40, maintain: 40, destroy: 20 },  // 8 â†’ 9
            { success: 35, maintain: 40, destroy: 25 },  // 9 â†’ 10
            { success: 25, maintain: 35, destroy: 40 },  // 10 â†’ 11 (ë§¤ìš° ì–´ë ¤ì›€)
            { success: 20, maintain: 30, destroy: 50 },  // 11 â†’ 12
            { success: 17, maintain: 25, destroy: 58 },  // 12 â†’ 13
            { success: 15, maintain: 20, destroy: 65 },  // 13 â†’ 14
            { success: 12, maintain: 18, destroy: 70 },  // 14 â†’ 15
            { success: 10, maintain: 15, destroy: 75 },  // 15 â†’ 16
            { success: 8, maintain: 12, destroy: 80 },   // 16 â†’ 17
            { success: 5, maintain: 10, destroy: 85 },   // 17 â†’ 18
            { success: 3, maintain: 7, destroy: 90 },    // 18 â†’ 19
            { success: 1, maintain: 4, destroy: 95 }     // 19 â†’ 20 (ê±°ì˜ ë¶ˆê°€ëŠ¥)
        ];
        
        return rates[level] || { success: 0, maintain: 0, destroy: 0 };
    }
    
    function determineEnhancementResult(rates) {
        const rand = Math.random() * 100;
        let cumulative = 0;
        
        // ëª…ì‹œì ìœ¼ë¡œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ ë°©ì§€
        cumulative += rates.success;
        if (rand < cumulative) {
            return 'success';
        }
        
        cumulative += rates.maintain;
        if (rand < cumulative) {
            return 'maintain';
        }
        
        cumulative += rates.destroy;
        if (rand < cumulative) {
            return 'destroy';
        }
        
        // ê¸°ë³¸ê°’ì€ ìœ ì§€ (í•˜ë½ ì—†ìŒ)
        return 'maintain';
    }

    async function handleSell() {
        if (isUpgrading) return alert("ê°•í™” ì¤‘ì—ëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        const currentLevel = user.current_sword_lvl;
        if (currentLevel === 0) return alert("0ê°• ìƒíƒœëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        let sellPrice = getSellPrice(currentLevel);
        
        // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© ì‹œ íŒë§¤ê°€ 50% ê°ì†Œ (ë¡œì»¬ ì¶”ì )
        const usedEnhanceScroll = user.used_enhance_scroll || false;
        if (usedEnhanceScroll) {
            sellPrice = Math.floor(sellPrice * 0.5);
        }
        
        const penaltyMsg = usedEnhanceScroll ? '\nâ€» í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ íŒë§¤ê°€ 50% ê°ì†Œ ì ìš©ë¨' : '';
        if (!confirm(`${sellPrice.toLocaleString()}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${penaltyMsg}`)) return;

        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ë¨¼ì € ìˆ˜í–‰
        const newGold = user.gold + sellPrice;
        const { error } = await supabaseClient.from('profiles')
            .update({ 
                gold: newGold, 
                current_sword_lvl: 0
            })
            .eq('id', user.id);
        
        if (error) {
            console.error('íŒë§¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            alert('íŒë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            return;
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í™•ì¸ì„ ìœ„í•œ ë¡œê·¸
        console.log('íŒë§¤ ì™„ë£Œ - ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸:', {
            newGold: newGold,
            resetLevel: 0,
            userId: user.id
        });
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        user.gold = newGold;
        user.current_sword_lvl = 0;
        user.used_enhance_scroll = false;
        // íŒë§¤ ì‹œ ì½¤ë³´ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
        try { comboCount = 0; comboMultiplier = 1.0; updateComboCounter(); } catch (e) { console.warn('combo reset failed', e); }
        
        // íŒë§¤ í›„ íˆë“  ê²€ í™•ë¥  ì²´í¬
        checkForHiddenSword();
        
        updateUI();
        alert(`${sellPrice.toLocaleString()}Gì— íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
        // íŒë§¤ í›„ íˆë“  ê²€ í™•ë¥  ì²´í¬
        setTimeout(() => checkForHiddenSword(), 500);
    }

    function showEffect(win, message) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = win ? 'rgba(72, 187, 120, 0.9)' : 'rgba(245, 101, 101, 0.9)';
        el.innerText = message || (win ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨!");
        setTimeout(() => el.style.display = 'none', 1000);
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    async function loadAllUsers() {
        const { data } = await supabaseClient.from('profiles').select('id, username, gold, current_sword_lvl, email');
        allUsers = data || [];
    }

    function showAdminPanel() {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        let content = `
            <div style="background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
                <div style="margin-bottom: 20px;">
                    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                        ${allUsers.map(u => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${u.username || u.email}</strong>
                                <div>ê³¨ë“œ: <input type="number" id="gold-${u.id}" value="${u.gold || 0}" style="width: 80px;"></div>
                                <div>ë¨¸ë‹ˆ: <input type="number" id="money-${u.id}" value="${u.money || 0}" style="width: 80px;"></div>
                                <div>ë ˆë²¨: <input type="number" id="level-${u.id}" value="${u.current_sword_lvl}" min="1" max="20" style="width: 60px;"></div>
                                <button onclick="updateUser('${u.id}')" style="margin-top: 5px; padding: 2px 8px; font-size: 12px;">ìˆ˜ì •</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="this.parentNode.parentNode.remove()" style="padding: 8px 20px; background: #2d3748; color: white; border: none; border-radius: 5px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
        `;
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Add the updateUser function to the window object
        window.updateUser = async (userId) => {
            const gold = parseInt(document.getElementById(`gold-${userId}`).value) || 0;
            const money = parseInt(document.getElementById(`money-${userId}`).value) || 0;
            let level = parseInt(document.getElementById(`level-${userId}`).value) || 1;
            
            // Enforce max level of 20
            level = Math.min(level, 20);
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ gold, money, current_sword_lvl: level })
                    .eq('id', userId);
                
                if (error) throw error;
                alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadAllUsers();
                modal.remove();
                showAdminPanel(); // Refresh the panel
            } catch (e) {
                alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        };
    }

    async function redeem() {
        const code = prompt("ì½”ë“œ ì…ë ¥");
        if (!code) return;
        
        try {
            const { data, error } = await supabaseClient
                .from('reward_codes')
                .select('*')
                .eq('code', code)
                .single();
                
            if (error || !data) {
                return alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.");
            }
            
            user.gold += data.reward_gold;
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ gold: user.gold })
                .eq('id', user.id);
                
            if (updateError) throw updateError;
            
            showGoldEffect(data.reward_gold, true);
            updateUI();
            alert(`ì„±ê³µì ìœ¼ë¡œ ${data.reward_gold.toLocaleString()}Gë¥¼ ì§€ê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤!`);
            
            // ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
            await supabaseClient
                .from('reward_codes')
                .delete()
                .eq('code', code);
                
        } catch (e) {
            console.error('Error redeeming code:', e);
            alert('ì½”ë“œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    init();

    // ë¯¸ì…˜/ì—…ì  ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
    async function incrementUserMissionByKey(key, amount = 1) {
        try {
            let mission = null;
            try {
                const { data: m } = await supabaseClient.from('missions').select('*').eq('key', key).maybeSingle();
                mission = m;
            } catch (e) {
                const { data: m2 } = await supabaseClient.from('missions').select('*').ilike('title', `%${key}%`).limit(1);
                mission = (m2 && m2[0]) || null;
            }
            if (!mission) {
                console.log('incrementUserMissionByKey: mission not found for', key);
                return;
            }

            const { data: existing } = await supabaseClient.from('user_missions').select('*').eq('user_id', user.id).eq('mission_id', mission.id).maybeSingle();
            const prevProg = existing?.progress || 0;
            const newProg = prevProg + amount;
            const completed = newProg >= Number(mission.target || 1);

            if (existing) {
                await supabaseClient.from('user_missions').update({ progress: newProg, completed }).eq('id', existing.id);
            } else {
                await supabaseClient.from('user_missions').insert({ user_id: user.id, mission_id: mission.id, progress: newProg, completed, claimed: false });
            }
            console.log('Mission progress updated', { key, missionId: mission.id, newProg, completed });
        } catch (e) {
            console.warn('incrementUserMissionByKey failed:', e?.message || e);
        }
    }

    async function incrementUserAchievementByKey(key, amount = 1) {
        try {
            let ach = null;
            try {
                const { data: a } = await supabaseClient.from('achievements').select('*').eq('key', key).maybeSingle();
                ach = a;
            } catch (e) {
                const { data: a2 } = await supabaseClient.from('achievements').select('*').ilike('title', `%${key}%`).limit(1);
                ach = (a2 && a2[0]) || null;
            }
            if (!ach) {
                console.log('incrementUserAchievementByKey: achievement not found for', key);
                return;
            }

            const { data: existing } = await supabaseClient.from('user_achievements').select('*').eq('user_id', user.id).eq('achievement_id', ach.id).maybeSingle();
            const prevProg = existing?.progress || 0;
            const newProg = prevProg + amount;
            const unlocked = newProg >= Number(ach.target || 1);
            const completed = unlocked;

            if (existing) {
                await supabaseClient.from('user_achievements').update({ progress: newProg, unlocked, completed }).eq('id', existing.id);
            } else {
                await supabaseClient.from('user_achievements').insert({ user_id: user.id, achievement_id: ach.id, progress: newProg, unlocked, completed });
            }
            console.log('Achievement progress updated', { key, achievementId: ach.id, newProg, unlocked });
        } catch (e) {
            console.warn('incrementUserAchievementByKey failed:', e?.message || e);
        }
    }

    // ê°•í™” íˆìŠ¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function addToHistory(result) {
        enhanceHistory.unshift(result); // ë§¨ ì•ì— ì¶”ê°€
        if (enhanceHistory.length > 10) {
            enhanceHistory.pop(); // 10ê°œ ì´ˆê³¼ ì‹œ ì œê±°
        }
        renderHistory();
    }

    function renderHistory() {
        const historyEl = document.getElementById('enhanceHistory');
        if (!historyEl) return;
        
        historyEl.innerHTML = enhanceHistory.map(result => {
            let className = 'history-item ';
            let icon = '';
            
            if (result === 'success') {
                className += 'history-success';
                icon = 'âœ“';
            } else if (result === 'destroy') {
                className += 'history-destroy';
                icon = 'âœ—';
            } else {
                className += 'history-fail';
                icon = 'âˆ’';
            }
            
            return `<div class="${className}">${icon}</div>`;
        }).join('');
    }
    
    // ì½¤ë³´ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
    function showComboEffect(combo) {
        const comboEl = document.createElement('div');
        comboEl.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
            animation: comboAnim 1s ease-out;
            z-index: 1000;
            pointer-events: none;
        `;
        comboEl.textContent = `ğŸ”¥ ${combo} COMBO! ğŸ”¥`;
        document.body.appendChild(comboEl);
        
        setTimeout(() => comboEl.remove(), 1000);
    }
    
    function updateComboCounter() {
        const counterEl = document.getElementById('comboCounter');
        if (!counterEl) return;
        
        if (comboCount >= 2) {
            counterEl.style.display = 'block';
            counterEl.textContent = `ğŸ”¥ ${comboCount} COMBO`;
        } else {
            counterEl.style.display = 'none';
        }
    }
    
    // ì´ë²¤íŠ¸ íƒ€ì„ ì‹œìŠ¤í…œ
    function isEventTime() {
        const now = new Date();
        const hour = now.getHours();
        
        // ì´ë²¤íŠ¸ ì‹œê°„: 12ì‹œ~13ì‹œ, 20ì‹œ~21ì‹œ
        return (hour >= 12 && hour < 13) || (hour >= 20 && hour < 21);
    }
    
    function getEventMultiplier() {
        return isEventTime() ? 2.0 : 1.0;
    }
    
    function checkEventTime() {
        const banner = document.getElementById('eventBanner');
        if (!banner) return;
        
        if (isEventTime()) {
            banner.style.display = 'block';
            banner.textContent = 'âš¡ ì´ë²¤íŠ¸ íƒ€ì„! ì„±ê³µë¥  2ë°°! âš¡';
        } else {
            banner.style.display = 'none';
        }
        
        // 1ë¶„ë§ˆë‹¤ ì²´í¬
        setTimeout(checkEventTime, 60000);
    }
    
    // ê°œì„ ëœ ì• ë‹ˆë©”ì´ì…˜
    function playEnhanceAnimation(result) {
        const img = document.getElementById('s-img');
        if (!img) return;
        
        // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        img.className = 'sword-img';
        
        // ìƒˆ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€: ë” ê°•í•œ íŒŒí‹°í´ê³¼ í™”ë©´ í”ë“¤ë¦¼
        setTimeout(() => {
            if (result === 'success') {
                img.classList.add('success-effect');
                document.body.animate([{ transform: 'translateY(0)' }, { transform: 'translateY(-6px)' }, { transform: 'translateY(0)' }], { duration: 350, easing: 'cubic-bezier(.2,.8,.2,1)' });
                createParticles('success', 60);
            } else if (result === 'destroy') {
                img.classList.add('destroy-effect');
                // stronger screen shake
                document.body.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-8px)' }, { transform: 'translateX(8px)' }, { transform: 'translateX(0)' }], { duration: 700, iterations: 1 });
                createParticles('destroy', 90);
            } else {
                img.classList.add('fail-effect');
                createParticles('fail', 30);
            }
        }, 10);
    }
    
    function createParticles(type) {
        const successColors = ['#ffd66b', '#ff8a00', '#ffd700', '#fff59d'];
        const greenColors = ['#48bb78', '#38a169', '#2f855a'];
        const redColors = ['#f56565', '#e53e3e', '#c53030', '#ff7b7b'];

        const colors = type === 'success' ? successColors.concat(greenColors) : (type === 'destroy' ? redColors.concat(['#ff6b00']) : redColors);
        const count = arguments[1] || 30;

        for (let i = 0; i < count; i++) {
            const size = 6 + Math.floor(Math.random() * 12);
            const particle = document.createElement('div');
            particle.style.cssText = `
                position: fixed;
                width: ${size}px;
                height: ${size}px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                border-radius: ${Math.random() > 0.5 ? '50%' : '8px'};
                pointer-events: none;
                z-index: 10000;
                left: calc(50% + ${Math.floor((Math.random() - 0.5) * 120)}px);
                top: calc(50% + ${Math.floor((Math.random() - 0.5) * 80)}px);
                opacity: 1;
            `;
            document.body.appendChild(particle);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 80 + Math.random() * 240;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity - 20;

            const dur = 800 + Math.floor(Math.random() * 900);
            particle.animate([
                { transform: 'translate(0,0) scale(1)', opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0.4) rotate(${Math.random()*720-360}deg)`, opacity: 0 }
            ], {
                duration: dur,
                easing: 'cubic-bezier(.2,.8,.2,1)'
            }).onfinish = () => particle.remove();
        }
    }

    // íˆë“  ê²€ í™•ë¥  ì²´í¬ í•¨ìˆ˜
    async function checkForHiddenSword() {
        // ì´ë¯¸ ê²€ì´ ìˆìœ¼ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
        if (user.current_sword_lvl > 0) return;
        
        // 1% í™•ë¥ ë¡œ íˆë“  ê²€ íšë“
        if (Math.random() < 0.01) {
            const n = Math.floor(Math.random() * 3) + 1;
            const hiddenKey = `hidden_sword_${String(n).padStart(2,'0')}`;
            
            // 100ë¨¸ë‹ˆ ì§€ê¸‰
            user.money += 100;
            
            // íˆë“  ê²€ìœ¼ë¡œ ì„¤ì •
            user.current_weapon_type = 'hidden';
            user.current_weapon_key = hiddenKey;
            user.current_sword_lvl = 0;
            
            // íˆë“ ê²€ ì˜ì†ì„±: user_swords í…Œì´ë¸”ì— ì €ì¥
            try {
                // sword_names.jsonì—ì„œ íˆë“ ê²€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('sword_names.json');
                const swordData = await response.json();
                const hiddenSword = swordData.swords.find(s => s.type === 'hidden' && s.level === 0);
                const swordId = hiddenSword ? hiddenSword.id : `hidden_${n}`;
                
                // user_swords í…Œì´ë¸”ì— íˆë“ ê²€ ì €ì¥
                const { error: swordError } = await supabaseClient
                    .from('user_swords')
                    .insert({
                        user_id: user.id,
                        sword_id: swordId,
                        level: 0,
                        is_hidden: true,
                        hidden_expires_at: null, // ì˜êµ¬ ë³´ê´€
                        obtained_at: new Date().toISOString()
                    });
                
                if (swordError) {
                    console.warn('íˆë“ ê²€ ì €ì¥ ì‹¤íŒ¨:', swordError);
                }
            } catch (e) {
                console.warn('íˆë“ ê²€ ì˜ì†ì„± ì €ì¥ ì˜¤ë¥˜:', e);
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
            const { error } = await supabaseClient.from('profiles')
                .update({
                    money: user.money,
                    current_weapon_type: 'hidden',
                    current_weapon_key: hiddenKey,
                    current_sword_lvl: 0
                })
                .eq('id', user.id);
            
            if (!error) {
                // Mark as temporary so it can be cleared after next normal action
                try { sessionStorage.setItem('hidden_temporary', '1'); } catch (e) { /* ignore */ }
                updateUI();
                setTimeout(() => {
                    alert('ğŸŒŸ íˆë“  ê²€ì„ íšë“í–ˆìŠµë‹ˆë‹¤! ğŸŒŸ\n+100M ì§€ê¸‰!\n\níˆë“  ê²€ì€ ë¨¸ë‹ˆë¡œ ê°•í™”í•  ìˆ˜ ìˆìœ¼ë©°, ë„ê°ì— ì˜êµ¬ ì €ì¥ë©ë‹ˆë‹¤.');
                }, 100);
            }
        }
    }

    // ë§¤í¬ë¡œ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
    function startMacro() {
        if (!hasMacro) {
            alert('ë§¤í¬ë¡œë¥¼ ë¨¼ì € êµ¬ë§¤í•´ì£¼ì„¸ìš”!\nìƒì ì—ì„œ ìë™ ê°•í™” ë§¤í¬ë¡œë¥¼ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (macroActive) {
            alert('ë§¤í¬ë¡œê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }
        
        const targetLevel = parseInt(document.getElementById('targetLevel').value);
        
        // ì…ë ¥ ê°’ ê²€ì¦
        if (isNaN(targetLevel) || targetLevel < 1 || targetLevel > 20) {
            alert('ëª©í‘œ ë ˆë²¨ì€ 1~20 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
            document.getElementById('targetLevel').value = Math.max(1, Math.min(20, user.current_sword_lvl + 1));
            return;
        }
        
        if (targetLevel <= user.current_sword_lvl) {
            alert(`ëª©í‘œ ë ˆë²¨ì€ í˜„ì¬ ë ˆë²¨(${user.current_sword_lvl}ê°•)ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`);
            document.getElementById('targetLevel').value = Math.min(20, user.current_sword_lvl + 1);
            return;
        }
        
        // ë¹„ìš© ì‚¬ì „ ì²´í¬
        const isHidden = user.current_weapon_type === 'hidden';
        const upgradeCost = getEnhancementCost(user.current_sword_lvl);
        const costInMoney = Math.ceil(upgradeCost / 1000);
        
        if (isHidden && user.money < costInMoney) {
            alert(`ë§¤í¬ë¡œ ì‹œì‘ ë¶ˆê°€: ë¨¸ë‹ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${costInMoney}M, ë³´ìœ : ${user.money}M`);
            return;
        } else if (!isHidden && user.gold < upgradeCost) {
            alert(`ë§¤í¬ë¡œ ì‹œì‘ ë¶ˆê°€: ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${upgradeCost.toLocaleString()}G, ë³´ìœ : ${user.gold.toLocaleString()}G`);
            return;
        }
        
        macroActive = true;
        macroTargetLevel = targetLevel;
        macroLog = [];
        
        document.getElementById('startMacroBtn').disabled = true;
        document.getElementById('stopMacroBtn').disabled = false;
        
        addMacroLog(`ë§¤í¬ë¡œ ì‹œì‘: ëª©í‘œ ë ˆë²¨ ${targetLevel}ê°• (í˜„ì¬: ${user.current_sword_lvl}ê°•)`);
        
        // ë§¤í¬ë¡œ ì‹¤í–‰
        runMacroStep();
    }
    
    function stopMacro() {
        if (!macroActive) return;
        
        macroActive = false;
        if (macroInterval) {
            clearTimeout(macroInterval);
            macroInterval = null;
        }
        
        document.getElementById('startMacroBtn').disabled = false;
        document.getElementById('stopMacroBtn').disabled = true;
        
        addMacroLog('ë§¤í¬ë¡œ ì¤‘ì§€ë¨');
    }
    
    async function runMacroStep() {
        if (!macroActive || user.current_sword_lvl >= macroTargetLevel) {
            if (user.current_sword_lvl >= macroTargetLevel) {
                addMacroLog(`ëª©í‘œ ë‹¬ì„±! ${macroTargetLevel}ê°• ì™„ë£Œ`);
            }
            stopMacro();
            return;
        }
        
        // íˆë“  ê²€ ì²´í¬ (ë¨¸ë‹ˆ ì‚¬ìš©)
        const isHidden = user.current_weapon_type === 'hidden';
        const upgradeCost = getEnhancementCost(user.current_sword_lvl);
        const costInMoney = Math.ceil(upgradeCost / 1000); // 1000G = 1M
        
        // ë¹„ìš© ì²´í¬
        if (isHidden) {
            if (user.money < costInMoney) {
                addMacroLog(`ë¨¸ë‹ˆ ë¶€ì¡±ìœ¼ë¡œ ë§¤í¬ë¡œ ì¤‘ì§€ (í•„ìš”: ${costInMoney}M, ë³´ìœ : ${user.money}M)`);
                stopMacro();
                return;
            }
        } else {
            if (user.gold < upgradeCost) {
                addMacroLog(`ê³¨ë“œ ë¶€ì¡±ìœ¼ë¡œ ë§¤í¬ë¡œ ì¤‘ì§€ (í•„ìš”: ${upgradeCost.toLocaleString()}G, ë³´ìœ : ${user.gold.toLocaleString()}G)`);
                stopMacro();
                return;
            }
        }
        
        // ê°•í™” ì‹œë„
        try {
            await performMacroUpgrade();
            
            // ë‹¤ìŒ ë‹¨ê³„ ì‹¤í–‰ (1ì´ˆ í›„)
            macroInterval = setTimeout(() => {
                if (macroActive) {
                    runMacroStep();
                }
            }, 1000);
            
        } catch (error) {
            addMacroLog(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            stopMacro();
        }
    }
    
    async function performMacroUpgrade() {
        const currentLevel = user.current_sword_lvl;
        const rates = getEnhancementRates(currentLevel);
        const isHidden = user.current_weapon_type === 'hidden';
        const upgradeCost = getEnhancementCost(currentLevel);
        const costInMoney = Math.ceil(upgradeCost / 1000);
        
        // ë¹„ìš© ì°¨ê°
        if (isHidden) {
            user.money -= costInMoney;
        } else {
            user.gold -= upgradeCost;
        }
        
        // ê°•í™” ê²°ê³¼ ê²°ì •
        const result = determineEnhancementResult(rates);
        let newLevel = currentLevel;
        let message = "";
        let nextWeaponType = user.current_weapon_type;
        let nextWeaponKey = user.current_weapon_key || 'sword_01';
        
        switch(result) {
            case 'success':
                newLevel = currentLevel + 1;
                message = `ê°•í™” ì„±ê³µ! [${currentLevel}ê°• â†’ ${newLevel}ê°•]`;
                addMacroLog(message, 'success');
                break;
            case 'maintain':
                message = `ê°•í™” ì‹¤íŒ¨ [${currentLevel}ê°• ìœ ì§€]`;
                addMacroLog(message, 'fail');
                break;
            case 'destroy':
                newLevel = 0;
                // íˆë“  ê²€ í™•ë¥  ì²´í¬ (1%)
                if (Math.random() < 0.01) {
                    nextWeaponType = 'hidden';
                    nextWeaponKey = `hidden_sword_${String(Math.floor(Math.random() * 3) + 1).padStart(2,'0')}`;
                    user.money += 100; // 100ë¨¸ë‹ˆ ì§€ê¸‰
                    message = `ê²€ íŒŒê´´! íˆë“  ê²€ íšë“! [0ê°•] (+100M ì§€ê¸‰)`;
                    addMacroLog(message, 'destroy');
                } else {
                    nextWeaponType = 'normal';
                    const n = Math.floor(Math.random() * 30) + 1;
                    nextWeaponKey = `sword_${String(n).padStart(2,'0')}`;
                    message = `ê²€ íŒŒê´´! [0ê°•]`;
                    addMacroLog(message, 'destroy');
                }
                break;
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
        const updateData = {
            gold: user.gold,
            money: user.money,
            current_sword_lvl: newLevel,
            current_weapon_type: nextWeaponType,
            current_weapon_key: nextWeaponKey
        };
        
        const { error } = await supabaseClient
            .from('profiles')
            .update(updateData)
            .eq('id', user.id);
        
        if (error) {
            throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
        // ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        user.current_sword_lvl = newLevel;
        user.current_weapon_type = nextWeaponType;
        user.current_weapon_key = nextWeaponKey;
        
        // UI ì—…ë°ì´íŠ¸
        updateUI();
    }
    
    function addMacroLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
            time: timestamp,
            message: message,
            type: type
        };
        
        macroLog.push(logEntry);
        
        // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±° (ìµœëŒ€ 100ê°œ)
        if (macroLog.length > 100) {
            macroLog.shift();
        }
        
        updateMacroLogDisplay();
    }
    
    function updateMacroLogDisplay() {
        const logContent = document.getElementById('macroLog');
        if (!logContent) return;
        
        logContent.innerHTML = macroLog.map(entry => {
            let className = 'log-entry';
            if (entry.type === 'success') className += ' log-success';
            else if (entry.type === 'fail') className += ' log-fail';
            else if (entry.type === 'destroy') className += ' log-destroy';
            
            return `<div class="${className}">[${entry.time}] ${entry.message}</div>`;
        }).reverse().join('');
        
        logContent.scrollTop = 0;
    }
    
    function showMacroLog() {
        if (macroLog.length === 0) {
            alert('ì•„ì§ ë§¤í¬ë¡œ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const logText = macroLog.map(entry => `[${entry.time}] ${entry.message}`).reverse().join('\n');
        alert('ë§¤í¬ë¡œ ë¡œê·¸:\n\n' + logText);
    }

    document.addEventListener('visibilitychange', async function() {
        if (!document.hidden && user) {
            console.log('ê²€ í˜ì´ì§€ê°€ ë‹¤ì‹œ í™œì„±í™”ë¨ - ë°ì´í„° ë™ê¸°í™” ì‹œì‘');
            try {
                const { data: freshData } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (freshData) {
                    // ì¤‘ìš”í•œ ë°ì´í„°ë§Œ ë™ê¸°í™” (ê°•í™” ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
                    if (!isUpgrading) {
                        user.gold = freshData.gold;
                        user.money = freshData.money;
                        user.current_sword_lvl = freshData.current_sword_lvl;
                        user.current_weapon_type = freshData.current_weapon_type;
                        user.current_weapon_key = freshData.current_weapon_key;
                        // Note: used_enhance_scroll is tracked locally only
                        updateUI();
                        console.log('ê²€ í˜ì´ì§€ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ:', {
                            level: freshData.current_sword_lvl,
                            gold: freshData.gold,
                            weaponType: freshData.current_weapon_type
                        });
                    }
                }
            } catch (e) {
                console.error('ê²€ í˜ì´ì§€ ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜:', e);
            }
        }
    });

    // Keyboard shortcuts for desktop users
    // U = Upgrade, S = Sell, I = Store
    document.addEventListener('keydown', function (e) {
        try {
            // Ignore when user is typing in inputs, textareas, or contenteditable
            const active = document.activeElement;
            const tag = active && active.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || (active && active.isContentEditable)) return;
            // Ignore when modifier keys are pressed to avoid conflicts
            if (e.ctrlKey || e.altKey || e.metaKey) return;

            const key = (e.key || '').toLowerCase();
            if (key === 'u') {
                e.preventDefault();
                if (typeof handleUpgrade === 'function') handleUpgrade();
            } else if (key === 's') {
                e.preventDefault();
                if (typeof handleSell === 'function') handleSell();
            } else if (key === 'i') {
                e.preventDefault();
                if (typeof handleStore === 'function') handleStore();
            }
        } catch (err) {
            console.error('ë‹¨ì¶•í‚¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', err);
        }
    });
</script>
</body>
</html>