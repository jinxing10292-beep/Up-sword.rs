
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Pretendard í°íŠ¸ ë° ê¸°ë³¸ í…Œë§ˆ ì„¤ì • */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* ì»¨í…Œì´ë„ˆ ë””ìì¸ */
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #1a202c; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ê²€ ì´ë¯¸ì§€ ì˜ì—­ */
        .img-area { background: #edf2f7; height: 260px; margin: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); transition: transform 0.1s; }
        
        /* ê°•í™” ì •ë³´ ì˜ì—­ */
        .info-area { padding: 0 24px 24px; text-align: center; }
        #s-name { font-size: 24px; font-weight: 800; color: #2d3748; }
        #s-desc { font-size: 14px; color: #718096; margin: 8px 0 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #f8fafc; padding: 12px; border-radius: 16px; font-size: 13px; font-weight: 600; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-group { padding: 0 20px 24px; display: flex; gap: 12px; }
        .btn-main { flex: 2; padding: 18px; border-radius: 16px; border: none; background: #2d3748; color: white; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #1a202c; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #1a202c; }
        .btn-sub { flex: 1; padding: 18px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; color: #4a5568; font-weight: 700; cursor: pointer; }
        .btn-items { padding: 12px; border-radius: 12px; border: 2px solid #9f7aea; background: #faf5ff; color: #553c9a; font-weight: 700; cursor: pointer; margin-bottom: 12px; }
        .btn-items:hover { background: #f3e8ff; }
    .gold-wrap { display: flex; align-items: center; gap: 10px; }
    .code-btn { padding: 5px 12px; border-radius: 12px; border: none; font-weight: bold; background: #f1f2f6; cursor: pointer; }
    .money-float { position: absolute; animation: floatUp 1s forwards; font-weight: bold; font-size: 14px; pointer-events: none; }
    @keyframes floatUp { to { transform: translateY(-30px); opacity: 0; } }

        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .hammering { animation: shake 0.15s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 50% { transform: rotate(3deg); } 100% { transform: rotate(0); } }
        #full-effect { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: 900; pointer-events: none; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 50px;">ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <div class="left-group">
            <button onclick="location.href='index.html'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" title="í™ˆìœ¼ë¡œ">
                <i class="fa-solid fa-house"></i>
            </button>
            <span id="u-nick" style="font-size: 14px;">...</span>
        </div>
        <div class="gold-wrap" id="gold-anchor">
            <span id="u-gold" style="color:#f1c40f; font-weight: bold; margin-right: 10px;">0G</span>
            <span id="u-money" style="color:#9b59b6; font-weight: bold;">0M</span>
            <button class="code-btn" onclick="redeem()">ì½”ë“œ</button>
            <button id="adminBtn" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; display:none; margin-left: 10px;">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </div>

    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>

    <div class="info-area">
        <div id="s-name">ê²€ ì •ë³´</div>
        <div id="s-desc">ê²€ ì„¤ëª…</div>
        <div class="stats-grid">
            <div><i class="fa-solid fa-hammer"></i> <span id="stat-cost">0</span>G</div>
            <div><i class="fa-solid fa-sack-dollar"></i> <span id="stat-sell">0</span>G</div>
            <div><i class="fa-solid fa-percent"></i> <span id="stat-rate">0</span>%</div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-items" onclick="location.href='items.html'">ğŸ“¦ ì•„ì´í…œ ì‚¬ìš©</button>
    </div>
    
    <div class="btn-group">
        <button class="btn-sub" onclick="handleSell()">íŒë§¤</button>
        <button class="btn-sub" onclick="handleStore()">ë³´ê´€í•˜ê¸°</button>
        <button class="btn-main" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let swords = {};
    let isAdmin = false;
    let allUsers = [];
    let isUpgrading = false; // Flag to track if an upgrade is in progress
    const variantNameCache = new Map(); // key: `${weapon_key}:${level}` => name

    async function getVariantName(weaponKey, level) {
        const cl = Math.max(0, Math.min(19, parseInt(level || 0, 10)));
        const cacheKey = `${weaponKey}:${cl}`;
        if (variantNameCache.has(cacheKey)) return variantNameCache.get(cacheKey);
        try {
            const { data } = await supabaseClient
                .from('weapon_variants')
                .select('name_ko')
                .eq('weapon_key', weaponKey)
                .eq('level', cl)
                .maybeSingle();
            const name = data?.name_ko || `${weaponKey} +${cl}`;
            variantNameCache.set(cacheKey, name);
            return name;
        } catch (_) {
            return `${weaponKey} +${cl}`;
        }
    }

    function getWeaponType() {
        return (user && user.current_weapon_type) ? user.current_weapon_type : 'normal';
    }

    function getWeaponName(type, level) {
        const arr = WEAPON_NAMES[type] || WEAPON_NAMES.normal;
        const idx = Math.max(0, Math.min(20, parseInt(level || 0, 10)));
        return arr[idx] || arr[0];
    }

    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }

            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;

            if (user.current_sword_lvl === null || user.current_sword_lvl === undefined) {
                user.current_sword_lvl = 0;
            }

            if (!user.current_weapon_type) {
                user.current_weapon_type = 'normal';
                await supabaseClient.from('profiles').update({ current_weapon_type: 'normal' }).eq('id', user.id);
            }

            if (!user.current_weapon_key) {
                user.current_weapon_key = 'normal_01';
                await supabaseClient.from('profiles').update({ current_weapon_key: 'normal_01' }).eq('id', user.id);
            }

            const { data: sData } = await supabaseClient.from('sword_data').select('*').order('level');
            sData.forEach(d => swords[d.level] = d);

            // Check if user is admin
            isAdmin = user.email === 'admin@example.com'; // ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë³€ê²½ í•„ìš”
            if (isAdmin) {
                document.getElementById('adminBtn').style.display = 'block';
                document.getElementById('adminBtn').addEventListener('click', showAdminPanel);
                await loadAllUsers();
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
            
            // ì•„ì´í…œ ì‚¬ìš© í™•ì¸
            checkForItemUsage();
        } catch (e) { alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }

    function getSellPrice(level) {
        // ìƒˆë¡œìš´ íŒë§¤ê°€ ê³µì‹: (ê°•í™”ë¹„ìš© + ê¸°ì¡´íŒë§¤ë¹„ìš©) Ã— ê°•í™”í™•ë¥ ì—­ìˆ˜ Ã— 0.6 (40% ê°ì†Œ)
        const enhanceCost = getEnhancementCost(level);
        const successRate = getSuccessRate(level);
        
        let basePrice;
        if (level === 20) {
            basePrice = 10000000; // 20ë ˆë²¨ ê³ ì •ê°€
        } else {
            const cube = level * level * level;
            if (level >= 15) {
                basePrice = cube * 200;
            } else if (level >= 10) {
                basePrice = cube * 100;
            } else {
                basePrice = cube * 50;
            }
        }
        
        // ìƒˆë¡œìš´ ê³µì‹: (ê°•í™”ë¹„ìš© + ê¸°ì¡´íŒë§¤ê°€) Ã— ì„±ê³µí™•ë¥ ì—­ìˆ˜ Ã— 0.6 (40% í• ì¸)
        const probabilityMultiplier = successRate > 0 ? (100 / successRate) : 1;
        const newPrice = Math.floor((enhanceCost + basePrice) * probabilityMultiplier * 0.6);
        
        return newPrice;
    }

    // ì•„ì´í…œ ì‚¬ìš© ê´€ë ¨ í•¨ìˆ˜ë“¤
    function checkForItemUsage() {
        const useItemId = sessionStorage.getItem('useItemId');
        const userItemId = sessionStorage.getItem('userItemId');
        
        if (useItemId && userItemId) {
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
            sessionStorage.removeItem('useItemId');
            sessionStorage.removeItem('userItemId');
            
            // ì•„ì´í…œ ì‚¬ìš© í™•ì¸
            showItemUsageConfirm(useItemId, userItemId);
        }
    }
    
    function showItemUsageConfirm(itemId, userItemId) {
        const itemNames = {
            'enhance_scroll_1': 'í™•ì • ê°•í™”ê¶Œ (1~5ê°•)',
            'enhance_scroll_2': 'í™•ì • ê°•í™”ê¶Œ (6~10ê°•)',
            'enhance_scroll_3': 'í™•ì • ê°•í™”ê¶Œ (11~15ê°•)',
            'enhance_scroll_4': 'í™•ì • ê°•í™”ê¶Œ (16~20ê°•)',
            'protect_scroll_1': 'íŒŒê´´ ë°©ì§€ê¶Œ (1~10ê°•)',
            'protect_scroll_2': 'íŒŒê´´ ë°©ì§€ê¶Œ (11~15ê°•)',
            'protect_scroll_3': 'íŒŒê´´ ë°©ì§€ê¶Œ (16~20ê°•)',
            'maintain_scroll_1': 'ë ˆë²¨ ìœ ì§€ê¶Œ (11~15ê°•)',
            'maintain_scroll_2': 'ë ˆë²¨ ìœ ì§€ê¶Œ (16~20ê°•)'
        };
        
        const itemName = itemNames[itemId] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ';
        const currentLevel = user.current_sword_lvl;
        
        // ì•„ì´í…œ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        const canUse = checkItemUsability(itemId, currentLevel);
        
        if (!canUse.usable) {
            alert(`ì´ ì•„ì´í…œì€ í˜„ì¬ ë ˆë²¨(${currentLevel}ê°•)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n${canUse.reason}`);
            return;
        }
        
        if (confirm(`${itemName}ì„(ë¥¼) ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ê²€ ë ˆë²¨: ${currentLevel}ê°•`)) {
            useItemForEnhancement(itemId, userItemId);
        }
    }
    
    function checkItemUsability(itemId, currentLevel) {
        const itemRanges = {
            'enhance_scroll_1': { min: 1, max: 5 },
            'enhance_scroll_2': { min: 6, max: 10 },
            'enhance_scroll_3': { min: 11, max: 15 },
            'enhance_scroll_4': { min: 16, max: 20 },
            'protect_scroll_1': { min: 1, max: 10 },
            'protect_scroll_2': { min: 11, max: 15 },
            'protect_scroll_3': { min: 16, max: 20 },
            'maintain_scroll_1': { min: 11, max: 15 },
            'maintain_scroll_2': { min: 16, max: 20 }
        };
        
        const range = itemRanges[itemId];
        if (!range) {
            return { usable: false, reason: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.' };
        }
        
        if (currentLevel < range.min || currentLevel > range.max) {
            return { 
                usable: false, 
                reason: `ì´ ì•„ì´í…œì€ ${range.min}~${range.max}ê°•ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.` 
            };
        }
        
        if (currentLevel >= 20) {
            return { usable: false, reason: 'ì´ë¯¸ ìµœëŒ€ ê°•í™” ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' };
        }
        
        return { usable: true };
    }
    
    async function useItemForEnhancement(itemId, userItemId) {
        if (isUpgrading) return;
        
        try {
            isUpgrading = true;
            
            // ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ
            const { data: item } = await supabaseClient
                .from('user_items')
                .select('*')
                .eq('id', userItemId)
                .single();
            
            if (!item) {
                alert('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                isUpgrading = false;
                return;
            }
            
            if (item.quantity <= 0) {
                alert('ì•„ì´í…œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                isUpgrading = false;
                return;
            }
            
            // ì•„ì´í…œ íš¨ê³¼ ì ìš©
            const result = applyItemEffect(itemId);
            
            if (result.success) {
                // ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ ë˜ëŠ” ì‚­ì œ
                if (item.quantity > 1) {
                    await supabaseClient
                        .from('user_items')
                        .update({ quantity: item.quantity - 1 })
                        .eq('id', userItemId);
                } else {
                    await supabaseClient
                        .from('user_items')
                        .delete()
                        .eq('id', userItemId);
                }
                
                // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© ì‹œ íŒë§¤ê°€ í˜ë„í‹° í”Œë˜ê·¸ ì„¤ì •
                const usedEnhanceScroll = itemId.startsWith('enhance_scroll_');
                
                // ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸
                // ì•ˆì „ì¥ì¹˜: ë ˆë²¨ í•˜ë½ ë°©ì§€
                if (result.newLevel < user.current_sword_lvl && !result.weaponType) {
                    console.warn('ì•„ì´í…œ ì‚¬ìš© ì‹œ ë ˆë²¨ í•˜ë½ ë°©ì§€');
                    result.newLevel = user.current_sword_lvl;
                }
                
                const updateData = {
                    current_sword_lvl: result.newLevel,
                    current_weapon_type: result.weaponType || user.current_weapon_type,
                    current_weapon_key: result.weaponKey || user.current_weapon_key
                };
                
                // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© ì‹œ íŒë§¤ í˜ë„í‹° í”Œë˜ê·¸ ì¶”ê°€
                if (usedEnhanceScroll) {
                    updateData.used_enhance_scroll = true;
                }
                
                await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('id', user.id);
                
                user.current_sword_lvl = result.newLevel;
                if (result.weaponType) user.current_weapon_type = result.weaponType;
                if (result.weaponKey) user.current_weapon_key = result.weaponKey;
                if (usedEnhanceScroll) user.used_enhance_scroll = true;
                
                // UI ì—…ë°ì´íŠ¸
                updateUI();
                
                // ì„±ê³µ ë©”ì‹œì§€
                alert(result.message + (usedEnhanceScroll ? '\nâ€» í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ íŒë§¤ê°€ 50% ê°ì†Œë©ë‹ˆë‹¤.' : ''));
            } else {
                alert(result.message);
            }
            
        } catch (e) {
            alert('ì•„ì´í…œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        } finally {
            isUpgrading = false;
        }
    }
    
    function applyItemEffect(itemId) {
        const currentLevel = user.current_sword_lvl;
        
        if (itemId.startsWith('enhance_scroll_')) {
            // í™•ì • ê°•í™”ê¶Œ - ë¬´ì¡°ê±´ 100% ì„±ê³µ
            return {
                success: true,
                newLevel: currentLevel + 1,
                message: `í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ ê°•í™” ì„±ê³µ! [+${currentLevel + 1}ë ˆë²¨]`
            };
        } else if (itemId.startsWith('protect_scroll_') || itemId.startsWith('maintain_scroll_')) {
            // ë³´í˜¸ ì•„ì´í…œ - íŒŒê´´ì™€ í•˜ë½ì„ ì™„ì „íˆ ë°©ì§€
            const rates = getEnhancementRates(currentLevel);
            const random = Math.random() * 100;
            
            let newLevel = currentLevel;
            let message = "";
            
            // ì„±ê³µ í™•ë¥ ë§Œ ì ìš©, ì‹¤íŒ¨ ì‹œ ë ˆë²¨ ìœ ì§€ (íŒŒê´´/í•˜ë½ 0%)
            if (random <= rates.success) {
                newLevel = currentLevel + 1;
                message = `ë³´í˜¸ ì•„ì´í…œ ì‚¬ìš©ìœ¼ë¡œ ê°•í™” ì„±ê³µ! [+${newLevel}ë ˆë²¨]`;
            } else {
                // ì‹¤íŒ¨í•´ë„ ë ˆë²¨ ìœ ì§€ (ë³´í˜¸ íš¨ê³¼)
                message = "ê°•í™” ì‹¤íŒ¨í–ˆì§€ë§Œ ë³´í˜¸ ì•„ì´í…œìœ¼ë¡œ ë ˆë²¨ ìœ ì§€!";
            }
            
            return {
                success: true,
                newLevel,
                weaponType: null,
                weaponKey: null,
                message
            };
        }
        
        return {
            success: false,
            message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.'
        };
    }

    function updateUI() {
        const currentLevel = user.current_sword_lvl;
        const item = getSwordDataForLevel(currentLevel);
        const upgradeCost = getEnhancementCost(currentLevel);
        const sellPrice = getSellPrice(currentLevel);
        const successRate = getSuccessRate(currentLevel);

        const weaponType = getWeaponType();
        const weaponKey = user.current_weapon_key || 'normal_01';
        
        document.getElementById('u-nick').innerText = ((user.nickname && user.nickname.trim()) ? user.nickname : 'í”Œë ˆì´ì–´') + 'ë‹˜';
        document.getElementById('u-gold').innerText = (user.gold || 0).toLocaleString() + "G";
        document.getElementById('u-money').innerText = (user.money || 0).toLocaleString() + "M";
        getVariantName(weaponKey, currentLevel).then(name => {
            document.getElementById('s-name').innerText = `[+${currentLevel}] ${weaponType === 'hidden' ? '[HIDDEN] ' : ''}${name}`;
        });
        document.getElementById('s-desc').innerText = item.description;
        document.getElementById('stat-cost').innerText = upgradeCost.toLocaleString();
        document.getElementById('stat-sell').innerText = sellPrice.toLocaleString();
        document.getElementById('stat-rate').innerText = successRate;
        document.getElementById('s-img').src = item.image_url;
    }

    function getSwordDataForLevel(level) {
        const lv = Math.max(0, Math.min(20, parseInt(level || 0, 10)));
        if (swords[lv]) return swords[lv];

        for (let i = lv; i >= 0; i--) {
            if (swords[i]) return swords[i];
        }
        return swords[1];
    }
    
    function getSuccessRate(level) {
        const rates = [
            85,  // 0 â†’ 1 (80â†’85)
            80,  // 1 â†’ 2 (75â†’80)
            75,  // 2 â†’ 3 (70â†’75)
            70,  // 3 â†’ 4 (65â†’70)
            65,  // 4 â†’ 5 (60â†’65)
            60,  // 5 â†’ 6 (55â†’60)
            55,  // 6 â†’ 7 (50â†’55)
            50,  // 7 â†’ 8 (45â†’50)
            45,  // 8 â†’ 9 (40â†’45)
            40,  // 9 â†’ 10 (35â†’40)
            35,  // 10 â†’ 11 (30â†’35)
            30,  // 11 â†’ 12 (25â†’30)
            25,  // 12 â†’ 13 (20â†’25)
            20,  // 13 â†’ 14 (15â†’20)
            17,  // 14 â†’ 15 (12â†’17)
            15,  // 15 â†’ 16 (10â†’15)
            13,  // 16 â†’ 17 (8â†’13)
            10,  // 17 â†’ 18 (5â†’10)
            8,   // 18 â†’ 19 (3â†’8)
            5    // 19 â†’ 20 (1â†’5)
        ];
        return rates[level] || 0;
    }

    function getEnhancementCost(level) {
        // Enhancement costs from PRD - 1% í• ì¸ ì ìš©
        const baseCosts = [
            100,        // 0 â†’ 1
            200,        // 1 â†’ 2
            400,        // 2 â†’ 3
            800,        // 3 â†’ 4
            1600,       // 4 â†’ 5
            3200,       // 5 â†’ 6
            6400,       // 6 â†’ 7
            12800,      // 7 â†’ 8
            25600,      // 8 â†’ 9
            51200,      // 9 â†’ 10
            102400,     // 10 â†’ 11
            204800,     // 11 â†’ 12
            409600,     // 12 â†’ 13
            819200,     // 13 â†’ 14
            1638400,    // 14 â†’ 15
            3276800,    // 15 â†’ 16
            6553600,    // 16 â†’ 17
            13107200,   // 17 â†’ 18
            26214400,   // 18 â†’ 19
            52428800    // 19 â†’ 20
        ];
        const baseCost = baseCosts[level] || 0;
        return Math.floor(baseCost * 0.99); // 1% í• ì¸
    }

    async function handleUpgrade() {
        if (isUpgrading) return;
        
        const currentLevel = user.current_sword_lvl;
        const currentSword = swords[currentLevel];
        
        // Get enhancement rates and cost based on current level
        const rates = getEnhancementRates(currentLevel);
        const upgradeCost = getEnhancementCost(currentLevel);
        
        if (upgradeCost <= 0) return alert("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!");
        if (user.gold < upgradeCost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        if (currentLevel >= 20) return alert("ìµœëŒ€ ê°•í™” ë ˆë²¨(20)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!");
        
        isUpgrading = true; // Set upgrading flag

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        
        // Deduct gold first
        user.gold -= upgradeCost;
        
        // Determine enhancement result
        const result = determineEnhancementResult(rates);
        let newLevel = currentLevel;
        let message = "";
        let nextWeaponType = getWeaponType();
        let nextWeaponKey = user.current_weapon_key || 'normal_01';
        
        switch(result) {
            case 'success':
                newLevel = currentLevel + 1;
                message = `ê°•í™” ì„±ê³µ! [+${newLevel}ë ˆë²¨]`;
                // ì¼ë°˜ ê°•í™” ì„±ê³µ ì‹œ í™•ì • ê°•í™”ê¶Œ í”Œë˜ê·¸ ì´ˆê¸°í™”
                user.used_enhance_scroll = false;
                break;
            case 'maintain':
                message = "ê°•í™” ì‹¤íŒ¨!";
                break;
            case 'destroy':
                newLevel = 0;
                nextWeaponType = Math.random() < 0.01 ? 'hidden' : 'normal';
                // reroll base weapon key within the type (normal_01.._30, hidden_01.._03)
                if (nextWeaponType === 'normal') {
                    const n = Math.floor(Math.random() * 30) + 1;
                    nextWeaponKey = `normal_${String(n).padStart(2,'0')}`;
                } else {
                    const n = Math.floor(Math.random() * 3) + 1;
                    nextWeaponKey = `hidden_${String(n).padStart(2,'0')}`;
                }
                message = "ê°•í™” ì‹¤íŒ¨! (ê²€ íŒŒê´´)";
                // íŒŒê´´ ì‹œì—ë„ í”Œë˜ê·¸ ì´ˆê¸°í™”
                user.used_enhance_scroll = false;
                break;
            default:
                // ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ëŠ” ìœ ì§€ë¡œ ì²˜ë¦¬
                message = "ê°•í™” ì‹¤íŒ¨!";
                break;
        }
        
        // Update user data
        // ì•ˆì „ì¥ì¹˜: newLevelì´ í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ë‚®ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€ (íŒŒê´´ ì œì™¸)
        if (result !== 'destroy' && newLevel < currentLevel) {
            console.warn('ë ˆë²¨ í•˜ë½ ë°©ì§€: newLevelì„ currentLevelë¡œ ì„¤ì •');
            newLevel = currentLevel;
        }
        
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                gold: user.gold, 
                current_sword_lvl: newLevel,
                current_weapon_type: nextWeaponType,
                current_weapon_key: nextWeaponKey,
                used_enhance_scroll: user.used_enhance_scroll || false
            })
            .eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('hammering');
            user.current_sword_lvl = newLevel;
            user.current_weapon_type = nextWeaponType;
            user.current_weapon_key = nextWeaponKey;
            showEffect(result === 'success', message);
            updateUI();
            isUpgrading = false; // Reset upgrading flag after completion
        }, 600);
    }

    async function handleStore() {
        if (isUpgrading) return alert("ê°•í™” ì¤‘ì—ëŠ” ë³´ê´€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const level = parseInt(user.current_sword_lvl || 0, 10);
        if (level <= 0) return alert("0ê°• ìƒíƒœëŠ” ë³´ê´€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const type = getWeaponType();
        const key = user.current_weapon_key || 'normal_01';
        
        // ê²€ ì´ë¦„ ë°ì´í„°ì—ì„œ sword_idì™€ ì‹¤ì œ ì´ë¦„ ì°¾ê¸°
        let swordId = null;
        let actualName = `${type === 'hidden' ? '[HIDDEN] ' : ''}${key}`;
        
        try {
            const swordData = await fetch('sword_names.json').then(r => r.json());
            const matchingSword = swordData.swords.find(s => 
                s.type === type && s.level === level
            );
            
            if (matchingSword) {
                swordId = matchingSword.id;
                actualName = matchingSword.name;
            } else {
                // ê¸°ë³¸ê°’ ì„¤ì •
                swordId = type === 'normal' ? (level + 1) : (841 + level);
            }
        } catch (e) {
            swordId = type === 'normal' ? (level + 1) : (841 + level);
        }
        
        const attack = 10 + level * 5;
        const rarity = type === 'hidden' ? 'legendary' : (level >= 15 ? 'epic' : level >= 10 ? 'rare' : 'common');

        try {
            const { error: insErr } = await supabaseClient.from('user_swords').insert({
                user_id: user.id,
                sword_id: swordId,
                sword_level: level,
                sword_name: actualName,
                weapon_type: type,
                weapon_key: key,
                attack: attack,
                rarity: rarity
            });
            if (insErr) throw insErr;

            // update discoveries (max discovered level)
            const { data: existing } = await supabaseClient
                .from('user_weapon_discoveries')
                .select('max_discovered_level')
                .eq('user_id', user.id)
                .eq('weapon_type', type)
                .eq('weapon_key', key)
                .maybeSingle();

            const nextMax = Math.max(existing?.max_discovered_level || 0, level);
            if (!existing) {
                await supabaseClient.from('user_weapon_discoveries').insert({
                    user_id: user.id,
                    weapon_type: type,
                    weapon_key: key,
                    max_discovered_level: nextMax
                });
            } else if (nextMax > (existing.max_discovered_level || 0)) {
                await supabaseClient.from('user_weapon_discoveries')
                    .update({ max_discovered_level: nextMax })
                    .eq('user_id', user.id)
                    .eq('weapon_type', type)
                    .eq('weapon_key', key);
            }

            // reset current sword to 0 after storing
            user.current_sword_lvl = 0;
            await supabaseClient.from('profiles')
                .update({ current_sword_lvl: 0 })
                .eq('id', user.id);
            updateUI();

            alert('í˜„ì¬ ê²€ì„ ì¸ë²¤í† ë¦¬ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
            alert('ë³´ê´€ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
        }
    }
    
    function getEnhancementRates(level) {
        // Format: { success: %, maintain: %, destroy: % } - íŒŒê´´ í™•ë¥  ê°ì†Œ, ì„±ê³µ í™•ë¥  ì¦ê°€
        const rates = [
            { success: 85, maintain: 15, destroy: 0 },   // 0 â†’ 1
            { success: 80, maintain: 20, destroy: 0 },   // 1 â†’ 2
            { success: 75, maintain: 25, destroy: 0 },   // 2 â†’ 3
            { success: 70, maintain: 30, destroy: 0 },   // 3 â†’ 4
            { success: 65, maintain: 35, destroy: 0 },   // 4 â†’ 5
            { success: 60, maintain: 39, destroy: 1 },   // 5 â†’ 6
            { success: 55, maintain: 43, destroy: 2 },   // 6 â†’ 7
            { success: 50, maintain: 47, destroy: 3 },   // 7 â†’ 8
            { success: 45, maintain: 51, destroy: 4 },   // 8 â†’ 9
            { success: 40, maintain: 55, destroy: 5 },   // 9 â†’ 10
            { success: 35, maintain: 60, destroy: 5 },   // 10 â†’ 11
            { success: 30, maintain: 65, destroy: 5 },   // 11 â†’ 12
            { success: 25, maintain: 70, destroy: 5 },   // 12 â†’ 13
            { success: 20, maintain: 75, destroy: 5 },   // 13 â†’ 14
            { success: 17, maintain: 78, destroy: 5 },   // 14 â†’ 15
            { success: 15, maintain: 80, destroy: 5 },   // 15 â†’ 16
            { success: 13, maintain: 82, destroy: 5 },   // 16 â†’ 17
            { success: 10, maintain: 85, destroy: 5 },   // 17 â†’ 18
            { success: 8, maintain: 87, destroy: 5 },    // 18 â†’ 19
            { success: 5, maintain: 90, destroy: 5 }     // 19 â†’ 20
        ];
        
        return rates[level] || { success: 0, maintain: 0, destroy: 0 };
    }
    
    function determineEnhancementResult(rates) {
        const rand = Math.random() * 100;
        let cumulative = 0;
        
        // ëª…ì‹œì ìœ¼ë¡œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ ë°©ì§€
        cumulative += rates.success;
        if (rand < cumulative) {
            return 'success';
        }
        
        cumulative += rates.maintain;
        if (rand < cumulative) {
            return 'maintain';
        }
        
        cumulative += rates.destroy;
        if (rand < cumulative) {
            return 'destroy';
        }
        
        // ê¸°ë³¸ê°’ì€ ìœ ì§€ (í•˜ë½ ì—†ìŒ)
        return 'maintain';
    }

    async function handleSell() {
        if (isUpgrading) return alert("ê°•í™” ì¤‘ì—ëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        const currentLevel = user.current_sword_lvl;
        if (currentLevel === 0) return alert("0ê°• ìƒíƒœëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        let sellPrice = getSellPrice(currentLevel);
        
        // í™•ì • ê°•í™”ê¶Œ ì‚¬ìš© ì‹œ íŒë§¤ê°€ 50% ê°ì†Œ
        const usedEnhanceScroll = user.used_enhance_scroll || false;
        if (usedEnhanceScroll) {
            sellPrice = Math.floor(sellPrice * 0.5);
        }
        
        const penaltyMsg = usedEnhanceScroll ? '\nâ€» í™•ì • ê°•í™”ê¶Œ ì‚¬ìš©ìœ¼ë¡œ íŒë§¤ê°€ 50% ê°ì†Œ ì ìš©ë¨' : '';
        if (!confirm(`${sellPrice.toLocaleString()}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${penaltyMsg}`)) return;

        user.gold += sellPrice;
        user.current_sword_lvl = 0;
        user.used_enhance_scroll = false; // íŒë§¤ í›„ í”Œë˜ê·¸ ì´ˆê¸°í™”
        
        await supabaseClient.from('profiles')
            .update({ 
                gold: user.gold, 
                current_sword_lvl: 0,
                used_enhance_scroll: false
            })
            .eq('id', user.id);
        updateUI();
    }

    function showEffect(win, message) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = win ? 'rgba(72, 187, 120, 0.9)' : 'rgba(245, 101, 101, 0.9)';
        el.innerText = message || (win ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨!");
        setTimeout(() => el.style.display = 'none', 1000);
    }

    function showGoldEffect(amt, isPlus) {
        const el = document.createElement('div');
        el.className = 'money-float';
        el.style.color = isPlus ? '#3498db' : '#e74c3c';
        el.innerText = (isPlus ? '+' : '-') + Math.abs(amt).toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    async function loadAllUsers() {
        const { data } = await supabaseClient.from('profiles').select('id, username, gold, current_sword_lvl, email');
        allUsers = data || [];
    }

    function showAdminPanel() {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        let content = `
            <div style="background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
                <div style="margin-bottom: 20px;">
                    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                        ${allUsers.map(u => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${u.username || u.email}</strong>
                                <div>ê³¨ë“œ: <input type="number" id="gold-${u.id}" value="${u.gold || 0}" style="width: 80px;"></div>
                                <div>ë¨¸ë‹ˆ: <input type="number" id="money-${u.id}" value="${u.money || 0}" style="width: 80px;"></div>
                                <div>ë ˆë²¨: <input type="number" id="level-${u.id}" value="${u.current_sword_lvl}" min="1" max="20" style="width: 60px;"></div>
                                <button onclick="updateUser('${u.id}')" style="margin-top: 5px; padding: 2px 8px; font-size: 12px;">ìˆ˜ì •</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="this.parentNode.parentNode.remove()" style="padding: 8px 20px; background: #2d3748; color: white; border: none; border-radius: 5px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
        `;
        
        modal.innerHTML = content;
        document.body.appendChild(modal);
        
        // Add the updateUser function to the window object
        window.updateUser = async (userId) => {
            const gold = parseInt(document.getElementById(`gold-${userId}`).value) || 0;
            const money = parseInt(document.getElementById(`money-${userId}`).value) || 0;
            let level = parseInt(document.getElementById(`level-${userId}`).value) || 1;
            
            // Enforce max level of 20
            level = Math.min(level, 20);
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ gold, money, current_sword_lvl: level })
                    .eq('id', userId);
                
                if (error) throw error;
                alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadAllUsers();
                modal.remove();
                showAdminPanel(); // Refresh the panel
            } catch (e) {
                alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        };
    }

    async function redeem() {
        const code = prompt("ì½”ë“œ ì…ë ¥");
        if (!code) return;
        
        try {
            const { data, error } = await supabaseClient
                .from('reward_codes')
                .select('*')
                .eq('code', code)
                .single();
                
            if (error || !data) {
                return alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.");
            }
            
            user.gold += data.reward_gold;
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ gold: user.gold })
                .eq('id', user.id);
                
            if (updateError) throw updateError;
            
            showGoldEffect(data.reward_gold, true);
            updateUI();
            alert(`ì„±ê³µì ìœ¼ë¡œ ${data.reward_gold.toLocaleString()}Gë¥¼ ì§€ê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤!`);
            
            // ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
            await supabaseClient
                .from('reward_codes')
                .delete()
                .eq('code', code);
                
        } catch (e) {
            console.error('Error redeeming code:', e);
            alert('ì½”ë“œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    init();
</script>
</body>
</html>
sword.html
