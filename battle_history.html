<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë°°í‹€ ê¸°ë¡ - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; padding: 20px 10px; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1a202c; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        
        .content { background: white; padding: 20px; border-radius: 0 0 20px 20px; }
        
        .battle-list { display: flex; flex-direction: column; gap: 12px; }
        .battle-item { background: #f8fafc; border-radius: 12px; padding: 15px; border: 2px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .battle-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .battle-item.win { border-color: #48bb78; background: #f0fff4; }
        .battle-item.lose { border-color: #f56565; background: #fff5f5; }
        .battle-item.draw { border-color: #ed8936; background: #fffaf0; }
        
        .battle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .battle-result { font-size: 14px; font-weight: 700; }
        .battle-date { font-size: 12px; color: #718096; }
        
        .battle-info { font-size: 13px; color: #4a5568; }
        .vs-text { font-weight: 600; margin: 0 8px; }
        
        .loading { text-align: center; padding: 40px 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2d3748; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #718096; }
        .empty-icon { font-size: 48px; margin-bottom: 10px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        
        .battle-log { background: #f8fafc; border-radius: 12px; padding: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .log-entry { font-size: 12px; color: #4a5568; padding: 4px 0; line-height: 1.4; }
        .log-entry.result { background: #edf2f7; padding: 8px; border-radius: 8px; margin-top: 8px; font-weight: 700; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš”ï¸ ë°°í‹€ ê¸°ë¡</h1>
        <button onclick="location.href='battle.html'" title="ë°°í‹€í•˜ê¸°"><i class="fa-solid fa-plus"></i></button>
    </div>
    
    <div class="content">
        <div id="loadingDiv" class="loading">
            <div class="spinner"></div>
            <p>ë°°í‹€ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <div id="contentDiv" style="display: none;">
            <div class="battle-list" id="battleList"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">âš”ï¸</div>
                <p>ë°°í‹€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <button onclick="location.href='battle.html'" style="margin-top: 15px; padding: 10px 20px; background: #2d3748; color: white; border: none; border-radius: 10px; cursor: pointer;">ì²« ë°°í‹€ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 style="text-align: center; margin-bottom: 15px;">ë°°í‹€ ìƒì„¸</h2>
        <div id="detailContent"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let battles = [];
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            // ë°°í‹€ ê¸°ë¡ ë¡œë“œ
            const { data: battleData } = await supabaseClient
                .from('battles')
                .select(`
                    *,
                    player1:player1_id(nickname),
                    player2:player2_id(nickname),
                    player1_sword:player1_sword_id(sword_name, sword_level),
                    player2_sword:player2_sword_id(sword_name, sword_level)
                `)
                .or(`player1_id.eq.${user.id},player2_id.eq.${user.id}`)
                .order('created_at', { ascending: false })
                .limit(50);
            
            battles = battleData || [];
            
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('contentDiv').style.display = 'block';
            renderBattles();
        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').innerHTML = '<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
    
    function renderBattles() {
        const list = document.getElementById('battleList');
        const empty = document.getElementById('emptyState');
        
        if (battles.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        
        empty.style.display = 'none';
        list.innerHTML = battles.map(battle => {
            const isPlayer1 = battle.player1_id === user.id;
            const opponent = isPlayer1 ? battle.player2 : battle.player1;
            const myResult = battle.winner_id === user.id ? 'win' : 
                           battle.winner_id === null ? 'draw' : 'lose';
            
            const resultText = myResult === 'win' ? 'ğŸ‰ ìŠ¹ë¦¬' : 
                             myResult === 'lose' ? 'ğŸ˜¢ íŒ¨ë°°' : 'â° ë¬´ìŠ¹ë¶€';
            
            const date = new Date(battle.created_at).toLocaleDateString('ko-KR', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            
            return `
                <div class="battle-item ${myResult}" onclick="showBattleDetail(${battle.id})">
                    <div class="battle-header">
                        <div class="battle-result">${resultText}</div>
                        <div class="battle-date">${date}</div>
                    </div>
                    <div class="battle-info">
                        ${isPlayer1 ? battle.player1_sword?.sword_name : battle.player2_sword?.sword_name}
                        <span class="vs-text">vs</span>
                        ${opponent?.nickname || 'ìµëª…'}ì˜ ${isPlayer1 ? battle.player2_sword?.sword_name : battle.player1_sword?.sword_name}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function showBattleDetail(battleId) {
        const battle = battles.find(b => b.id === battleId);
        if (!battle) return;
        
        const isPlayer1 = battle.player1_id === user.id;
        const opponent = isPlayer1 ? battle.player2 : battle.player1;
        const myResult = battle.winner_id === user.id ? 'win' : 
                       battle.winner_id === null ? 'draw' : 'lose';
        
        const resultText = myResult === 'win' ? 'ğŸ‰ ìŠ¹ë¦¬' : 
                         myResult === 'lose' ? 'ğŸ˜¢ íŒ¨ë°°' : 'â° ë¬´ìŠ¹ë¶€';
        
        let battleLog = [];
        try {
            battleLog = JSON.parse(battle.battle_log || '[]');
        } catch (e) {
            battleLog = ['ë°°í‹€ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'];
        }
        
        const detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h3>${resultText}</h3>
                <p style="color: #718096; margin: 5px 0;">
                    ${new Date(battle.created_at).toLocaleString('ko-KR')}
                </p>
            </div>
            <div class="battle-log">
                ${battleLog.map(entry => `
                    <div class="log-entry ${entry.includes('ìŠ¹ë¦¬') || entry.includes('ë¬´ìŠ¹ë¶€') ? 'result' : ''}">${entry}</div>
                `).join('')}
            </div>
        `;
        
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }
    
    init();
</script>
</body>
</html>