<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°í‹€ ê¸°ë¡ - Up Sword</title>
    <link rel="icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; font-weight: 900; color: #2d3748; }
        .back-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; }
        
        .stats-summary { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-box { text-align: center; padding: 15px; background: #f8fafc; border-radius: 12px; }
        .stat-label { font-size: 12px; color: #718096; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 900; color: #2d3748; }
        
        .history-list { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .history-item { padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        .history-left { flex: 1; }
        .history-result { font-size: 20px; margin-right: 15px; }
        .history-info { font-size: 14px; color: #2d3748; font-weight: 600; margin-bottom: 5px; }
        .history-detail { font-size: 12px; color: #718096; }
        .history-right { text-align: right; }
        .history-reward { font-size: 12px; color: #48bb78; font-weight: 700; }
        .history-time { font-size: 11px; color: #a0aec0; margin-top: 5px; }
        
        .win { color: #48bb78; }
        .lose { color: #f56565; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
        .empty-icon { font-size: 60px; margin-bottom: 15px; opacity: 0.5; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“œ ë°°í‹€ ê¸°ë¡</h1>
        <button class="back-btn" onclick="location.href='battle.html'">
            <i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°
        </button>
    </div>
    
    <div class="stats-summary">
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">ì´ ì „íˆ¬</div>
                <div class="stat-value" id="totalBattles">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ìŠ¹ë¦¬</div>
                <div class="stat-value win" id="totalWins">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">íŒ¨ë°°</div>
                <div class="stat-value lose" id="totalLoses">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ìŠ¹ë¥ </div>
                <div class="stat-value" id="winRate">0%</div>
            </div>
        </div>
    </div>
    
    <div class="history-list">
        <h3 style="margin-bottom: 15px; color: #2d3748;">ìµœê·¼ ì „íˆ¬ ê¸°ë¡</h3>
        <div id="historyContent"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                location.href = 'login.html';
                return;
            }
            
            // ë°°í‹€ ê¸°ë¡ ë¡œë“œ
            const { data: history, error } = await supabaseClient
                .from('battle_history')
                .select('*')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            if (!history || history.length === 0) {
                document.getElementById('historyContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš”ï¸</div>
                        <p>ì•„ì§ ë°°í‹€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            // í†µê³„ ê³„ì‚°
            const totalBattles = history.length;
            const totalWins = history.filter(h => h.result === 'win').length;
            const totalLoses = history.filter(h => h.result === 'lose').length;
            const winRate = totalBattles > 0 ? ((totalWins / totalBattles) * 100).toFixed(1) : 0;
            
            document.getElementById('totalBattles').textContent = totalBattles;
            document.getElementById('totalWins').textContent = totalWins;
            document.getElementById('totalLoses').textContent = totalLoses;
            document.getElementById('winRate').textContent = winRate + '%';
            
            // ê¸°ë¡ ë Œë”ë§
            const content = document.getElementById('historyContent');
            content.innerHTML = history.map(h => {
                const isWin = h.result === 'win';
                const date = new Date(h.created_at);
                const timeStr = date.toLocaleString('ko-KR');
                
                return `
                    <div class="history-item">
                        <div style="display: flex; align-items: center;">
                            <div class="history-result">${isWin ? 'ğŸ‰' : 'ğŸ’€'}</div>
                            <div class="history-left">
                                <div class="history-info ${isWin ? 'win' : 'lose'}">
                                    ${isWin ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} - Lv.${h.dummy_level} í—ˆìˆ˜ì•„ë¹„
                                </div>
                                <div class="history-detail">
                                    ê²€ ë ˆë²¨: +${h.user_sword_level} | ê³µê²©ë ¥: ${h.user_attack} | í—ˆìˆ˜ì•„ë¹„ HP: ${h.dummy_hp.toLocaleString()}
                                </div>
                                <div class="history-time">${timeStr}</div>
                            </div>
                        </div>
                        <div class="history-right">
                            ${isWin ? `
                                <div class="history-reward">+${h.exp_gained} EXP</div>
                                <div class="history-reward">+${h.coins_gained} ğŸ’</div>
                            ` : '<div style="color: #a0aec0; font-size: 12px;">ë³´ìƒ ì—†ìŒ</div>'}
                        </div>
                    </div>
                `;
            }).join('');
            
        } catch (e) {
            console.error('ë¡œë“œ ì˜¤ë¥˜:', e);
            alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }
    
    window.onload = init;
</script>
</body>
</html>