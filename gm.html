<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM 패널 - 검강화 게임</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .search-box { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .search-box input { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; }
        .user-list { overflow-y: auto; max-height: 70vh; }
        .user-card { padding: 15px 20px; border-bottom: 1px solid #e9ecef; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .user-card.banned { background-color: #fff3cd; }
        .user-info { flex: 1; min-width: 200px; }
        .user-email { color: #6c757d; font-size: 0.9em; }
        .user-stats { display: flex; gap: 15px; flex-wrap: wrap; }
        .conversion-section { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; width: 100%; }
        .conversion-row { display: flex; gap: 10px; margin-top: 5px; }
        .conversion-row input { flex: 1; max-width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .stat-box { min-width: 120px; }
        .stat-label { font-size: 0.8em; color: #6c757d; }
        .stat-value { display: flex; align-items: center; gap: 5px; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-ban { background-color: #dc3545; color: white; }
        .btn-convert { background-color: #17a2b8; color: white; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; color: white; opacity: 0; transition: 0.3s; z-index: 1000; }
        .notification.show { opacity: 1; }
        .success { background-color: #28a745; }
        .error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> GM 관리자 패널 (codetbase)</h1>
            <button id="logoutBtn" class="btn btn-ban">로그아웃</button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="이메일 또는 닉네임으로 검색...">
        </div>
        <div id="userList" class="user-list">
            <div style="padding: 20px; text-align: center;">로딩 중...</div>
        </div>
    </div>
    <div id="notification" class="notification"></div>

    <!-- 로그 확인 모달 -->
    <div id="logModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; overflow-y:auto;">
        <div style="max-width:1000px; margin:50px auto; background:white; border-radius:10px; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="logModalTitle">활동 로그</h2>
                <button onclick="closeLogModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <!-- 통계 요약 -->
            <div id="logStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;"></div>
            
            <!-- 로그 목록 -->
            <div style="max-height:500px; overflow-y:auto; border:1px solid #ddd; border-radius:5px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="position:sticky; top:0; background:#f8f9fa;">
                        <tr>
                            <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">시간</th>
                            <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">활동</th>
                            <th style="padding:10px; border-bottom:2px solid #ddd; text-align:right;">골드 변화</th>
                            <th style="padding:10px; border-bottom:2px solid #ddd; text-align:right;">머니 변화</th>
                            <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">상세</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
        
        let client;
        let allUsers = [];

        async function init() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    client = supabase.createClient(S_URL, S_KEY);
                } else {
                    throw new Error("Supabase 라이브러리가 로드되지 않았습니다.");
                }

                document.getElementById('logoutBtn').onclick = handleLogout;
                document.getElementById('searchInput').oninput = filterUsers;

                await loadUsers();
            } catch (e) {
                console.error(e);
                alert(e.message);
            }
        }

        async function loadUsers() {
            try {
                const { data, error } = await client
                    .from('profiles')
                    .select('id, nickname, phone, gold, money, current_sword_lvl, is_banned, ban_reason')
                    .order('nickname', { ascending: true });

                if (error) throw error;
                allUsers = data || [];
                renderUsers(allUsers);
            } catch (error) {
                showNotification('데이터 로드 실패: ' + error.message, 'error');
            }
        }

        function renderUsers(users) {
            const list = document.getElementById('userList');
            if (!users || users.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center;">사용자가 없습니다.</div>';
                return;
            }

            list.innerHTML = users.map(u => `
                <div class="user-card ${u.is_banned ? 'banned' : ''}">
                    <div class="user-info">
                        <strong>${(u.nickname && u.nickname.trim()) ? u.nickname : '이름 없음'}</strong> ${u.is_banned ? '<span style="color:red">(정지)</span>' : ''}
                    </div>
                    <div class="user-stats">
                        <div class="stat-box">
                            <div class="stat-label">골드</div>
                            <input type="number" id="g-${u.id}" value="${u.gold || 0}">
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">머니</div>
                            <input type="number" id="m-${u.id}" value="${u.money || 0}">
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">레벨</div>
                            <input type="number" id="l-${u.id}" value="${u.current_sword_lvl || 1}" max="20">
                        </div>
                    </div>
                    <div style="margin-left:auto; display:flex; gap:5px;">
                        <button class="btn btn-save" onclick="updateUser('${u.id}')">저장</button>
                        <button class="btn" style="background-color: #6c757d; color: white;" onclick="showUserLogs('${u.id}', '${u.nickname || '이름없음'}')">로그 확인</button>
                        <button class="btn btn-ban" onclick="showBanModal('${u.id}', ${!u.is_banned}, '${u.nickname || '이름없음'}')">
                            ${u.is_banned ? '해제' : '정지'}
                        </button>
                    </div>
                    <div class="conversion-section">
                        <div style="font-size: 0.9em; margin-bottom: 5px; color: #6c757d;">
                            <i class="fas fa-exchange-alt"></i> 재화 변환 (1 GOLD = 1000 MONEY)
                        </div>
                        <div class="conversion-row">
                            <input type="number" id="convert-amount-${u.id}" placeholder="금액" min="1">
                            <select id="convert-from-${u.id}" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="gold">GOLD → MONEY</option>
                                <option value="money">MONEY → GOLD</option>
                            </select>
                            <button class="btn btn-convert" onclick="convertUserCurrency('${u.id}')">변환 실행</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterUsers() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(u =>
                (u.nickname && u.nickname.toLowerCase().includes(val))
            );
            renderUsers(filtered);
        }

        async function updateUser(id) {
            try {
                const gold = parseInt(document.getElementById(`g-${id}`).value);
                const money = parseInt(document.getElementById(`m-${id}`).value);
                const lvl = parseInt(document.getElementById(`l-${id}`).value) || 1;

                if (isNaN(gold) || isNaN(money)) {
                    showNotification('숫자를 입력해주세요.', 'error');
                    return;
                }

                const { error } = await client
                    .from('profiles')
                    .update({
                        gold,
                        money,
                        current_sword_lvl: lvl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                showNotification('정보가 수정되었습니다.', 'success');
                await loadUsers();
            } catch (err) {
                showNotification('수정 실패: ' + err.message, 'error');
            }
        }

        async function convertUserCurrency(id) {
            try {
                const amount = parseInt(document.getElementById(`convert-amount-${id}`).value);
                const type = document.getElementById(`convert-from-${id}`).value;
                
                if (isNaN(amount) || amount <= 0) {
                    showNotification('변환할 금액을 입력하세요.', 'error');
                    return;
                }

                const user = allUsers.find(u => u.id === id);
                let finalGold = parseInt(user.gold || 0);
                let finalMoney = parseInt(user.money || 0);

                if (type === 'gold') {
                    if (finalGold < amount) {
                        showNotification('보유 골드가 부족합니다.', 'error');
                        return;
                    }
                    finalGold -= amount;
                    finalMoney += (amount * 100);
                } else {
                    if (finalMoney < amount) {
                        showNotification('보유 머니가 부족합니다.', 'error');
                        return;
                    }
                    finalMoney -= amount;
                    finalGold += Math.floor(amount / 100);
                }

                const { error } = await client
                    .from('profiles')
                    .update({
                        gold: finalGold,
                        money: finalMoney,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                showNotification('변환이 완료되었습니다.', 'success');
                await loadUsers();
            } catch (err) {
                showNotification('변환 중 오류 발생', 'error');
            }
        }

        function showBanModal(userId, banStatus, userName) {
            // 기존 모달이 있으면 제거
            const existingModal = document.getElementById('banModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'banModal'; // ID 추가
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1001;';
            
            const action = banStatus ? '정지' : '해제';
            const currentUser = allUsers.find(u => u.id === userId);
            const currentReason = currentUser?.ban_reason || '';
            
            modal.innerHTML = `
                <div style="background:white;padding:25px;border-radius:15px;width:90%;max-width:400px;">
                    <h3 style="margin-bottom:15px;text-align:center;">${userName} ${action}</h3>
                    ${banStatus ? `
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:8px;font-weight:600;">정지 사유:</label>
                            <textarea id="banReasonInput" placeholder="정지 사유를 입력하세요..." style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:8px;resize:vertical;">${currentReason}</textarea>
                        </div>
                    ` : `
                        <p style="text-align:center;margin-bottom:20px;color:#666;">정말로 ${userName}의 정지를 해제하시겠습니까?</p>
                        ${currentReason ? `<div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:15px;"><strong>기존 정지 사유:</strong><br>${currentReason}</div>` : ''}
                    `}
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="executeBan('${userId}', ${banStatus}, '${userName}')" style="flex:1;padding:12px;background:#dc3545;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">${action}</button>
                        <button onclick="closeBanModal()" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">취소</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on textarea if banning
            if (banStatus) {
                setTimeout(() => document.getElementById('banReasonInput')?.focus(), 100);
            }
        }

        function closeBanModal() {
            const modal = document.getElementById('banModal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeBan(userId, banStatus, userName) {
            try {
                let banReason = '';
                if (banStatus) {
                    const reasonInput = document.getElementById('banReasonInput');
                    banReason = reasonInput?.value?.trim() || '';
                    if (!banReason) {
                        showNotification('정지 사유를 입력해주세요.', 'error');
                        return;
                    }
                }

                const updateData = {
                    is_banned: banStatus,
                    updated_at: new Date().toISOString()
                };
                
                if (banStatus) {
                    updateData.ban_reason = banReason;
                } else {
                    updateData.ban_reason = null; // Clear ban reason when unbanning
                }

                const { error } = await client
                    .from('profiles')
                    .update(updateData)
                    .eq('id', userId);
                    
                if (error) throw error;
                
                // 모달 닫기
                closeBanModal();
                
                showNotification(`${userName}이(가) ${banStatus ? '정지' : '해제'}되었습니다.`, 'success');
                await loadUsers();
            } catch (error) {
                // 오류 발생 시에도 모달 닫기
                closeBanModal();
                showNotification('처리 실패: ' + error.message, 'error');
            }
        }

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 2000);
        }

        async function showUserLogs(userId, nickname) {
            try {
                document.getElementById('logModalTitle').innerText = `${nickname}님의 활동 로그`;
                document.getElementById('logModal').style.display = 'block';
                
                // 통계 로드
                const { data: stats, error: statsError } = await client.rpc('get_user_activity_stats', {
                    target_user_id: userId
                });
                
                if (statsError) {
                    console.error('통계 로드 오류:', statsError);
                }
                
                renderLogStats(stats || []);
                
                // 최근 활동 로드
                const { data: logs, error: logsError } = await client.rpc('get_recent_user_activities', {
                    target_user_id: userId,
                    limit_count: 200
                });
                
                if (logsError) {
                    console.error('로그 로드 오류:', logsError);
                    showNotification('로그 로드 실패: ' + logsError.message, 'error');
                    return;
                }
                
                renderLogs(logs || []);
            } catch (error) {
                console.error('로그 표시 오류:', error);
                showNotification('로그 표시 실패: ' + error.message, 'error');
            }
        }
        
        function renderLogStats(stats) {
            const statsDiv = document.getElementById('logStats');
            if (!stats || stats.length === 0) {
                statsDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#6c757d;">통계 데이터가 없습니다.</div>';
                return;
            }
            
            const activityNames = {
                'sword_enhance_success': '검 강화 성공',
                'sword_enhance_fail': '검 강화 실패',
                'sword_enhance_destroy': '검 파괴',
                'sword_sell': '검 판매',
                'roulette_win': '룰렛 승리',
                'roulette_lose': '룰렛 패배',
                'battle_win': '배틀 승리',
                'battle_lose': '배틀 패배',
                'shop_purchase': '상점 구매',
                'daily_check': '출석 체크',
                'mission_reward': '미션 보상',
                'achievement_reward': '업적 보상'
            };
            
            statsDiv.innerHTML = stats.map(s => `
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; border-left:4px solid ${s.net_gold_change + s.net_money_change >= 0 ? '#28a745' : '#dc3545'};">
                    <div style="font-weight:700; margin-bottom:8px;">${activityNames[s.activity_type] || s.activity_type}</div>
                    <div style="font-size:0.9em; color:#6c757d;">횟수: ${s.total_count}회</div>
                    <div style="font-size:0.9em; color:#28a745;">골드 획득: +${(s.total_gold_gained || 0).toLocaleString()}G</div>
                    <div style="font-size:0.9em; color:#dc3545;">골드 손실: -${(s.total_gold_lost || 0).toLocaleString()}G</div>
                    <div style="font-size:0.9em; color:#28a745;">머니 획득: +${(s.total_money_gained || 0).toLocaleString()}M</div>
                    <div style="font-size:0.9em; color:#dc3545;">머니 손실: -${(s.total_money_lost || 0).toLocaleString()}M</div>
                    <div style="font-weight:700; margin-top:8px; color:${s.net_gold_change >= 0 ? '#28a745' : '#dc3545'};">
                        순 골드: ${s.net_gold_change >= 0 ? '+' : ''}${(s.net_gold_change || 0).toLocaleString()}G
                    </div>
                    <div style="font-weight:700; color:${s.net_money_change >= 0 ? '#28a745' : '#dc3545'};">
                        순 머니: ${s.net_money_change >= 0 ? '+' : ''}${(s.net_money_change || 0).toLocaleString()}M
                    </div>
                </div>
            `).join('');
        }
        
        function renderLogs(logs) {
            const tbody = document.getElementById('logTableBody');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color:#6c757d;">활동 로그가 없습니다.</td></tr>';
                return;
            }
            
            const activityNames = {
                'sword_enhance_success': '검 강화 성공',
                'sword_enhance_fail': '검 강화 실패',
                'sword_enhance_destroy': '검 파괴',
                'sword_sell': '검 판매',
                'sword_store': '검 보관',
                'roulette_win': '룰렛 승리',
                'roulette_lose': '룰렛 패배',
                'battle_win': '배틀 승리',
                'battle_lose': '배틀 패배',
                'shop_purchase': '상점 구매',
                'daily_check': '출석 체크',
                'mission_reward': '미션 보상',
                'achievement_reward': '업적 보상',
                'admin_adjust': '관리자 조정'
            };
            
            tbody.innerHTML = logs.map(log => {
                const date = new Date(log.created_at);
                const timeStr = date.toLocaleString('ko-KR');
                const goldChange = log.gold_change || 0;
                const moneyChange = log.money_change || 0;
                const details = log.details ? JSON.stringify(log.details) : '-';
                
                return `
                    <tr style="border-bottom:1px solid #e9ecef;">
                        <td style="padding:10px; font-size:0.9em;">${timeStr}</td>
                        <td style="padding:10px;">${activityNames[log.activity_type] || log.activity_type}</td>
                        <td style="padding:10px; text-align:right; color:${goldChange >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">
                            ${goldChange >= 0 ? '+' : ''}${goldChange.toLocaleString()}G
                        </td>
                        <td style="padding:10px; text-align:right; color:${moneyChange >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">
                            ${moneyChange >= 0 ? '+' : ''}${moneyChange.toLocaleString()}M
                        </td>
                        <td style="padding:10px; font-size:0.85em; color:#6c757d; max-width:200px; overflow:hidden; text-overflow:ellipsis;">${details}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function closeLogModal() {
            document.getElementById('logModal').style.display = 'none';
        }

        async function handleLogout() {
            try {
                // Initialize auth client if not already done
                if (!client) {
                    if (typeof supabase !== 'undefined' && supabase.createClient) {
                        client = supabase.createClient(S_URL, S_KEY);
                    } else {
                        throw new Error("Supabase 라이브러리를 로드할 수 없습니다.");
                    }
                }
                
                // Clear any existing session
                await client.auth.signOut();
                
                // Clear session storage
                sessionStorage.removeItem('gmAuthenticated');
                
                // Redirect to index
                window.location.href = 'index.html';
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert('로그아웃 중 오류가 발생했습니다: ' + (error.message || error));
            }
        }

        window.onload = init;
    </script>
</body>
</html>
