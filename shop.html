<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìƒì  - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; padding: 20px 10px; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1a202c; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        
        .user-currency { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .currency-item { display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .currency-gold { color: #f39c12; }
        .currency-money { color: #9b59b6; }
        
        .shop-content { background: white; padding: 20px; border-radius: 0 0 20px 20px; }
        
        .category-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; }
        .tab-btn.active { background: #2d3748; color: white; border-color: #2d3748; }
        
        .item-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .item-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; transition: 0.2s; }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .item-name { font-size: 16px; font-weight: 700; color: #2d3748; }
        .item-icon { font-size: 24px; }
        
        .item-description { font-size: 13px; color: #718096; margin-bottom: 12px; line-height: 1.4; }
        
        .item-price { display: flex; justify-content: space-between; align-items: center; }
        .price-info { display: flex; align-items: center; gap: 6px; font-weight: 700; }
        .price-gold { color: #f39c12; }
        .price-money { color: #9b59b6; }
        
        .buy-btn { padding: 8px 16px; background: #2d3748; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .buy-btn:hover { background: #1a202c; }
        .buy-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .quantity-selector { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qty-input { width: 60px; text-align: center; border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px; }
        
        .loading { text-align: center; padding: 40px 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2d3748; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 25px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-confirm { background: #2d3748; color: white; }
        .btn-cancel { background: #e2e8f0; color: #2d3748; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ›’ ìƒì </h1>
        <button onclick="location.href='home.html'" title="í™ˆìœ¼ë¡œ"><i class="fa-solid fa-house"></i></button>
    </div>
    
    <div class="user-currency">
        <div class="currency-item currency-gold">
            <i class="fa-solid fa-coins"></i>
            <span id="userGold">0</span>G
        </div>
        <div class="currency-item currency-money">
            <i class="fa-solid fa-gem"></i>
            <span id="userMoney">0</span>M
        </div>
    </div>
    
    <div class="shop-content">
        <div class="category-tabs">
            <button class="tab-btn active" onclick="switchCategory('enhancement')">ê°•í™” ì•„ì´í…œ</button>
            <button class="tab-btn" onclick="switchCategory('protection')">ë³´í˜¸ ì•„ì´í…œ</button>
            <button class="tab-btn" onclick="switchCategory('macro')">ë§¤í¬ë¡œ</button>
        </div>
        
        <div id="loadingDiv" class="loading">
            <div class="spinner"></div>
            <p>ìƒì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <div id="contentDiv" style="display: none;">
            <div class="item-grid" id="itemGrid"></div>
        </div>
    </div>
</div>

<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 style="text-align: center; margin-bottom: 15px;">ì•„ì´í…œ êµ¬ë§¤</h2>
        <div id="purchaseContent"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://tcixevutegeimzxmwabu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjaXhldnV0ZWdlaW16eG13YWJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzE0MjgsImV4cCI6MjA4NTQwNzQyOH0.-5Byh95HgE2yPM0m24LPEERZu6KJFe7eD0VSBGf_Ukk';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let currentCategory = 'enhancement';
    let selectedItem = null;
    let selectedQuantity = 1;
    
    // ìƒì  ì•„ì´í…œ ë°ì´í„° (í™•ë¥  ê¸°ë°˜ ê°€ê²© ê³„ì‚°)
    const SHOP_ITEMS = {
        enhancement: [
            {
                id: 'enhance_scroll_1',
                name: 'í™•ì • ê°•í™”ê¶Œ (1~5ê°•)',
                icon: 'ğŸ“œ',
                description: '1~5ê°• êµ¬ê°„ì—ì„œ 100% ì„±ê³µ ë³´ì¥. ì‹¤íŒ¨ ì‹œì—ë„ ë ˆë²¨ì´ ìœ ì§€ë©ë‹ˆë‹¤.',
                priceGold: 255000, // 85000 * 3
                priceMoney: 0,
                levels: [1, 2, 3, 4, 5]
            },
            {
                id: 'enhance_scroll_2',
                name: 'í™•ì • ê°•í™”ê¶Œ (6~10ê°•)',
                icon: 'ğŸ“œ',
                description: '6~10ê°• êµ¬ê°„ì—ì„œ 100% ì„±ê³µ ë³´ì¥. ì‹¤íŒ¨ ì‹œì—ë„ ë ˆë²¨ì´ ìœ ì§€ë©ë‹ˆë‹¤.',
                priceGold: 1912500, // 637500 * 3
                priceMoney: 0,
                levels: [6, 7, 8, 9, 10]
            },
            {
                id: 'enhance_scroll_3',
                name: 'í™•ì • ê°•í™”ê¶Œ (11~15ê°•)',
                icon: 'ğŸ“œ',
                description: '11~15ê°• êµ¬ê°„ì—ì„œ 100% ì„±ê³µ ë³´ì¥. ì‹¤íŒ¨ ì‹œì—ë„ ë ˆë²¨ì´ ìœ ì§€ë©ë‹ˆë‹¤.',
                priceGold: 10200000, // 3400000 * 3
                priceMoney: 0,
                levels: [11, 12, 13, 14, 15]
            },
            {
                id: 'enhance_scroll_4',
                name: 'í™•ì • ê°•í™”ê¶Œ (16~20ê°•)',
                icon: 'ğŸ“œ',
                description: '16~20ê°• êµ¬ê°„ì—ì„œ 100% ì„±ê³µ ë³´ì¥. ì‹¤íŒ¨ ì‹œì—ë„ ë ˆë²¨ì´ ìœ ì§€ë©ë‹ˆë‹¤.',
                priceGold: 0,
                priceMoney: 10200, // 3400 * 3
                levels: [16, 17, 18, 19, 20]
            }
        ],
        protection: [
            {
                id: 'protect_scroll_1',
                name: 'íŒŒê´´ ë°©ì§€ê¶Œ (1~10ê°•)',
                icon: 'ğŸ›¡ï¸',
                description: '1~10ê°• êµ¬ê°„ì—ì„œ íŒŒê´´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. í•˜ë½ì€ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                priceGold: 63750, // 21250 * 3
                priceMoney: 0,
                levels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            },
            {
                id: 'protect_scroll_2',
                name: 'íŒŒê´´ ë°©ì§€ê¶Œ (11~15ê°•)',
                icon: 'ğŸ›¡ï¸',
                description: '11~15ê°• êµ¬ê°„ì—ì„œ íŒŒê´´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. í•˜ë½ì€ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                priceGold: 1020000, // 340000 * 3
                priceMoney: 0,
                levels: [11, 12, 13, 14, 15]
            },
            {
                id: 'protect_scroll_3',
                name: 'íŒŒê´´ ë°©ì§€ê¶Œ (16~20ê°•)',
                icon: 'ğŸ›¡ï¸',
                description: '16~20ê°• êµ¬ê°„ì—ì„œ íŒŒê´´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. í•˜ë½ì€ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                priceGold: 0,
                priceMoney: 1530, // 510 * 3
                levels: [16, 17, 18, 19, 20]
            },
            {
                id: 'maintain_scroll_1',
                name: 'ë ˆë²¨ ìœ ì§€ê¶Œ (11~15ê°•)',
                icon: 'âš¡',
                description: '11~15ê°• êµ¬ê°„ì—ì„œ í•˜ë½ê³¼ íŒŒê´´ë¥¼ ëª¨ë‘ ë°©ì§€í•©ë‹ˆë‹¤.',
                priceGold: 3187500, // 1062500 * 3
                priceMoney: 0,
                levels: [11, 12, 13, 14, 15]
            },
            {
                id: 'maintain_scroll_2',
                name: 'ë ˆë²¨ ìœ ì§€ê¶Œ (16~20ê°•)',
                icon: 'âš¡',
                description: '16~20ê°• êµ¬ê°„ì—ì„œ í•˜ë½ê³¼ íŒŒê´´ë¥¼ ëª¨ë‘ ë°©ì§€í•©ë‹ˆë‹¤.',
                priceGold: 0,
                priceMoney: 8031, // 2677 * 3
                levels: [16, 17, 18, 19, 20]
            }
        ],
        macro: [
            {
                id: 'auto_macro',
                name: 'ìë™ ê°•í™” ë§¤í¬ë¡œ',
                icon: 'ğŸ¤–',
                description: 'ëª©í‘œ ë ˆë²¨ê¹Œì§€ ìë™ìœ¼ë¡œ ê°•í™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. ê°•í™” ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                priceGold: 100000000000, // 100ì–µ ê³¨ë“œ (1000ì–µ)
                priceMoney: 0,
                levels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
            }
        ]
    };
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p, error: profileError } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            if (profileError || !p) {
                console.error('í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', profileError);
                alert('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = "login.html";
                return;
            }
            user = p;
            
            // ë§¤í¬ë¡œ ì†Œìœ  ìƒíƒœ ê²€ì¦ ë° ë¡œê¹…
            console.log('ì‚¬ìš©ì ë§¤í¬ë¡œ ì†Œìœ  ìƒíƒœ:', {
                userId: user.id,
                hasMacro: user.has_macro || false,
                sessionId: session.user.id
            });
            
            updateCurrency();
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('contentDiv').style.display = 'block';
            renderItems();
        } catch (e) {
            console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
            document.getElementById('loadingDiv').innerHTML = '<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message + '</p>';
        }
    }
    
    function updateCurrency() {
        document.getElementById('userGold').innerText = (user.gold || 0).toLocaleString();
        document.getElementById('userMoney').innerText = (user.money || 0).toLocaleString();
    }
    
    function switchCategory(category) {
        currentCategory = category;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderItems();
    }
    
    function renderItems() {
        const items = SHOP_ITEMS[currentCategory];
        const grid = document.getElementById('itemGrid');
        
        grid.innerHTML = items.map(item => `
            <div class="item-card">
                <div class="item-header">
                    <div class="item-name">${item.name}</div>
                    <div class="item-icon">${item.icon}</div>
                </div>
                <div class="item-description">${item.description}</div>
                <div class="item-price">
                    <div class="price-info">
                        ${item.priceGold > 0 ? `<span class="price-gold">${item.priceGold.toLocaleString()}G</span>` : ''}
                        ${item.priceMoney > 0 ? `<span class="price-money">${item.priceMoney.toLocaleString()}M</span>` : ''}
                    </div>
                    <button class="buy-btn" onclick="showPurchaseModal('${item.id}')">êµ¬ë§¤</button>
                </div>
            </div>
        `).join('');
    }
    
    function showPurchaseModal(itemId) {
        const item = [...SHOP_ITEMS.enhancement, ...SHOP_ITEMS.protection, ...SHOP_ITEMS.macro].find(i => i.id === itemId);
        if (!item) return;
        
        // ë§¤í¬ë¡œëŠ” ì´ë¯¸ ì†Œìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
        if (item.id === 'auto_macro' && user.has_macro) {
            alert('ì´ë¯¸ ë§¤í¬ë¡œë¥¼ ì†Œìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!\nê²€ ê°•í™” í˜ì´ì§€ì—ì„œ ë§¤í¬ë¡œ íŒ¨ë„ì„ í™•ì¸í•˜ì„¸ìš”.');
            return;
        }
        
        selectedItem = item;
        selectedQuantity = 1;
        
        const content = document.getElementById('purchaseContent');
        const isMacro = item.id === 'auto_macro';
        
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 32px; margin-bottom: 10px;">${item.icon}</div>
                <h3>${item.name}</h3>
                <p style="color: #718096; font-size: 13px; margin: 10px 0;">${item.description}</p>
                ${isMacro ? '<p style="color: #e53e3e; font-weight: 600; font-size: 12px;">â€» ë§¤í¬ë¡œëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>' : ''}
            </div>
            
            ${!isMacro ? `
            <div class="quantity-selector">
                <span style="font-weight: 600;">ìˆ˜ëŸ‰:</span>
                <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                <input type="number" class="qty-input" id="quantityInput" value="1" min="1" max="99" onchange="updateQuantity()">
                <button class="qty-btn" onclick="changeQuantity(1)">+</button>
            </div>
            ` : ''}
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>${isMacro ? 'ê°€ê²©:' : 'ë‹¨ê°€:'}</span>
                    <span>
                        ${item.priceGold > 0 ? `<span class="price-gold">${item.priceGold.toLocaleString()}G</span>` : ''}
                        ${item.priceMoney > 0 ? `<span class="price-money">${item.priceMoney.toLocaleString()}M</span>` : ''}
                    </span>
                </div>
                ${!isMacro ? `
                <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 16px;">
                    <span>ì´ ê°€ê²©:</span>
                    <span id="totalPrice">
                        ${item.priceGold > 0 ? `<span class="price-gold">${item.priceGold.toLocaleString()}G</span>` : ''}
                        ${item.priceMoney > 0 ? `<span class="price-money">${item.priceMoney.toLocaleString()}M</span>` : ''}
                    </span>
                </div>
                ` : ''}
                ${isMacro ? `
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #718096;">
                    <span>ë³´ìœ  ê³¨ë“œ:</span>
                    <span>${user.gold.toLocaleString()}G</span>
                </div>
                ` : ''}
            </div>
            
            <button class="modal-btn btn-confirm" onclick="purchaseItem()">êµ¬ë§¤í•˜ê¸°</button>
            <button class="modal-btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
        `;
        
        document.getElementById('purchaseModal').style.display = 'flex';
    }
    
    function changeQuantity(delta) {
        selectedQuantity = Math.max(1, Math.min(99, selectedQuantity + delta));
        document.getElementById('quantityInput').value = selectedQuantity;
        updateTotalPrice();
    }
    
    function updateQuantity() {
        selectedQuantity = Math.max(1, Math.min(99, parseInt(document.getElementById('quantityInput').value) || 1));
        document.getElementById('quantityInput').value = selectedQuantity;
        updateTotalPrice();
    }
    
    function updateTotalPrice() {
        if (!selectedItem) return;
        
        const totalGold = selectedItem.priceGold * selectedQuantity;
        const totalMoney = selectedItem.priceMoney * selectedQuantity;
        
        document.getElementById('totalPrice').innerHTML = `
            ${totalGold > 0 ? `<span class="price-gold">${totalGold.toLocaleString()}G</span>` : ''}
            ${totalMoney > 0 ? `<span class="price-money">${totalMoney.toLocaleString()}M</span>` : ''}
        `;
    }
    
    async function purchaseItem() {
        if (!selectedItem) return;
        
        // ë§¤í¬ë¡œëŠ” íŠ¹ë³„ ì²˜ë¦¬
        if (selectedItem.id === 'auto_macro') {
            return purchaseMacro();
        }
        
        const totalGold = selectedItem.priceGold * selectedQuantity;
        const totalMoney = selectedItem.priceMoney * selectedQuantity;
        
        // ì”ì•¡ í™•ì¸
        if (user.gold < totalGold) {
            return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        }
        if (user.money < totalMoney) {
            return alert('ë¨¸ë‹ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        }
        
        try {
            // í™”í ì°¨ê°
            const newGold = user.gold - totalGold;
            const newMoney = user.money - totalMoney;
            
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ gold: newGold, money: newMoney })
                .eq('id', user.id);
            
            if (updateError) throw updateError;
            
            // ê¸°ì¡´ ì•„ì´í…œ í™•ì¸
            const { data: existingItem } = await supabaseClient
                .from('user_items')
                .select('*')
                .eq('user_id', user.id)
                .eq('item_id', selectedItem.id)
                .single();
            
            if (existingItem) {
                // ê¸°ì¡´ ì•„ì´í…œì´ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ ì¦ê°€
                const { error: itemError } = await supabaseClient
                    .from('user_items')
                    .update({ 
                        quantity: existingItem.quantity + selectedQuantity,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existingItem.id);
                
                if (itemError) throw itemError;
            } else {
                // ìƒˆ ì•„ì´í…œ ì¶”ê°€
                const { error: itemError } = await supabaseClient
                    .from('user_items')
                    .insert({
                        user_id: user.id,
                        item_id: selectedItem.id,
                        item_name: selectedItem.name,
                        quantity: selectedQuantity,
                        item_type: currentCategory
                    });
                
                if (itemError) throw itemError;
            }
            
            user.gold = newGold;
            user.money = newMoney;
            updateCurrency();
            closeModal();
            
            alert(`${selectedItem.name} ${selectedQuantity}ê°œë¥¼ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`);
        } catch (e) {
            alert('êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }
    
    // ë§¤í¬ë¡œ êµ¬ë§¤ íŠ¹ë³„ ì²˜ë¦¬
    async function purchaseMacro() {
        // ì´ë¯¸ ë§¤í¬ë¡œë¥¼ ì†Œìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
        if (user.has_macro) {
            alert('ì´ë¯¸ ë§¤í¬ë¡œë¥¼ ì†Œìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!\nê²€ ê°•í™” í˜ì´ì§€ì—ì„œ ë§¤í¬ë¡œ íŒ¨ë„ì„ í™•ì¸í•˜ì„¸ìš”.');
            return;
        }
        
        const totalGold = selectedItem.priceGold;
        
        // ì”ì•¡ í™•ì¸ - ë” ëª…í™•í•œ ë©”ì‹œì§€
        if (user.gold < totalGold) {
            const needed = totalGold - user.gold;
            alert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${totalGold.toLocaleString()}G\në³´ìœ : ${user.gold.toLocaleString()}G\në¶€ì¡±: ${needed.toLocaleString()}G`);
            return;
        }
        
        if (!confirm(`ë§¤í¬ë¡œë¥¼ ${totalGold.toLocaleString()}Gì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜ì‚¬í•­:\nâ€¢ ë§¤í¬ë¡œëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\nâ€¢ êµ¬ë§¤ í›„ í™˜ë¶ˆì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤\nâ€¢ ê²€ ê°•í™” í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`)) {
            return;
        }
        
        // êµ¬ë§¤ ì§„í–‰ ì¤‘ UI ë¹„í™œì„±í™”
        const confirmBtn = document.querySelector('.btn-confirm');
        const originalText = confirmBtn.textContent;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'êµ¬ë§¤ ì¤‘...';
        
        try {
            // íŠ¸ëœì­ì…˜ ì‹œì‘ ì „ ìµœì‹  ì‚¬ìš©ì ë°ì´í„° í™•ì¸
            const { data: latestUser, error: fetchError } = await supabaseClient
                .from('profiles')
                .select('gold, has_macro')
                .eq('id', user.id)
                .single();
            
            if (fetchError) {
                throw new Error('ì‚¬ìš©ì ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: ' + fetchError.message);
            }
            
            // ìµœì‹  ë°ì´í„°ë¡œ ì¬ê²€ì¦
            if (latestUser.has_macro) {
                alert('ì´ë¯¸ ë§¤í¬ë¡œë¥¼ ì†Œìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (latestUser.gold < totalGold) {
                const needed = totalGold - latestUser.gold;
                alert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${totalGold.toLocaleString()}G\në³´ìœ : ${latestUser.gold.toLocaleString()}G\në¶€ì¡±: ${needed.toLocaleString()}G`);
                return;
            }
            
            // í™”í ì°¨ê° ë° ë§¤í¬ë¡œ ì†Œìœ  ì„¤ì • (ì›ìì  ì—…ë°ì´íŠ¸)
            const newGold = latestUser.gold - totalGold;
            
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ 
                    gold: newGold, 
                    has_macro: true 
                })
                .eq('id', user.id)
                .eq('gold', latestUser.gold) // ë‚™ê´€ì  ì ê¸ˆ: ê³¨ë“œê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
                .eq('has_macro', false); // ë§¤í¬ë¡œë¥¼ ì•„ì§ ì†Œìœ í•˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
            
            if (updateError) {
                console.error('ë§¤í¬ë¡œ êµ¬ë§¤ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜:', updateError);
                throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + updateError.message);
            }
            
            // ì—…ë°ì´íŠ¸ ì„±ê³µ í™•ì¸
            const { data: verifyData, error: verifyError } = await supabaseClient
                .from('profiles')
                .select('gold, has_macro')
                .eq('id', user.id)
                .single();
            
            if (verifyError || !verifyData.has_macro || verifyData.gold !== newGold) {
                throw new Error('êµ¬ë§¤ ê²€ì¦ ì‹¤íŒ¨ - íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            user.gold = newGold;
            user.has_macro = true;
            updateCurrency();
            closeModal();
            
            // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì‚¬ìš©ë²• ì•ˆë‚´
            alert('ğŸ¤– ìë™ ê°•í™” ë§¤í¬ë¡œë¥¼ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!\n\nâœ… ë§¤í¬ë¡œëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤\nâœ… ê²€ ê°•í™” í˜ì´ì§€ì—ì„œ ë§¤í¬ë¡œ íŒ¨ë„ì„ í™•ì¸í•˜ì„¸ìš”\nâœ… ëª©í‘œ ë ˆë²¨ì„ ì„¤ì •í•˜ê³  ìë™ ê°•í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n\nğŸ’¡ íŒ: ë§¤í¬ë¡œëŠ” ëª©í‘œ ë ˆë²¨ì— ë„ë‹¬í•˜ê±°ë‚˜ ê²€ì´ íŒŒê´´ë  ë•Œê¹Œì§€ ìë™ìœ¼ë¡œ ê°•í™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
            
            // êµ¬ë§¤ ì™„ë£Œ ë¡œê·¸
            console.log('ë§¤í¬ë¡œ êµ¬ë§¤ ì™„ë£Œ:', {
                userId: user.id,
                paidAmount: totalGold,
                remainingGold: newGold,
                hasMacro: true,
                timestamp: new Date().toISOString()
            });
            
        } catch (e) {
            console.error('ë§¤í¬ë¡œ êµ¬ë§¤ ì˜¤ë¥˜:', e);
            
            // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
            let errorMessage = 'êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (e.message.includes('ë°ì´í„°ë² ì´ìŠ¤')) {
                errorMessage = 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } else if (e.message.includes('ê²€ì¦ ì‹¤íŒ¨')) {
                errorMessage = 'êµ¬ë§¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³¨ë“œê°€ ì°¨ê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            } else if (e.message.includes('ì‚¬ìš©ì ë°ì´í„°')) {
                errorMessage = 'ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            alert(`${errorMessage}\n\nì˜¤ë¥˜ ë‚´ìš©: ${e.message}\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\në¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‚¬ìš©ì ë°ì´í„° ì¬ë™ê¸°í™”
            try {
                const { data: refreshData } = await supabaseClient
                    .from('profiles')
                    .select('gold, has_macro')
                    .eq('id', user.id)
                    .single();
                
                if (refreshData) {
                    user.gold = refreshData.gold;
                    user.has_macro = refreshData.has_macro;
                    updateCurrency();
                }
            } catch (refreshError) {
                console.error('ë°ì´í„° ì¬ë™ê¸°í™” ì‹¤íŒ¨:', refreshError);
            }
        } finally {
            // UI ë³µì›
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }
    }
    
    function closeModal() {
        document.getElementById('purchaseModal').style.display = 'none';
        selectedItem = null;
        selectedQuantity = 1;
    }
    
    init();
</script>
</body>
</html>