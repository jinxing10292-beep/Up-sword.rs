<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•„ì´í…œ - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; padding: 20px 10px; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1a202c; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        
        .content { background: white; padding: 20px; border-radius: 0 0 20px 20px; }
        
        .category-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; }
        .tab-btn.active { background: #2d3748; color: white; border-color: #2d3748; }
        
        .item-list { display: flex; flex-direction: column; gap: 10px; }
        .item-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .item-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        .item-icon { font-size: 24px; }
        .item-details { flex: 1; }
        .item-name { font-size: 14px; font-weight: 700; color: #2d3748; }
        .item-description { font-size: 12px; color: #718096; margin-top: 2px; }
        
        .item-actions { display: flex; align-items: center; gap: 10px; }
        .item-quantity { background: #2d3748; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .use-btn { background: #48bb78; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .use-btn:hover { background: #38a169; }
        .use-btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .refund-btn { background: #f56565; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .refund-btn:hover { background: #e53e3e; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #718096; }
        .empty-icon { font-size: 48px; margin-bottom: 10px; }
        
        .loading { text-align: center; padding: 40px 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2d3748; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“¦ ì•„ì´í…œ</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="location.href='shop.html'" title="ìƒì "><i class="fa-solid fa-shopping-cart"></i></button>
            <button onclick="location.href='index.html'" title="í™ˆìœ¼ë¡œ"><i class="fa-solid fa-house"></i></button>
        </div>
    </div>
    
    <div class="content">
        <div class="category-tabs">
            <button class="tab-btn active" onclick="switchCategory('enhancement')">ê°•í™” ì•„ì´í…œ</button>
            <button class="tab-btn" onclick="switchCategory('protection')">ë³´í˜¸ ì•„ì´í…œ</button>
        </div>
        
        <div id="loadingDiv" class="loading">
            <div class="spinner"></div>
            <p>ì•„ì´í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <div id="contentDiv" style="display: none;">
            <div class="item-list" id="itemList"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“¦</div>
                <p>ë³´ìœ í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <button onclick="location.href='shop.html'" style="margin-top: 15px; padding: 10px 20px; background: #2d3748; color: white; border: none; border-radius: 10px; cursor: pointer;">ìƒì ì—ì„œ êµ¬ë§¤í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let userItems = [];
    let currentCategory = 'enhancement';
    
    // ì•„ì´í…œ ì •ë³´ ë§¤í•‘
    const ITEM_INFO = {
        'enhance_scroll_1': { icon: 'ğŸ“œ', name: 'í™•ì • ê°•í™”ê¶Œ (1~5ê°•)', description: '1~5ê°• êµ¬ê°„ 100% ì„±ê³µ' },
        'enhance_scroll_2': { icon: 'ğŸ“œ', name: 'í™•ì • ê°•í™”ê¶Œ (6~10ê°•)', description: '6~10ê°• êµ¬ê°„ 100% ì„±ê³µ' },
        'enhance_scroll_3': { icon: 'ğŸ“œ', name: 'í™•ì • ê°•í™”ê¶Œ (11~15ê°•)', description: '11~15ê°• êµ¬ê°„ 100% ì„±ê³µ' },
        'enhance_scroll_4': { icon: 'ğŸ“œ', name: 'í™•ì • ê°•í™”ê¶Œ (16~20ê°•)', description: '16~20ê°• êµ¬ê°„ 100% ì„±ê³µ' },
        'protect_scroll_1': { icon: 'ğŸ›¡ï¸', name: 'íŒŒê´´ ë°©ì§€ê¶Œ (1~10ê°•)', description: '1~10ê°• êµ¬ê°„ íŒŒê´´ ë°©ì§€' },
        'protect_scroll_2': { icon: 'ğŸ›¡ï¸', name: 'íŒŒê´´ ë°©ì§€ê¶Œ (11~15ê°•)', description: '11~15ê°• êµ¬ê°„ íŒŒê´´ ë°©ì§€' },
        'protect_scroll_3': { icon: 'ğŸ›¡ï¸', name: 'íŒŒê´´ ë°©ì§€ê¶Œ (16~20ê°•)', description: '16~20ê°• êµ¬ê°„ íŒŒê´´ ë°©ì§€' },
        'maintain_scroll_1': { icon: 'âš¡', name: 'ë ˆë²¨ ìœ ì§€ê¶Œ (11~15ê°•)', description: '11~15ê°• êµ¬ê°„ í•˜ë½/íŒŒê´´ ë°©ì§€' },
        'maintain_scroll_2': { icon: 'âš¡', name: 'ë ˆë²¨ ìœ ì§€ê¶Œ (16~20ê°•)', description: '16~20ê°• êµ¬ê°„ í•˜ë½/íŒŒê´´ ë°©ì§€' }
    };
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            await loadUserItems();
            
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('contentDiv').style.display = 'block';
            renderItems();
        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').innerHTML = '<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
    
    async function loadUserItems() {
        try {
            const { data } = await supabaseClient
                .from('user_items')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            userItems = data || [];
        } catch (e) {
            console.log('user_items í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
            userItems = [];
        }
    }
    
    function switchCategory(category) {
        currentCategory = category;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderItems();
    }
    
    function renderItems() {
        const filteredItems = userItems.filter(item => item.item_type === currentCategory);
        const list = document.getElementById('itemList');
        const empty = document.getElementById('emptyState');
        
        if (filteredItems.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        
        empty.style.display = 'none';
        list.innerHTML = filteredItems.map(item => {
            const info = ITEM_INFO[item.item_id] || { icon: 'â“', name: item.item_name, description: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ' };
            
            return `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-icon">${info.icon}</div>
                        <div class="item-details">
                            <div class="item-name">${info.name}</div>
                            <div class="item-description">${info.description}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <div class="item-quantity">${item.quantity}ê°œ</div>
                        <button class="use-btn" onclick="useItem('${item.item_id}', ${item.id})">ì‚¬ìš©</button>
                        <button class="refund-btn" onclick="refundItem('${item.item_id}', ${item.id}, '${info.name}')">í™˜ë¶ˆ</button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function useItem(itemId, userItemId) {
        if (!confirm('ì´ ì•„ì´í…œì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê²€ ê°•í™” í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) return;
        
        // ì•„ì´í…œ ì‚¬ìš©ì„ ìœ„í•´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        sessionStorage.setItem('useItemId', itemId);
        sessionStorage.setItem('userItemId', userItemId);
        
        // ê²€ ê°•í™” í˜ì´ì§€ë¡œ ì´ë™
        location.href = 'sword.html';
    }
    
    async function refundItem(itemId, userItemId, itemName) {
        if (!confirm(`${itemName}ì„(ë¥¼) í™˜ë¶ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nêµ¬ë§¤ ê°€ê²©ì˜ 80%ê°€ í™˜ë¶ˆë©ë‹ˆë‹¤.`)) return;
        
        try {
            // ì•„ì´í…œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const { data: item } = await supabaseClient
                .from('user_items')
                .select('*')
                .eq('id', userItemId)
                .single();
            
            if (!item) {
                alert('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í™˜ë¶ˆ ê°€ê²© ê³„ì‚° (ìƒì  ê°€ê²©ì˜ 80%)
            const refundPrice = getRefundPrice(itemId);
            if (refundPrice.gold === 0 && refundPrice.money === 0) {
                alert('í™˜ë¶ˆí•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.');
                return;
            }
            
            // í™˜ë¶ˆ ì²˜ë¦¬
            const totalRefundGold = refundPrice.gold * item.quantity;
            const totalRefundMoney = refundPrice.money * item.quantity;
            
            // ê³¨ë“œ/ë¨¸ë‹ˆ ì§€ê¸‰
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ 
                    gold: user.gold + totalRefundGold,
                    money: user.money + totalRefundMoney
                })
                .eq('id', user.id);
            
            if (updateError) throw updateError;
            
            // ì•„ì´í…œ ì‚­ì œ
            const { error: deleteError } = await supabaseClient
                .from('user_items')
                .delete()
                .eq('id', userItemId);
            
            if (deleteError) throw deleteError;
            
            // UI ì—…ë°ì´íŠ¸
            user.gold += totalRefundGold;
            user.money += totalRefundMoney;
            
            alert(`í™˜ë¶ˆ ì™„ë£Œ!\n${totalRefundGold > 0 ? `+${totalRefundGold.toLocaleString()}G` : ''}${totalRefundMoney > 0 ? ` +${totalRefundMoney.toLocaleString()}M` : ''}`);
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
            
        } catch (e) {
            alert('í™˜ë¶ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }
    
    function getRefundPrice(itemId) {
        // ìƒì  ê°€ê²©ì˜ 80% í™˜ë¶ˆ
        const shopPrices = {
            'enhance_scroll_1': { gold: 255000, money: 0 },
            'enhance_scroll_2': { gold: 1912500, money: 0 },
            'enhance_scroll_3': { gold: 10200000, money: 0 },
            'enhance_scroll_4': { gold: 0, money: 10200 },
            'protect_scroll_1': { gold: 63750, money: 0 },
            'protect_scroll_2': { gold: 1020000, money: 0 },
            'protect_scroll_3': { gold: 0, money: 1530 },
            'maintain_scroll_1': { gold: 3187500, money: 0 },
            'maintain_scroll_2': { gold: 0, money: 8031 }
        };
        
        const price = shopPrices[itemId];
        if (!price) return { gold: 0, money: 0 };
        
        return {
            gold: Math.floor(price.gold * 0.8),
            money: Math.floor(price.money * 0.8)
        };
    }
    
    init();
</script>
</body>
</html>