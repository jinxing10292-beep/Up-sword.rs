<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë°°í‹€ - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; padding: 20px 10px; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1a202c; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        
        .content { background: white; padding: 20px; border-radius: 0 0 20px 20px; }
        
        .battle-setup { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 14px; font-weight: 700; color: #2d3748; }
        .form-select { padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; }
        
        .btn-start { width: 100%; padding: 15px; background: #2d3748; color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-start:hover { background: #1a202c; }
        .btn-start:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .battle-log { background: #f8fafc; border-radius: 12px; padding: 15px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .log-title { font-size: 14px; font-weight: 700; color: #2d3748; margin-bottom: 10px; }
        .log-entry { font-size: 12px; color: #4a5568; padding: 8px; border-bottom: 1px solid #e2e8f0; line-height: 1.5; }
        .log-entry:last-child { border-bottom: none; }
        .log-entry.player1 { color: #2d3748; font-weight: 600; }
        .log-entry.player2 { color: #718096; }
        .log-entry.result { background: #edf2f7; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: 700; text-align: center; }
        
        .battle-result { background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 15px; margin-top: 20px; text-align: center; }
        .result-title { font-size: 18px; font-weight: 800; color: #22543d; margin-bottom: 10px; }
        .result-detail { font-size: 14px; color: #22543d; margin-bottom: 5px; }
        
        .loading { text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2d3748; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 30px 20px; color: #718096; }
        .empty-icon { font-size: 40px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš”ï¸ ë°°í‹€</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="location.href='battle_history.html'" title="ë°°í‹€ ê¸°ë¡"><i class="fa-solid fa-history"></i></button>
            <button onclick="location.href='index.html'" title="í™ˆìœ¼ë¡œ"><i class="fa-solid fa-house"></i></button>
        </div>
    </div>
    
    <div class="content">
        <div id="setupDiv" class="battle-setup">
            <div class="form-group">
                <label class="form-label">ë‚´ ê²€ ì„ íƒ</label>
                <select id="mySwordSelect" class="form-select">
                    <option value="">ê²€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ìƒëŒ€ í”Œë ˆì´ì–´ ì„ íƒ</label>
                <select id="opponentSelect" class="form-select">
                    <option value="">í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <button class="btn-start" id="startBtn" onclick="startBattle()" disabled>ë°°í‹€ ì‹œì‘</button>
        </div>
        
        <div id="battleDiv" style="display: none;">
            <div class="battle-log">
                <div class="log-title">âš”ï¸ ë°°í‹€ ë¡œê·¸</div>
                <div id="logContent"></div>
            </div>
            
            <div id="resultDiv" style="display: none;" class="battle-result">
                <div class="result-title" id="resultTitle"></div>
                <div class="result-detail" id="resultDetail"></div>
            </div>
            
            <button class="btn-start" onclick="location.reload()" style="margin-top: 20px;">ë‹¤ì‹œ ë°°í‹€í•˜ê¸°</button>
        </div>
        
        <div id="loadingDiv" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let userSwords = [];
    let allUsers = [];
    let swordDataMap = {};
    
    async function init() {
        try {
            document.getElementById('loadingDiv').style.display = 'block';
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            // ê²€ ë°ì´í„° ë¡œë“œ
            const swordData = await fetch('sword_names.json').then(r => r.json());
            swordData.swords.forEach(s => swordDataMap[s.id] = s);
            
            // ì‚¬ìš©ì ê²€ ë¡œë“œ
            const { data: swords } = await supabaseClient
                .from('user_swords')
                .select('*')
                .eq('user_id', user.id);
            
            userSwords = swords || [];
            
            // ê²€ì„ ê°€ì§„ í”Œë ˆì´ì–´ë§Œ ë¡œë“œ
            try {
                // ë¨¼ì € user_swordsì—ì„œ ê²€ì„ ê°€ì§„ ìœ ì € ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { data: swordOwners, error: swordError } = await supabaseClient
                    .from('user_swords')
                    .select('user_id')
                    .neq('user_id', user.id);
                
                if (swordError) throw swordError;
                
                // ì¤‘ë³µ ì œê±°
                const uniqueUserIds = [...new Set((swordOwners || []).map(s => s.user_id))];
                
                if (uniqueUserIds.length === 0) {
                    allUsers = [];
                } else {
                    // í•´ë‹¹ ìœ ì €ë“¤ì˜ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const { data: profiles, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('id, nickname')
                        .in('id', uniqueUserIds)
                        .limit(100);
                    
                    if (profileError) throw profileError;
                    
                    allUsers = (profiles || []).map(p => ({
                        id: p.id,
                        nickname: p.nickname || p.id
                    }));
                }
            } catch (error) {
                console.error('ìœ ì € ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë“  ìœ ì € í‘œì‹œ
                const { data: allProfiles } = await supabaseClient
                    .from('profiles')
                    .select('id, nickname')
                    .neq('id', user.id)
                    .limit(50);
                
                allUsers = (allProfiles || []).map(p => ({
                    id: p.id,
                    nickname: p.nickname || p.id
                }));
            }
            
            document.getElementById('loadingDiv').style.display = 'none';
            populateSelects();
        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').innerHTML = '<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
    
    function populateSelects() {
        // ë‚´ ê²€ ì„ íƒ
        const mySwordSelect = document.getElementById('mySwordSelect');
        if (userSwords.length === 0) {
            mySwordSelect.innerHTML = '<option value="">ë³´ìœ í•œ ê²€ì´ ì—†ìŠµë‹ˆë‹¤</option>';
        } else {
            mySwordSelect.innerHTML = '<option value="">ê²€ì„ ì„ íƒí•˜ì„¸ìš”</option>' + userSwords.map(s => 
                `<option value="${s.id}">${s.sword_name} (Lv. ${s.sword_level})</option>`
            ).join('');
        }
        
        // ìƒëŒ€ í”Œë ˆì´ì–´ ì„ íƒ
        const opponentSelect = document.getElementById('opponentSelect');
        if (allUsers.length === 0) {
            opponentSelect.innerHTML = '<option value="">ê²€ì„ ê°€ì§„ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
        } else {
            opponentSelect.innerHTML = '<option value="">í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + allUsers.map(u => 
                `<option value="${u.id}">${u.nickname || 'ìµëª…'}</option>`
            ).join('');
        }
        
        // ì„ íƒ ì´ë²¤íŠ¸
        mySwordSelect.addEventListener('change', updateStartBtn);
        opponentSelect.addEventListener('change', updateStartBtn);
    }
    
    function updateStartBtn() {
        const mySword = document.getElementById('mySwordSelect').value;
        const opponent = document.getElementById('opponentSelect').value;
        document.getElementById('startBtn').disabled = !mySword || !opponent;
    }
    
    async function startBattle() {
        const mySwordId = parseInt(document.getElementById('mySwordSelect').value);
        const opponentId = document.getElementById('opponentSelect').value;
        
        const mySword = userSwords.find(s => s.id === mySwordId);
        if (!mySword) return alert('ê²€ì„ ì„ íƒí•˜ì„¸ìš”');
        
        // ìƒëŒ€ ê²€ ëœë¤ ì„ íƒ
        const { data: opponentSwords } = await supabaseClient
            .from('user_swords')
            .select('*')
            .eq('user_id', opponentId);
        
        if (!opponentSwords || opponentSwords.length === 0) {
            return alert('ìƒëŒ€ í”Œë ˆì´ì–´ê°€ ê²€ì„ ë³´ìœ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        const opponentSword = opponentSwords[Math.floor(Math.random() * opponentSwords.length)];
        
        // ë°°í‹€ ì‹œë®¬ë ˆì´ì…˜
        document.getElementById('setupDiv').style.display = 'none';
        document.getElementById('battleDiv').style.display = 'block';
        
        const battleResult = generateBattleLog(mySword, opponentSword);
        await saveBattleResult(mySword, opponentSword, opponentId, battleResult);
        displayBattleLog(battleResult.log, battleResult.winner);
    }
    
    function generateBattleLog(sword1, sword2) {
        const log = [];
        const actions = [
            'ê°•ë ¥í•œ ë² ê¸°',
            'ì¬ë¹ ë¥¸ ì°Œë¥´ê¸°',
            'íšŒì „ ë² ê¸°',
            'ë‚´ë ¤ì°ê¸°',
            'ì˜† ë² ê¸°',
            'ì—°ì† ê³µê²©',
            'í•„ì‚´ê¸° ë°œë™'
        ];
        
        let hp1 = 100 + sword1.sword_level * 10;
        let hp2 = 100 + sword2.sword_level * 10;
        let turn = 0;
        let winner = null;
        
        log.push(`âš”ï¸ ${sword1.sword_name} (Lv. ${sword1.sword_level}) vs ${sword2.sword_name} (Lv. ${sword2.sword_level})`);
        log.push(`HP: ${hp1} vs ${hp2}`);
        log.push('---');
        
        while (hp1 > 0 && hp2 > 0 && turn < 20) {
            // í”Œë ˆì´ì–´ 1 ê³µê²©
            const action1 = actions[Math.floor(Math.random() * actions.length)];
            const damage1 = Math.floor(Math.random() * 20) + 10 + sword1.sword_level * 2;
            hp2 -= damage1;
            log.push(`[í„´ ${turn + 1}] ${sword1.sword_name}: ${action1}! (${damage1} ë°ë¯¸ì§€)`);
            log.push(`${sword2.sword_name} HP: ${Math.max(0, hp2)}`);
            
            if (hp2 <= 0) {
                winner = 'player1';
                break;
            }
            
            // í”Œë ˆì´ì–´ 2 ê³µê²©
            const action2 = actions[Math.floor(Math.random() * actions.length)];
            const damage2 = Math.floor(Math.random() * 20) + 10 + sword2.sword_level * 2;
            hp1 -= damage2;
            log.push(`[í„´ ${turn + 1}] ${sword2.sword_name}: ${action2}! (${damage2} ë°ë¯¸ì§€)`);
            log.push(`${sword1.sword_name} HP: ${Math.max(0, hp1)}`);
            
            if (hp1 <= 0) {
                winner = 'player2';
                break;
            }
            
            turn++;
        }
        
        log.push('---');
        if (winner === 'player1') {
            log.push(`ğŸ‰ ${sword1.sword_name} ìŠ¹ë¦¬!`);
        } else if (winner === 'player2') {
            log.push(`ğŸ‰ ${sword2.sword_name} ìŠ¹ë¦¬!`);
        } else {
            log.push('â° ë¬´ìŠ¹ë¶€! (ì‹œê°„ ì´ˆê³¼)');
        }
        
        return { log, winner, finalHp1: Math.max(0, hp1), finalHp2: Math.max(0, hp2) };
    }
    
    async function saveBattleResult(mySword, opponentSword, opponentId, battleResult) {
        try {
            const winnerId = battleResult.winner === 'player1' ? user.id : 
                           battleResult.winner === 'player2' ? opponentId : null;
            
            // ë°°í‹€ ê¸°ë¡ ì €ì¥
            const { data: battle, error: battleError } = await supabaseClient
                .from('battles')
                .insert({
                    player1_id: user.id,
                    player2_id: opponentId,
                    player1_sword_id: mySword.id,
                    player2_sword_id: opponentSword.id,
                    winner_id: winnerId,
                    battle_log: JSON.stringify(battleResult.log)
                })
                .select()
                .single();
            
            if (battleError) throw battleError;
            
            // ë°°í‹€ ë¡œê·¸ ìƒì„¸ ì €ì¥
            const logEntries = battleResult.log.map((entry, index) => ({
                battle_id: battle.id,
                step: index,
                action: entry,
                damage: 0, // ë°ë¯¸ì§€ íŒŒì‹± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                result: index === battleResult.log.length - 1 ? battleResult.winner : null
            }));
            
            const { error: logError } = await supabaseClient
                .from('battle_logs')
                .insert(logEntries);
            
            if (logError) throw logError;
            
            console.log('ë°°í‹€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
            console.error('ë°°í‹€ ì €ì¥ ì˜¤ë¥˜:', e);
        }
    }
    
    function displayBattleLog(log, winner) {
        const logContent = document.getElementById('logContent');
        logContent.innerHTML = log.map((entry, idx) => {
            let className = '';
            if (entry.includes('vs')) className = 'log-entry';
            else if (entry.includes('í„´')) className = 'log-entry player1';
            else if (entry.includes('HP:')) className = 'log-entry player2';
            else if (entry.includes('ìŠ¹ë¦¬') || entry.includes('ë¬´ìŠ¹ë¶€')) className = 'log-entry result';
            else className = 'log-entry';
            
            return `<div class="${className}">${entry}</div>`;
        }).join('');
        
        // ê²°ê³¼ í‘œì‹œ
        const winnerText = log[log.length - 1];
        const resultTitle = document.getElementById('resultTitle');
        const resultDetail = document.getElementById('resultDetail');
        
        resultTitle.innerText = winnerText;
        if (winner === 'player1') {
            resultDetail.innerText = 'ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!';
            resultTitle.style.color = '#22543d';
        } else if (winner === 'player2') {
            resultDetail.innerText = 'ğŸ˜¢ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...';
            resultTitle.style.color = '#e53e3e';
        } else {
            resultDetail.innerText = 'â° ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤.';
            resultTitle.style.color = '#718096';
        }
        
        document.getElementById('resultDiv').style.display = 'block';
    }
    
    init();
</script>
</body>
</html>
