<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°í‹€ - Up Sword</title>
    <link rel="icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { font-size: 28px; font-weight: 900; color: #2d3748; }
        .home-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 900; }
        
        .main-content { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .user-info { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .user-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .user-info-row:last-child { margin-bottom: 0; }
        .info-label { font-size: 14px; color: #718096; font-weight: 600; }
        .info-value { font-size: 16px; color: #2d3748; font-weight: 700; }
        
        .exp-bar-container { margin-top: 10px; }
        .exp-bar-bg { background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; position: relative; }
        .exp-bar-fill { background: linear-gradient(90deg, #48bb78, #38a169); height: 100%; transition: width 0.5s; }
        .exp-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .dummy-selection { margin-bottom: 20px; }
        .dummy-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8fafc; border-radius: 12px; }
        .dummy-card { background: white; border: 3px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .dummy-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dummy-card.selected { border-color: #667eea; background: #f0f4ff; }
        .dummy-card.locked { opacity: 0.5; cursor: not-allowed; }
        .dummy-level { font-size: 20px; font-weight: 900; color: #2d3748; margin-bottom: 5px; }
        .dummy-hp { font-size: 12px; color: #718096; }
        .dummy-reward { font-size: 11px; color: #48bb78; font-weight: 700; margin-top: 5px; }
        
        .battle-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 900; cursor: pointer; transition: 0.2s; margin-top: 20px; }
        .battle-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .battle-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .battle-arena { display: none; }
        .battle-field { display: flex; justify-content: space-around; align-items: center; padding: 30px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: 15px; margin-bottom: 20px; }
        .fighter { text-align: center; }
        .fighter-icon { font-size: 60px; margin-bottom: 10px; }
        .fighter-name { font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 5px; }
        .fighter-hp-bar { width: 150px; height: 25px; background: #e2e8f0; border-radius: 12px; overflow: hidden; position: relative; margin: 10px auto; }
        .fighter-hp-fill { background: linear-gradient(90deg, #f56565, #e53e3e); height: 100%; transition: width 0.3s; }
        .fighter-hp-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700; color: white; }
        
        .battle-log { background: #2d3748; color: white; padding: 20px; border-radius: 12px; max-height: 300px; overflow-y: auto; font-size: 13px; line-height: 1.8; margin-bottom: 20px; }
        .log-entry { margin-bottom: 8px; padding: 5px; border-left: 3px solid #667eea; padding-left: 10px; }
        .log-player { color: #48bb78; }
        .log-dummy { color: #f56565; }
        .log-result { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center; font-weight: 700; margin-top: 10px; }
        
        .result-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .result-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .result-icon { font-size: 80px; margin-bottom: 20px; }
        .result-title { font-size: 32px; font-weight: 900; margin-bottom: 15px; }
        .result-win { color: #48bb78; }
        .result-lose { color: #f56565; }
        .result-rewards { background: #f8fafc; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .reward-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .reward-item:last-child { margin-bottom: 0; }
        .reward-label { color: #718096; }
        .reward-value { font-weight: 700; color: #2d3748; }
        .close-btn { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h1>âš”ï¸ ë°°í‹€ ì•„ë ˆë‚˜</h1>
            <button class="home-btn" onclick="location.href='home.html'">
                <i class="fas fa-home"></i> í™ˆ
            </button>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ë°°í‹€ ë ˆë²¨</div>
                <div class="stat-value" id="battleLevel">1</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ë°°í‹€ ì½”ì¸</div>
                <div class="stat-value" id="battleCoins">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœê³  ê²©íŒŒ</div>
                <div class="stat-value" id="highestDummy">0</div>
            </div>
        </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px;">
        <button class="home-btn" onclick="openPvPModal()">PvP ë„ì „</button>
    </div>
    
    <div class="main-content">
        <div class="user-info">
            <div class="user-info-row">
                <span class="info-label">ë‚´ ê²€ ë ˆë²¨</span>
                <span class="info-value" id="mySwordLevel">0</span>
            </div>
            <div class="user-info-row">
                <span class="info-label">ê³µê²©ë ¥</span>
                <span class="info-value" id="myAttack">0</span>
            </div>
            <div class="exp-bar-container">
                <div class="exp-bar-bg">
                    <div class="exp-bar-fill" id="expBarFill" style="width: 0%"></div>
                    <div class="exp-bar-text" id="expBarText">EXP: 0 / 100</div>
                </div>
            </div>
        </div>
        
        <div id="setupArea">
            <h3 style="margin-bottom: 15px; color: #2d3748;">í—ˆìˆ˜ì•„ë¹„ ì„ íƒ</h3>
            <div class="dummy-grid" id="dummyGrid"></div>
            <button class="battle-btn" id="startBattleBtn" onclick="startBattle()" disabled>
                <i class="fas fa-sword"></i> ë°°í‹€ ì‹œì‘
            </button>
        </div>
        
        <div id="battleArea" class="battle-arena">
            <div class="battle-field">
                <div class="fighter">
                    <div class="fighter-icon">ğŸ—¡ï¸</div>
                    <div class="fighter-name" id="playerName">ë‚˜</div>
                    <div class="fighter-hp-bar">
                        <div class="fighter-hp-fill" id="playerHpFill" style="width: 100%"></div>
                        <div class="fighter-hp-text" id="playerHpText">100 / 100</div>
                    </div>
                    <div style="font-size: 12px; color: #718096;">ê³µê²©ë ¥: <span id="playerAtk">0</span></div>
                </div>
                
                <div style="font-size: 40px; color: #cbd5e0;">âš”ï¸</div>
                
                <div class="fighter">
                    <div class="fighter-icon">ğŸ¯</div>
                    <div class="fighter-name" id="dummyName">í—ˆìˆ˜ì•„ë¹„</div>
                    <div class="fighter-hp-bar">
                        <div class="fighter-hp-fill" id="dummyHpFill" style="width: 100%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                        <div class="fighter-hp-text" id="dummyHpText">100 / 100</div>
                    </div>
                    <div style="font-size: 12px; color: #718096;">HP: <span id="dummyHp">0</span></div>
                </div>
            </div>
            
            <div class="battle-log" id="battleLog"></div>
            
            <button class="battle-btn" onclick="location.reload()">
                <i class="fas fa-redo"></i> ë‹¤ì‹œ ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<div class="result-modal" id="resultModal">
    <div class="result-content">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-title" id="resultTitle"></div>
        <div class="result-rewards" id="resultRewards"></div>
        <button class="close-btn" onclick="closeResult()">í™•ì¸</button>
    </div>
</div>

<!-- PvP Challenge Modal -->
<div class="result-modal" id="pvpModal" style="display:none;">
    <div class="result-content">
        <div style="font-size:20px; font-weight:900; margin-bottom:12px;">PvP ë„ì „í•˜ê¸°</div>
        <input id="pvpTarget" placeholder="ìƒëŒ€ ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ ì…ë ¥" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:12px;" />
        <div style="display:flex; gap:8px;">
            <button class="modal-btn btn-confirm" onclick="challengePlayer()">ë„ì „</button>
            <button class="modal-btn btn-cancel" onclick="closePvPModal()">ì·¨ì†Œ</button>
        </div>
        <div id="pvpInfo" style="margin-top:12px; color:#718096; font-size:13px;"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let selectedDummy = null;
    let battleLog = [];
    
    // í—ˆìˆ˜ì•„ë¹„ ë°ì´í„° (ë ˆë²¨ 1~30)
    function getDummyData(level) {
        const baseHp = 50;
        const hpMultiplier = 1.5;
        const hp = Math.floor(baseHp * Math.pow(hpMultiplier, level - 1));
        
        const baseExp = 10;
        const expMultiplier = 1.3;
        const exp = Math.floor(baseExp * Math.pow(expMultiplier, level - 1));
        
        const baseCoins = 5;
        const coinsMultiplier = 1.4;
        const coins = Math.floor(baseCoins * Math.pow(coinsMultiplier, level - 1));
        
        return {
            level: level,
            name: `Lv.${level} í—ˆìˆ˜ì•„ë¹„`,
            hp: hp,
            maxHp: hp,
            exp: exp,
            coins: coins
        };
    }
    
    // ë ˆë²¨ì—…ì— í•„ìš”í•œ ê²½í—˜ì¹˜
    function getRequiredExp(level) {
        return Math.floor(100 * Math.pow(1.5, level - 1));
    }
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                location.href = 'login.html';
                return;
            }
            
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
            
            if (error) throw error;
            
            user = profile;
            
            // ë°°í‹€ ê´€ë ¨ í•„ë“œ ì´ˆê¸°í™”
            if (user.battle_level === null || user.battle_level === undefined) user.battle_level = 1;
            if (user.battle_exp === null || user.battle_exp === undefined) user.battle_exp = 0;
            if (user.battle_coins === null || user.battle_coins === undefined) user.battle_coins = 0;
            if (user.highest_dummy_defeated === null || user.highest_dummy_defeated === undefined) user.highest_dummy_defeated = 0;
            
            updateUI();
            renderDummies();
            
        } catch (e) {
            console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
            alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }
    
    function updateUI() {
        document.getElementById('battleLevel').textContent = user.battle_level;
        document.getElementById('battleCoins').textContent = user.battle_coins.toLocaleString();
        document.getElementById('highestDummy').textContent = user.highest_dummy_defeated;
        
        document.getElementById('mySwordLevel').textContent = `+${user.current_sword_lvl}`;
        const attack = 10 + (user.current_sword_lvl * 5);
        document.getElementById('myAttack').textContent = attack;
        
        // ê²½í—˜ì¹˜ ë°” ì—…ë°ì´íŠ¸
        const requiredExp = getRequiredExp(user.battle_level);
        const expPercent = (user.battle_exp / requiredExp) * 100;
        document.getElementById('expBarFill').style.width = expPercent + '%';
        document.getElementById('expBarText').textContent = `EXP: ${user.battle_exp} / ${requiredExp}`;
    }
    
    function renderDummies() {
        const grid = document.getElementById('dummyGrid');
        grid.innerHTML = '';
        
        for (let i = 1; i <= 30; i++) {
            const dummy = getDummyData(i);
            const isLocked = i > user.highest_dummy_defeated + 1;
            
            const card = document.createElement('div');
            card.className = 'dummy-card' + (isLocked ? ' locked' : '');
            card.innerHTML = `
                <div class="dummy-level">Lv.${dummy.level}</div>
                <div class="dummy-hp">HP: ${dummy.hp.toLocaleString()}</div>
                <div class="dummy-reward">
                    ğŸ’ ${dummy.coins} ì½”ì¸<br>
                    â­ ${dummy.exp} EXP
                </div>
                ${isLocked ? '<div style="margin-top: 5px; font-size: 20px;">ğŸ”’</div>' : ''}
            `;
            
            if (!isLocked) {
                card.onclick = () => selectDummy(dummy);
            }
            
            grid.appendChild(card);
        }
    }
    
    function selectDummy(dummy) {
        selectedDummy = dummy;
        
        // ëª¨ë“  ì¹´ë“œ ì„ íƒ í•´ì œ
        document.querySelectorAll('.dummy-card').forEach(c => c.classList.remove('selected'));
        
        // ì„ íƒëœ ì¹´ë“œ í‘œì‹œ
        event.target.closest('.dummy-card').classList.add('selected');
        
        document.getElementById('startBattleBtn').disabled = false;
    }
    
    async function startBattle() {
        if (!selectedDummy) return;
        
        // UI ì „í™˜
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('battleArea').style.display = 'block';
        
        // ì „íˆ¬ ì´ˆê¸°í™”
        const playerAttack = 10 + (user.current_sword_lvl * 5);
        const playerMaxHp = 100 + (user.battle_level * 20);
        let playerHp = playerMaxHp;
        let dummyHp = selectedDummy.hp;
        
        battleLog = [];
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('playerName').textContent = user.nickname || 'í”Œë ˆì´ì–´';
        document.getElementById('playerAtk').textContent = playerAttack;
        document.getElementById('dummyName').textContent = selectedDummy.name;
        document.getElementById('dummyHp').textContent = selectedDummy.hp.toLocaleString();
        
        updateBattleUI(playerHp, playerMaxHp, dummyHp, selectedDummy.maxHp);
        
        // ì „íˆ¬ ì‹œì‘
        addLog(`âš”ï¸ ${selectedDummy.name}ê³¼(ì™€)ì˜ ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
        let turn = 1;
        const maxTurns = 50; // ë¬´í•œ ë£¨í”„ ë°©ì§€
        
        while (playerHp > 0 && dummyHp > 0 && turn <= maxTurns) {
            await sleep(800);
            
            // í”Œë ˆì´ì–´ ê³µê²©
            const playerDamage = Math.floor(playerAttack * (0.9 + Math.random() * 0.2)); // 90~110%
            dummyHp -= playerDamage;
            addLog(`ğŸ—¡ï¸ ë‹¹ì‹ ì˜ ê³µê²©! ${playerDamage} ë°ë¯¸ì§€!`, 'player');
            updateBattleUI(playerHp, playerMaxHp, Math.max(0, dummyHp), selectedDummy.maxHp);
            
            if (dummyHp <= 0) {
                await sleep(500);
                addLog(`ğŸ‰ ${selectedDummy.name}ì„(ë¥¼) ê²©íŒŒí–ˆìŠµë‹ˆë‹¤!`, 'result');
                await handleVictory();
                return;
            }
            
            await sleep(800);
            
            // í—ˆìˆ˜ì•„ë¹„ ë°˜ê²© (ì•½í•œ ê³ ì • ë°ë¯¸ì§€)
            const dummyDamage = Math.floor(5 + selectedDummy.level * 2);
            playerHp -= dummyDamage;
            addLog(`ğŸ¯ í—ˆìˆ˜ì•„ë¹„ì˜ ë°˜ê²©! ${dummyDamage} ë°ë¯¸ì§€!`, 'dummy');
            updateBattleUI(Math.max(0, playerHp), playerMaxHp, dummyHp, selectedDummy.maxHp);
            
            if (playerHp <= 0) {
                await sleep(500);
                addLog(`ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...`, 'result');
                await handleDefeat();
                return;
            }
            
            turn++;
        }
        
        // ìµœëŒ€ í„´ ë„ë‹¬ (ë¬´ìŠ¹ë¶€ ì²˜ë¦¬ - íŒ¨ë°°ë¡œ ê°„ì£¼)
        if (turn > maxTurns) {
            addLog(`â±ï¸ ì‹œê°„ ì´ˆê³¼! íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤.`, 'result');
            await handleDefeat();
        }
    }
    
    function updateBattleUI(playerHp, playerMaxHp, dummyHp, dummyMaxHp) {
        const playerPercent = (playerHp / playerMaxHp) * 100;
        const dummyPercent = (dummyHp / dummyMaxHp) * 100;
        
        document.getElementById('playerHpFill').style.width = playerPercent + '%';
        document.getElementById('playerHpText').textContent = `${Math.max(0, playerHp)} / ${playerMaxHp}`;
        
        document.getElementById('dummyHpFill').style.width = dummyPercent + '%';
        document.getElementById('dummyHpText').textContent = `${Math.max(0, dummyHp)} / ${dummyMaxHp}`;
    }
    
    function addLog(message, type = '') {
        battleLog.push({ message, type });
        const logDiv = document.getElementById('battleLog');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        if (type === 'player') entry.classList.add('log-player');
        if (type === 'dummy') entry.classList.add('log-dummy');
        if (type === 'result') entry.classList.add('log-result');
        entry.textContent = message;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    async function handleVictory() {
        try {
            const expGained = selectedDummy.exp;
            const coinsGained = selectedDummy.coins;
            
            let newExp = user.battle_exp + expGained;
            let prevLevel = user.battle_level;
            let newLevel = prevLevel;
            let leveledUp = false;
            
            // ë ˆë²¨ì—… ì²´í¬
            let requiredExp = getRequiredExp(newLevel);
            while (newExp >= requiredExp) {
                newExp -= requiredExp;
                newLevel++;
                leveledUp = true;
                requiredExp = getRequiredExp(newLevel);
            }
            
            const newCoins = user.battle_coins + coinsGained;
            const newHighest = Math.max(user.highest_dummy_defeated, selectedDummy.level);
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({
                    battle_exp: newExp,
                    battle_level: newLevel,
                    battle_coins: newCoins,
                    highest_dummy_defeated: newHighest
                })
                .eq('id', user.id)
                .select();
            
            if (updateError) throw updateError;
            
            // ë°°í‹€ ê¸°ë¡ ì €ì¥
            const { error: historyError } = await supabaseClient
                .from('battle_history')
                .insert({
                    user_id: user.id,
                    dummy_level: selectedDummy.level,
                    user_sword_level: user.current_sword_lvl,
                    user_attack: 10 + (user.current_sword_lvl * 5),
                    dummy_hp: selectedDummy.hp,
                    result: 'win',
                    exp_gained: expGained,
                    coins_gained: coinsGained,
                    battle_log: battleLog
                })
                .select();
            
            if (historyError) console.error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', historyError);
            
            // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
            user.battle_exp = newExp;
            user.battle_level = newLevel;
            user.battle_coins = newCoins;
            user.highest_dummy_defeated = newHighest;
            
            updateUI();
            
            // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ (prevLevel í¬í•¨)
            showResultModal(true, expGained, coinsGained, leveledUp, prevLevel, newLevel, { type: 'pve' });
            
        } catch (e) {
            console.error('ìŠ¹ë¦¬ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
            alert('ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }
    
    async function handleDefeat() {
        try {
            // íŒ¨ë°° ì‹œ ë³´ìƒ ì—†ìŒ, ê¸°ë¡ë§Œ ì €ì¥
            const { error: historyError } = await supabaseClient
                .from('battle_history')
                .insert({
                    user_id: user.id,
                    dummy_level: selectedDummy.level,
                    user_sword_level: user.current_sword_lvl,
                    user_attack: 10 + (user.current_sword_lvl * 5),
                    dummy_hp: selectedDummy.hp,
                    result: 'lose',
                    exp_gained: 0,
                    coins_gained: 0,
                    battle_log: battleLog
                })
                .select();
            
            if (historyError) console.error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', historyError);
            
            // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
            showResultModal(false, 0, 0, false, user.battle_level || 1, user.battle_level || 1);
            
        } catch (e) {
            console.error('íŒ¨ë°° ì²˜ë¦¬ ì˜¤ë¥˜:', e);
        }
    }
    
    function showResultModal(isWin, exp, coins, leveledUp, prevLevel, newLevel, extra) {
        const modal = document.getElementById('resultModal');
        const icon = document.getElementById('resultIcon');
        const title = document.getElementById('resultTitle');
        const rewards = document.getElementById('resultRewards');
        
        if (isWin) {
            icon.textContent = 'ğŸ‰';
            title.textContent = 'ìŠ¹ë¦¬!';
            title.className = 'result-title result-win';
            
            let rewardsHTML = `
                <div class="reward-item">
                    <span class="reward-label">íšë“ ê²½í—˜ì¹˜</span>
                    <span class="reward-value">+${exp} EXP</span>
                </div>
                <div class="reward-item">
                    <span class="reward-label">íšë“ ì½”ì¸</span>
                    <span class="reward-value">+${coins} ğŸ’</span>
                </div>
            `;
            
            if (leveledUp) {
                // show animated stat increases
                const prevAtk = 10 + (prevLevel * 5);
                const newAtk = 10 + (newLevel * 5);
                const prevHp = 100 + (prevLevel * 20);
                const newHp = 100 + (newLevel * 20);

                rewardsHTML += `
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 12px; border-radius: 10px; margin-top: 12px; text-align:center;">
                        <div style="font-weight:900; color:#2d3748;">ğŸŠ ë ˆë²¨ ì—…! Lv.${newLevel}</div>
                        <div style="display:flex; justify-content:space-around; margin-top:8px;">
                            <div>
                                <div style="font-size:12px; color:#2d3748;">ê³µê²©ë ¥</div>
                                <div id="animAtk" style="font-size:20px; font-weight:900; color:#000;">${prevAtk}</div>
                            </div>
                            <div>
                                <div style="font-size:12px; color:#2d3748;">ì²´ë ¥</div>
                                <div id="animHp" style="font-size:20px; font-weight:900; color:#000;">${prevHp}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            rewards.innerHTML = rewardsHTML;

            // Animate the stat numbers if leveled up
            if (leveledUp) {
                const atkEl = document.getElementById('animAtk');
                const hpEl = document.getElementById('animHp');
                if (atkEl && hpEl) {
                    const steps = 30;
                    let step = 0;
                    const atkStart = prevAtk;
                    const hpStart = prevHp;
                    const atkDiff = newAtk - prevAtk;
                    const hpDiff = newHp - prevHp;
                    const interval = setInterval(() => {
                        step++;
                        const t = step / steps;
                        atkEl.textContent = Math.floor(atkStart + atkDiff * easeOutCubic(t));
                        hpEl.textContent = Math.floor(hpStart + hpDiff * easeOutCubic(t));
                        if (step >= steps) clearInterval(interval);
                    }, 20);
                    // small confetti effect
                    burstParticles(40);
                }
            }
        } else {
            icon.textContent = 'ğŸ’€';
            title.textContent = 'íŒ¨ë°°...';
            title.className = 'result-title result-lose';
            rewards.innerHTML = `
                <p style="color: #718096; margin: 20px 0;">ë” ê°•í•œ ê²€ìœ¼ë¡œ ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!</p>
            `;
        }
        
        modal.style.display = 'flex';
    }
    
    function closeResult() {
        document.getElementById('resultModal').style.display = 'none';
        location.reload();
    }
    
    window.onload = init;

    // PvP modal controls
    function openPvPModal() {
        document.getElementById('pvpModal').style.display = 'flex';
        document.getElementById('pvpTarget').value = '';
        document.getElementById('pvpInfo').innerText = '';
    }
    function closePvPModal() { document.getElementById('pvpModal').style.display = 'none'; }

    async function challengePlayer() {
        const q = document.getElementById('pvpTarget').value.trim();
        if (!q) return alert('ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

        try {
            // Try to find by nickname or email
            const { data: target, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .or(`nickname.eq.${q},email.eq.${q}`)
                .maybeSingle();

            if (error || !target) return alert('ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

            // Basic checks: both players must have at least one sword in inventory and battle_level >= 2
            const [{ data: mySwords }, { data: theirSwords }] = await Promise.all([
                supabaseClient.from('user_swords').select('id').eq('user_id', user.id).limit(1),
                supabaseClient.from('user_swords').select('id').eq('user_id', target.id).limit(1)
            ]);

            if (!mySwords || mySwords.length === 0) return alert('ë‹¹ì‹ ì˜ ì¸ë²¤í† ë¦¬ì— ê²€ì´ ì—†ìŠµë‹ˆë‹¤. ì¸ë²¤í† ë¦¬ì—ì„œ ê²€ì„ ë³´ìœ í•´ì•¼ PvPì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            if (!theirSwords || theirSwords.length === 0) return alert('ìƒëŒ€ì˜ ì¸ë²¤í† ë¦¬ì— ê²€ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.');

            if ((user.battle_level || 1) < 2) return alert('PvP ì°¸ì—¬ë¥¼ ìœ„í•´ ë°°í‹€ ë ˆë²¨ì´ 2 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            if ((target.battle_level || 1) < 2) return alert('ìƒëŒ€ì˜ ë°°í‹€ ë ˆë²¨ì´ 2 ì´ìƒì´ì–´ì•¼ PvPê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');

            // Show confirmation and start PvP
            if (!confirm(`${target.nickname || target.email}ë‹˜ì—ê²Œ ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
ì¡°ê±´: ì„œë¡œ ì¸ë²¤í† ë¦¬ì— ê²€ ë³´ìœ , ë°°í‹€ ë ˆë²¨ 2+`)) return;

            closePvPModal();
            await startPvP(target);

        } catch (e) {
            console.error('PvP ë„ì „ ì˜¤ë¥˜:', e);
            alert('PvP ë„ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    }

    async function startPvP(opponent) {
        // Setup UI
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('battleArea').style.display = 'block';

        const playerAttack = 10 + (user.current_sword_lvl * 5);
        const opponentAttack = 10 + (opponent.current_sword_lvl * 5);
        const playerMaxHp = 100 + ((user.battle_level || 1) * 20);
        const opponentMaxHp = 100 + ((opponent.battle_level || 1) * 20);
        let playerHp = playerMaxHp;
        let oppHp = opponentMaxHp;

        battleLog = [];
        document.getElementById('playerName').textContent = user.nickname || 'í”Œë ˆì´ì–´';
        document.getElementById('playerAtk').textContent = playerAttack;
        document.getElementById('dummyName').textContent = opponent.nickname || opponent.email || 'ìƒëŒ€';
        document.getElementById('dummyHp').textContent = opponentMaxHp;
        updateBattleUI(playerHp, playerMaxHp, oppHp, opponentMaxHp);

        addLog(`ğŸ¤ PvP ì‹œì‘: ${user.nickname || user.email} vs ${opponent.nickname || opponent.email}`);

        let turn = 1;
        while (playerHp > 0 && oppHp > 0 && turn <= 100) {
            await sleep(700);
            const playerDamage = Math.floor(playerAttack * (0.9 + Math.random() * 0.25));
            oppHp -= playerDamage;
            addLog(`ğŸ—¡ï¸ ë‹¹ì‹ ì˜ ê³µê²©! ${playerDamage} ë°ë¯¸ì§€!`, 'player');
            updateBattleUI(playerHp, playerMaxHp, Math.max(0, oppHp), opponentMaxHp);
            if (oppHp <= 0) { await sleep(400); addLog(`ğŸ† ìƒëŒ€ ê²©íŒŒ!`, 'result'); await handlePvPVictory(opponent); return; }

            await sleep(700);
            const oppDamage = Math.floor(opponentAttack * (0.85 + Math.random() * 0.3));
            playerHp -= oppDamage;
            addLog(`ğŸ›¡ï¸ ìƒëŒ€ì˜ ê³µê²©! ${oppDamage} ë°ë¯¸ì§€!`, 'dummy');
            updateBattleUI(Math.max(0, playerHp), playerMaxHp, oppHp, opponentMaxHp);
            if (playerHp <= 0) { await sleep(400); addLog(`ğŸ’€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...`, 'result'); await handleDefeat(); return; }

            turn++;
        }
        if (turn > 100) { addLog('â±ï¸ ì‹œê°„ ì´ˆê³¼ - ë¬´ìŠ¹ë¶€ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.', 'result'); await handleDefeat(); }
    }

    async function handlePvPVictory(opponent) {
        try {
            // rewards based on opponent's battle level
            const expGained = (opponent.battle_level || 1) * 20;
            const coinsGained = (opponent.battle_level || 1) * 10;

            let newExp = user.battle_exp + expGained;
            let prevLevel = user.battle_level;
            let newLevel = prevLevel;
            let leveledUp = false;
            let requiredExp = getRequiredExp(newLevel);
            while (newExp >= requiredExp) { newExp -= requiredExp; newLevel++; leveledUp = true; requiredExp = getRequiredExp(newLevel); }

            const newCoins = (user.battle_coins || 0) + coinsGained;

            // Update profiles and insert battle history with opponent info
            const { error: updateError } = await supabaseClient.from('profiles').update({
                battle_exp: newExp,
                battle_level: newLevel,
                battle_coins: newCoins
            }).eq('id', user.id).select();
            if (updateError) throw updateError;

            const { error: historyError } = await supabaseClient.from('battle_history').insert({
                user_id: user.id,
                opponent_id: opponent.id,
                dummy_level: opponent.battle_level,
                user_sword_level: user.current_sword_lvl,
                user_attack: 10 + (user.current_sword_lvl * 5),
                dummy_hp: opponent.battle_level,
                result: 'pvp',
                exp_gained: expGained,
                coins_gained: coinsGained,
                battle_log: battleLog
            }).select();
            if (historyError) console.error('PvP ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', historyError);

            user.battle_exp = newExp; user.battle_level = newLevel; user.battle_coins = newCoins;
            updateUI();

            showResultModal(true, expGained, coinsGained, leveledUp, prevLevel, newLevel, { type: 'pvp', opponent });
        } catch (e) {
            console.error('PvP ìŠ¹ë¦¬ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
            alert('ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }

    // small helper: particle burst for level-up
    function burstParticles(count) {
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.style.position = 'fixed';
            p.style.left = (50 + (Math.random() - 0.5) * 30) + '%';
            p.style.top = (40 + Math.random() * 10) + '%';
            p.style.width = (6 + Math.random() * 12) + 'px';
            p.style.height = p.style.width;
            p.style.background = ['#ffd700','#ff8a00','#48bb78','#00ccff'][Math.floor(Math.random()*4)];
            p.style.borderRadius = '50%';
            p.style.zIndex = 2000;
            document.body.appendChild(p);
            const tx = (Math.random()-0.5)*300; const ty = -150 - Math.random()*200;
            p.animate([{ transform: 'translate(0,0)', opacity: 1 }, { transform: `translate(${tx}px, ${ty}px) scale(0.3)`, opacity: 0 }], { duration: 900 + Math.random()*800, easing: 'cubic-bezier(.2,.8,.2,1)' }).onfinish = () => p.remove();
        }
    }

    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
</script>
</body>
</html>