<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Í≤Ä ÎèÑÍ∞ê - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="minigame-responsive.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; padding: 20px 10px; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1a202c; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 800; }
        .header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        
        .filter-section { background: white; padding: 15px; border-radius: 0 0 20px 20px; margin-bottom: 20px; }
        .filter-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 12px; border: 2px solid #ddd; background: white; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
        .filter-btn.active { background: #2d3748; color: white; border-color: #2d3748; }
        
        .search-box { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 12px; font-size: 14px; }
        
        .sword-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .sword-card { background: white; border-radius: 12px; padding: 12px; cursor: pointer; transition: 0.2s; border: 2px solid #eee; }
        .sword-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sword-card.owned { border-color: #48bb78; background: #f0fff4; }
        .sword-card.hidden { border-color: #9f7aea; background: #faf5ff; }
        
        .sword-name { font-size: 12px; font-weight: 700; color: #2d3748; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sword-level { font-size: 11px; color: #718096; margin-bottom: 4px; }
        .sword-rarity { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        
        .rarity-common { background: #e2e8f0; color: #2d3748; }
        .rarity-uncommon { background: #c6f6d5; color: #22543d; }
        .rarity-rare { background: #bee3f8; color: #2c5282; }
        .rarity-epic { background: #d6bcfa; color: #553399; }
        .rarity-legendary { background: #fed7aa; color: #7c2d12; }
        .rarity-mythic { background: #fbcfe8; color: #831843; }
        .rarity-transcendent { background: #fca5a5; color: #7f1d1d; }
        
        .stats { font-size: 11px; color: #718096; margin-top: 6px; }
        .pagination { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .page-btn { padding: 6px 10px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .page-btn.active { background: #2d3748; color: white; border-color: #2d3748; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 25px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        
        .sword-detail { text-align: center; }
        .sword-detail-name { font-size: 20px; font-weight: 800; margin-bottom: 10px; }
        .sword-detail-info { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .info-row:last-child { border-bottom: none; }
        
        .loading { text-align: center; padding: 40px 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2d3748; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üó°Ô∏è Í≤Ä ÎèÑÍ∞ê</h1>
        <button onclick="location.href='index.html'" title="ÌôàÏúºÎ°ú"><i class="fa-solid fa-house"></i></button>
    </div>
    
    <div class="filter-section">
        <div class="filter-group">
            <button class="filter-btn active" onclick="filterByType('all')">Ï†ÑÏ≤¥</button>
            <button class="filter-btn" onclick="filterByType('normal')">ÏùºÎ∞ò</button>
            <button class="filter-btn" onclick="filterByType('hidden')">ÌûàÎì†</button>
        </div>
        <div class="filter-group">
            <button class="filter-btn" onclick="filterByRarity('common')">ÏùºÎ∞ò</button>
            <button class="filter-btn" onclick="filterByRarity('uncommon')">Ïñ∏Ïª§Î®º</button>
            <button class="filter-btn" onclick="filterByRarity('rare')">Î†àÏñ¥</button>
            <button class="filter-btn" onclick="filterByRarity('epic')">ÏóêÌîΩ</button>
            <button class="filter-btn" onclick="filterByRarity('legendary')">Î†àÏ†ÑÎçîÎ¶¨</button>
        </div>
        <input type="text" class="search-box" id="searchBox" placeholder="Í≤Ä Ïù¥Î¶Ñ Í≤ÄÏÉâ..." onkeyup="handleSearch()">
    </div>
    
    <div id="loadingDiv" class="loading">
        <div class="spinner"></div>
        <p>Í≤Ä ÎèÑÍ∞êÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
    </div>
    
    <div id="contentDiv" style="display: none;">
        <div class="sword-grid" id="swordGrid"></div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div class="sword-detail" id="detailContent"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let allSwords = [];
    let filteredSwords = [];
    let currentPage = 1;
    let itemsPerPage = 20; // will be adaptive
    let currentTypeFilter = 'all';
    let currentRarityFilter = null;
    let user = null;
    let ownedSwordIds = new Set();

    // card size assumptions (px)
    const CARD_HEIGHT = 110; // approximate including gap
    const CARD_WIDTH = 180; // approximate including gap
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            // Í≤Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const swordData = await fetch('sword_names.json').then(r => r.json());
            allSwords = swordData.swords;
            
            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÜåÏú†Ìïú Í≤Ä Î°úÎìú
            const { data: ownedSwords } = await supabaseClient
                .from('user_swords')
                .select('sword_id')
                .eq('user_id', user.id);
            
            ownedSwords?.forEach(s => ownedSwordIds.add(s.sword_id));
            
            filteredSwords = allSwords;
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('contentDiv').style.display = 'block';
            calculateLayout();
            renderPage();
        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').innerHTML = '<p>Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
        }
    }

    // Recalculate itemsPerPage and columns based on viewport size
    function calculateLayout() {
        const container = document.querySelector('.container');
        const containerRect = container.getBoundingClientRect();
        const availableHeight = window.innerHeight - containerRect.top - 160; // header + filters + margins
        const availableWidth = containerRect.width - 20;

        const rows = Math.max(1, Math.floor(availableHeight / CARD_HEIGHT));
        const cols = Math.max(1, Math.floor(availableWidth / CARD_WIDTH));
        itemsPerPage = rows * cols;
        // update grid columns
        const grid = document.getElementById('swordGrid');
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    }

    window.addEventListener('resize', () => {
        calculateLayout();
        renderPage();
    });
    
    function filterByType(type) {
        currentTypeFilter = type;
        currentPage = 1;
        applyFilters();
        updateFilterButtons();
    }
    
    function filterByRarity(rarity) {
        currentRarityFilter = currentRarityFilter === rarity ? null : rarity;
        currentPage = 1;
        applyFilters();
    }
    
    function applyFilters() {
        filteredSwords = allSwords.filter(sword => {
            const typeMatch = currentTypeFilter === 'all' || sword.type === currentTypeFilter;
            const rarityMatch = !currentRarityFilter || sword.rarity === currentRarityFilter;
            return typeMatch && rarityMatch;
        });
        renderPage();
    }
    
    function handleSearch() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        filteredSwords = allSwords.filter(sword => {
            const typeMatch = currentTypeFilter === 'all' || sword.type === currentTypeFilter;
            const rarityMatch = !currentRarityFilter || sword.rarity === currentRarityFilter;
            const nameMatch = sword.name.toLowerCase().includes(query);
            return typeMatch && rarityMatch && nameMatch;
        });
        currentPage = 1;
        renderPage();
    }
    
    function renderPage() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredSwords.slice(start, end);
        
        const grid = document.getElementById('swordGrid');
        // Virtualize basic rendering by creating elements manually
        grid.innerHTML = '';
        pageItems.forEach(sword => {
            const card = document.createElement('div');
            card.className = `sword-card ${ownedSwordIds.has(sword.id) ? 'owned' : ''} ${sword.type === 'hidden' ? 'hidden' : ''}`;
            card.setAttribute('role', 'button');
            card.tabIndex = 0;
            card.onclick = () => showDetail(sword.id);

            const name = document.createElement('div'); name.className = 'sword-name'; name.textContent = sword.name;
            const lvl = document.createElement('div'); lvl.className = 'sword-level'; lvl.textContent = `Lv. ${sword.level}`;
            const rarity = document.createElement('div'); rarity.className = `sword-rarity rarity-${sword.rarity}`; rarity.textContent = (sword.rarity||'').toUpperCase();
            const stats = document.createElement('div'); stats.className = 'stats'; stats.textContent = `ID: ${sword.id}`;

            card.appendChild(name);
            card.appendChild(lvl);
            card.appendChild(rarity);
            card.appendChild(stats);

            grid.appendChild(card);
        });
        
        renderPagination();
    }
    
    function renderPagination() {
        const totalPages = Math.ceil(filteredSwords.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }
        pagination.innerHTML = html;
    }
    
    function goToPage(page) {
        currentPage = page;
        renderPage();
        window.scrollTo(0, 0);
    }
    
    function showDetail(swordId) {
        const sword = allSwords.find(s => s.id === swordId);
        if (!sword) return;
        
        const owned = ownedSwordIds.has(swordId);
        const detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = `
            <div class="sword-detail-name">${sword.name}</div>
            <div class="sword-detail-info">
                <div class="info-row">
                    <span>ID</span>
                    <strong>${sword.id}</strong>
                </div>
                <div class="info-row">
                    <span>ÌÉÄÏûÖ</span>
                    <strong>${sword.type === 'normal' ? 'ÏùºÎ∞ò' : 'ÌûàÎì†'}</strong>
                </div>
                <div class="info-row">
                    <span>Í∏∞Î≥∏ Í≤Ä</span>
                    <strong>${sword.baseType}</strong>
                </div>
                <div class="info-row">
                    <span>Í∞ïÌôî Î†àÎ≤®</span>
                    <strong>${sword.level}</strong>
                </div>
                <div class="info-row">
                    <span>Îì±Í∏â</span>
                    <strong>${sword.rarity.toUpperCase()}</strong>
                </div>
                <div class="info-row">
                    <span>ÏÜåÏú† Ïó¨Î∂Ä</span>
                    <strong>${owned ? '‚úÖ ÏÜåÏú†Ï§ë' : '‚ùå ÎØ∏ÏÜåÏú†'}</strong>
                </div>
            </div>
        `;
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }
    
    function updateFilterButtons() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.filter-btn')[currentTypeFilter === 'all' ? 0 : (currentTypeFilter === 'normal' ? 1 : 2)].classList.add('active');
    }
    
    init();
</script>
</body>
</html>
