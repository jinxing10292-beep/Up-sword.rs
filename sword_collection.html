<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Í≤Ä ÎèÑÍ∞ê - Up Sword</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="minigame-responsive.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Pretendard', sans-serif; 
            padding: 20px 10px; 
            min-height: 100vh;
        }
        
        .container { width: 100%; max-width: 480px; margin: 0 auto; }
        
        .header { 
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white; 
            padding: 20px 24px; 
            border-radius: 24px 24px 0 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header h1 { 
            font-size: 24px; 
            font-weight: 900; 
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header button { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            font-size: 20px; 
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.3s;
            z-index: 1;
        }
        
        .header button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .filter-section { 
            background: white; 
            padding: 20px; 
            border-radius: 0 0 24px 24px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .filter-group { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 12px; 
            flex-wrap: wrap; 
        }
        
        .filter-btn { 
            padding: 10px 16px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 700; 
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .filter-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .filter-btn:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .filter-btn.active { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .search-box { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .sword-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .sword-card { 
            background: white; 
            border-radius: 16px; 
            padding: 16px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 3px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        
        .sword-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(102, 126, 234, 0.05));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sword-card:hover::before {
            opacity: 1;
        }
        
        .sword-card:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .sword-card.owned { 
            border-color: #48bb78; 
            background: linear-gradient(135deg, #f0fff4, #ffffff);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.2);
        }
        
        .sword-card.owned::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #48bb78;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.4);
        }
        
        .sword-card.hidden { 
            border-color: #9f7aea; 
            background: linear-gradient(135deg, #faf5ff, #ffffff);
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.2);
        }
        
        .sword-card.hidden::after {
            content: '‚òÖ';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #9f7aea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(159, 122, 234, 0.4);
        }
        
        .sword-name { 
            font-size: 13px; 
            font-weight: 800; 
            color: #2d3748; 
            margin-bottom: 6px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            position: relative;
            z-index: 1;
        }
        
        .sword-level { 
            font-size: 12px; 
            color: #718096; 
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .sword-rarity { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 10px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rarity-common { background: linear-gradient(135deg, #e2e8f0, #cbd5e0); color: #2d3748; }
        .rarity-uncommon { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #22543d; }
        .rarity-rare { background: linear-gradient(135deg, #bee3f8, #90cdf4); color: #2c5282; }
        .rarity-epic { background: linear-gradient(135deg, #d6bcfa, #b794f4); color: #553399; }
        .rarity-legendary { background: linear-gradient(135deg, #fed7aa, #fbd38d); color: #7c2d12; }
        .rarity-mythic { background: linear-gradient(135deg, #fbcfe8, #f9a8d4); color: #831843; }
        .rarity-transcendent { background: linear-gradient(135deg, #fca5a5, #f87171); color: #7f1d1d; }
        
        .stats { 
            font-size: 11px; 
            color: #718096; 
            margin-top: 8px;
            font-weight: 600;
        }
        
        .pagination { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .page-btn { 
            padding: 10px 14px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 13px;
            font-weight: 700;
            transition: all 0.3s;
            min-width: 40px;
        }
        
        .page-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .page-btn.active { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content { 
            background: white; 
            width: 90%; 
            max-width: 400px; 
            border-radius: 24px; 
            padding: 30px; 
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            font-size: 28px; 
            cursor: pointer;
            color: #718096;
            transition: all 0.3s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: #f7fafc;
            color: #2d3748;
            transform: rotate(90deg);
        }
        
        .sword-detail { text-align: center; }
        
        .sword-detail-name { 
            font-size: 24px; 
            font-weight: 900; 
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sword-detail-info { 
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 15px; 
            text-align: left;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }
        
        .info-row:last-child { border-bottom: none; }
        
        .info-row span:first-child {
            color: #718096;
            font-weight: 600;
        }
        
        .info-row strong {
            color: #2d3748;
            font-weight: 800;
        }
        
        .loading { 
            text-align: center; 
            padding: 60px 20px;
            color: white;
        }
        
        .loading p {
            margin-top: 15px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .spinner { 
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùºÎßÅ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3, #6a3f8f);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üó°Ô∏è Í≤Ä ÎèÑÍ∞ê</h1>
        <button onclick="location.href='index.html'" title="ÌôàÏúºÎ°ú"><i class="fa-solid fa-house"></i></button>
    </div>
    
    <div class="filter-section">
        <div class="stats-summary" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px; border-radius: 12px; margin-bottom: 15px; color: white; display: flex; justify-content: space-around; text-align: center;">
            <div>
                <div style="font-size: 24px; font-weight: 900;" id="totalOwned">0</div>
                <div style="font-size: 11px; opacity: 0.9;">Î≥¥Ïú† Í≤Ä</div>
            </div>
            <div style="width: 2px; background: rgba(255,255,255,0.3);"></div>
            <div>
                <div style="font-size: 24px; font-weight: 900;" id="totalSwords">0</div>
                <div style="font-size: 11px; opacity: 0.9;">Ï†ÑÏ≤¥ Í≤Ä</div>
            </div>
            <div style="width: 2px; background: rgba(255,255,255,0.3);"></div>
            <div>
                <div style="font-size: 24px; font-weight: 900;" id="collectionRate">0%</div>
                <div style="font-size: 11px; opacity: 0.9;">ÏàòÏßëÎ•†</div>
            </div>
        </div>
        
        <div class="filter-group">
            <button class="filter-btn active" onclick="filterByType('all')">Ï†ÑÏ≤¥</button>
            <button class="filter-btn" onclick="filterByType('normal')">ÏùºÎ∞ò</button>
            <button class="filter-btn" onclick="filterByType('hidden')">ÌûàÎì†</button>
        </div>
        <div class="filter-group">
            <button class="filter-btn" onclick="filterByRarity('common')">ÏùºÎ∞ò</button>
            <button class="filter-btn" onclick="filterByRarity('uncommon')">Ïñ∏Ïª§Î®º</button>
            <button class="filter-btn" onclick="filterByRarity('rare')">Î†àÏñ¥</button>
            <button class="filter-btn" onclick="filterByRarity('epic')">ÏóêÌîΩ</button>
            <button class="filter-btn" onclick="filterByRarity('legendary')">Î†àÏ†ÑÎçîÎ¶¨</button>
        </div>
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Í≤Ä Ïù¥Î¶Ñ Í≤ÄÏÉâ..." onkeyup="handleSearch()">
    </div>
    
    <div id="loadingDiv" class="loading">
        <div class="spinner"></div>
        <p>Í≤Ä ÎèÑÍ∞êÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
    </div>
    
    <div id="contentDiv" style="display: none;">
        <div class="sword-grid" id="swordGrid"></div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div class="sword-detail" id="detailContent"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://blkghenrfizqjfigvkql.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2doZW5yZml6cWpmaWd2a3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzM5MDksImV4cCI6MjA4NTU0OTkwOX0.L6oh-I5EKTyxkTtjzm95q-hBQaUwIq34RaE6UXV6gJg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let allSwords = [];
    let filteredSwords = [];
    let currentPage = 1;
    let itemsPerPage = 20; // will be adaptive
    let currentTypeFilter = 'all';
    let currentRarityFilter = null;
    let user = null;
    let ownedSwordIds = new Set();

    // card size assumptions (px)
    const CARD_HEIGHT = 110; // approximate including gap
    const CARD_WIDTH = 180; // approximate including gap
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            // Í≤Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const swordData = await fetch('sword_names.json').then(r => r.json());
            allSwords = swordData.swords || [];
            
            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÜåÏú†Ìïú Í≤Ä Î°úÎìú
            const { data: ownedSwords, error: swordError } = await supabaseClient
                .from('user_swords')
                .select('sword_id')
                .eq('user_id', user.id);
            
            if (swordError) {
                console.warn('ÏÜåÏú† Í≤Ä Î°úÎìú Ïã§Ìå®:', swordError);
            }
            
            if (ownedSwords && ownedSwords.length > 0) {
                ownedSwords.forEach(s => {
                    if (s.sword_id) {
                        ownedSwordIds.add(s.sword_id);
                    }
                });
            }
            
            filteredSwords = allSwords;
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('contentDiv').style.display = 'block';
            calculateLayout();
            renderPage();
        } catch (e) {
            console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', e);
            document.getElementById('loadingDiv').innerHTML = '<p>Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + e.message + '</p>';
        }
    }

    // Recalculate itemsPerPage and columns based on viewport size
    function calculateLayout() {
        const container = document.querySelector('.container');
        const containerRect = container.getBoundingClientRect();
        const availableHeight = window.innerHeight - containerRect.top - 160; // header + filters + margins
        const availableWidth = containerRect.width - 20;

        const rows = Math.max(1, Math.floor(availableHeight / CARD_HEIGHT));
        const cols = Math.max(1, Math.floor(availableWidth / CARD_WIDTH));
        itemsPerPage = rows * cols;
        // update grid columns
        const grid = document.getElementById('swordGrid');
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    }

    window.addEventListener('resize', () => {
        calculateLayout();
        renderPage();
    });
    
    function filterByType(type) {
        currentTypeFilter = type;
        currentPage = 1;
        applyFilters();
        updateFilterButtons();
    }
    
    function filterByRarity(rarity) {
        currentRarityFilter = currentRarityFilter === rarity ? null : rarity;
        currentPage = 1;
        applyFilters();
    }
    
    function applyFilters() {
        filteredSwords = allSwords.filter(sword => {
            const typeMatch = currentTypeFilter === 'all' || sword.type === currentTypeFilter;
            const rarityMatch = !currentRarityFilter || sword.rarity === currentRarityFilter;
            return typeMatch && rarityMatch;
        });
        renderPage();
    }
    
    function handleSearch() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        filteredSwords = allSwords.filter(sword => {
            const typeMatch = currentTypeFilter === 'all' || sword.type === currentTypeFilter;
            const rarityMatch = !currentRarityFilter || sword.rarity === currentRarityFilter;
            const nameMatch = sword.name.toLowerCase().includes(query);
            return typeMatch && rarityMatch && nameMatch;
        });
        currentPage = 1;
        renderPage();
    }
    
    function renderPage() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredSwords.slice(start, end);
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        updateStats();
        
        const grid = document.getElementById('swordGrid');
        // Virtualize basic rendering by creating elements manually
        grid.innerHTML = '';
        pageItems.forEach(sword => {
            const card = document.createElement('div');
            card.className = `sword-card ${ownedSwordIds.has(sword.id) ? 'owned' : ''} ${sword.type === 'hidden' ? 'hidden' : ''}`;
            card.setAttribute('role', 'button');
            card.tabIndex = 0;
            card.onclick = () => showDetail(sword.id);

            const name = document.createElement('div'); name.className = 'sword-name'; name.textContent = sword.name;
            const lvl = document.createElement('div'); lvl.className = 'sword-level'; lvl.textContent = `Lv. ${sword.level}`;
            const rarity = document.createElement('div'); rarity.className = `sword-rarity rarity-${sword.rarity}`; rarity.textContent = (sword.rarity||'').toUpperCase();
            const stats = document.createElement('div'); stats.className = 'stats'; stats.textContent = `ID: ${sword.id}`;

            card.appendChild(name);
            card.appendChild(lvl);
            card.appendChild(rarity);
            card.appendChild(stats);

            grid.appendChild(card);
        });
        
        renderPagination();
    }
    
    function updateStats() {
        const totalOwned = ownedSwordIds.size;
        const totalSwords = allSwords.length;
        const collectionRate = totalSwords > 0 ? Math.floor((totalOwned / totalSwords) * 100) : 0;
        
        document.getElementById('totalOwned').textContent = totalOwned;
        document.getElementById('totalSwords').textContent = totalSwords;
        document.getElementById('collectionRate').textContent = collectionRate + '%';
    }
    
    function renderPagination() {
        const totalPages = Math.ceil(filteredSwords.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }
        pagination.innerHTML = html;
    }
    
    function goToPage(page) {
        currentPage = page;
        renderPage();
        window.scrollTo(0, 0);
    }
    
    function showDetail(swordId) {
        const sword = allSwords.find(s => s.id === swordId);
        if (!sword) return;
        
        const owned = ownedSwordIds.has(swordId);
        const detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = `
            <div class="sword-detail-name">${sword.name}</div>
            <div class="sword-detail-info">
                <div class="info-row">
                    <span>ID</span>
                    <strong>${sword.id}</strong>
                </div>
                <div class="info-row">
                    <span>ÌÉÄÏûÖ</span>
                    <strong>${sword.type === 'normal' ? 'ÏùºÎ∞ò' : 'ÌûàÎì†'}</strong>
                </div>
                <div class="info-row">
                    <span>Í∏∞Î≥∏ Í≤Ä</span>
                    <strong>${sword.baseType}</strong>
                </div>
                <div class="info-row">
                    <span>Í∞ïÌôî Î†àÎ≤®</span>
                    <strong>${sword.level}</strong>
                </div>
                <div class="info-row">
                    <span>Îì±Í∏â</span>
                    <strong>${sword.rarity.toUpperCase()}</strong>
                </div>
                <div class="info-row">
                    <span>ÏÜåÏú† Ïó¨Î∂Ä</span>
                    <strong>${owned ? '‚úÖ ÏÜåÏú†Ï§ë' : '‚ùå ÎØ∏ÏÜåÏú†'}</strong>
                </div>
            </div>
        `;
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }
    
    function updateFilterButtons() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.filter-btn')[currentTypeFilter === 'all' ? 0 : (currentTypeFilter === 'normal' ? 1 : 2)].classList.add('active');
    }
    
    init();
</script>
</body>
</html>
