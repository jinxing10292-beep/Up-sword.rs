<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë£°ë › - Up Sword</title>
    <link rel="icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <link rel="shortcut icon" href="https://i.ifh.cc/vXLMs6.jpg" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0f172a; font-family: 'Pretendard', sans-serif; padding: 20px 10px; color: white; }
        
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        .header { background: #1e293b; color: white; padding: 16px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; border: 2px solid #fbbf24; }
        .header h1 { font-size: 20px; font-weight: 800; color: #fbbf24; }
        .header button { background: none; border: none; color: #fbbf24; font-size: 20px; cursor: pointer; }
        
        .user-stats { background: #1e293b; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid #fbbf24; border-right: 2px solid #fbbf24; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .stat-gold { color: #fbbf24; }
        .stat-money { color: #a855f7; }
        
        .roulette-container { background: #1e293b; padding: 20px; border-radius: 0 0 20px 20px; border: 2px solid #fbbf24; border-top: none; }
        
        .roulette-wheel { width: 280px; height: 280px; margin: 0 auto 20px; position: relative; border-radius: 50%; background: conic-gradient(from 0deg, #dc2626 0deg 9.73deg, #000000 9.73deg 19.46deg, #dc2626 19.46deg 29.19deg, #000000 29.19deg 38.92deg, #dc2626 38.92deg 48.65deg, #000000 48.65deg 58.38deg, #dc2626 58.38deg 68.11deg, #000000 68.11deg 77.84deg, #dc2626 77.84deg 87.57deg, #000000 87.57deg 97.3deg, #dc2626 97.3deg 107.03deg, #000000 107.03deg 116.76deg, #dc2626 116.76deg 126.49deg, #000000 126.49deg 136.22deg, #dc2626 136.22deg 145.95deg, #000000 145.95deg 155.68deg, #dc2626 155.68deg 165.41deg, #000000 165.41deg 175.14deg, #dc2626 175.14deg 184.87deg, #000000 184.87deg 194.6deg, #dc2626 194.6deg 204.33deg, #000000 204.33deg 214.06deg, #dc2626 214.06deg 223.79deg, #000000 223.79deg 233.52deg, #dc2626 233.52deg 243.25deg, #000000 243.25deg 252.98deg, #dc2626 252.98deg 262.71deg, #000000 262.71deg 272.44deg, #dc2626 272.44deg 282.17deg, #000000 282.17deg 291.9deg, #dc2626 291.9deg 301.63deg, #000000 301.63deg 311.36deg, #dc2626 311.36deg 321.09deg, #000000 321.09deg 330.82deg, #dc2626 330.82deg 340.55deg, #000000 340.55deg 350.28deg, #22c55e 350.28deg 360deg); border: 4px solid #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1); }
        
        .roulette-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: #fbbf24; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; z-index: 10; }
        
        .roulette-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #fbbf24; z-index: 5; }
        
        .betting-area { margin-bottom: 20px; }
        .betting-title { font-size: 16px; font-weight: 700; margin-bottom: 10px; color: #fbbf24; }
        
        .number-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-bottom: 15px; }
        .number-btn { aspect-ratio: 1; border: 2px solid #374151; background: #1f2937; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .number-btn.red { background: #dc2626; border-color: #dc2626; }
        .number-btn.black { background: #000000; border-color: #000000; }
        .number-btn.green { background: #22c55e; border-color: #22c55e; }
        .number-btn.selected { box-shadow: 0 0 10px #fbbf24; border-color: #fbbf24; }
        .number-btn:hover { transform: scale(1.1); }
        
        .special-bets { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .special-btn { padding: 8px; border: 2px solid #374151; background: #1f2937; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: 0.2s; text-align: center; }
        .special-btn.selected { background: #fbbf24; color: #000; border-color: #fbbf24; }
        .special-btn:hover { background: #374151; }
        
        .bet-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .bet-amount { flex: 1; padding: 10px; border: 2px solid #374151; background: #1f2937; color: white; border-radius: 8px; text-align: center; font-weight: 700; }
        .bet-btn { padding: 8px 12px; border: 2px solid #fbbf24; background: #fbbf24; color: #000; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; }
        .bet-btn:hover { background: #f59e0b; border-color: #f59e0b; }
        
        .action-buttons { display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-spin { background: #dc2626; color: white; }
        .btn-spin:hover { background: #b91c1c; }
        .btn-spin:disabled { background: #374151; cursor: not-allowed; }
        .btn-clear { background: #6b7280; color: white; }
        .btn-clear:hover { background: #4b5563; }
        
        .result-display { background: #1f2937; border: 2px solid #fbbf24; border-radius: 12px; padding: 15px; margin-top: 20px; text-align: center; display: none; }
        .result-number { font-size: 48px; font-weight: 900; margin-bottom: 10px; }
        .result-number.red { color: #dc2626; }
        .result-number.black { color: #ffffff; }
        .result-number.green { color: #22c55e; }
        .result-text { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .result-win { color: #22c55e; }
        .result-lose { color: #dc2626; }
        
        .loading { text-align: center; padding: 40px 20px; }
        .spinner { border: 4px solid #374151; border-top: 4px solid #fbbf24; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .spinning { animation: roulette-spin 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes roulette-spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(1800deg); } 
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ° ë£°ë ›</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="location.href='roulette_history.html'" title="ë£°ë › ê¸°ë¡"><i class="fa-solid fa-chart-line"></i></button>
            <button onclick="location.href='home.html'" title="í™ˆìœ¼ë¡œ"><i class="fa-solid fa-house"></i></button>
        </div>
    </div>
    
    <div class="user-stats">
        <div class="stat-item stat-gold">
            <i class="fa-solid fa-coins"></i>
            <span id="userGold">0</span>G
        </div>
        <div class="stat-item stat-money">
            <i class="fa-solid fa-gem"></i>
            <span id="userMoney">0</span>M
        </div>
    </div>
    
    <div class="roulette-container">
        <div id="loadingDiv" class="loading">
            <div class="spinner"></div>
            <p>ë£°ë ›ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <div id="gameDiv" style="display: none;">
            <div class="roulette-wheel" id="rouletteWheel">
                <div class="roulette-pointer"></div>
                <div class="roulette-center">ğŸ¯</div>
            </div>
            
            <div class="betting-area">
                <div class="betting-title">ë²ˆí˜¸ ì„ íƒ (ë°°ë‹¹: 50ë°°, ìµœëŒ€ 3ê°œ)</div>
                <div class="number-grid" id="numberGrid"></div>
                
                <div class="betting-title">íŠ¹ìˆ˜ ë² íŒ… (ìµœëŒ€ 2ê°œ)</div>
                <div class="special-bets">
                    <button class="special-btn" data-bet="red">ë¹¨ê°„ìƒ‰ (2ë°°)</button>
                    <button class="special-btn" data-bet="black">ê²€ì€ìƒ‰ (2ë°°)</button>
                    <button class="special-btn" data-bet="even">ì§ìˆ˜ (2ë°°)</button>
                    <button class="special-btn" data-bet="odd">í™€ìˆ˜ (2ë°°)</button>
                    <button class="special-btn" data-bet="low">1-22 (2ë°°)</button>
                    <button class="special-btn" data-bet="high">23-45 (2ë°°)</button>
                </div>
                
                <div class="bet-controls">
                    <input type="number" class="bet-amount" id="betAmount" placeholder="ë² íŒ… ê¸ˆì•¡" min="100" max="1000000" value="1000">
                    <button class="bet-btn" onclick="setBetAmount(1000)">1K</button>
                    <button class="bet-btn" onclick="setBetAmount(10000)">10K</button>
                    <button class="bet-btn" onclick="setBetAmount(100000)">100K</button>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn btn-clear" onclick="clearBets()">ë² íŒ… ì´ˆê¸°í™”</button>
                    <button class="action-btn btn-spin" id="spinBtn" onclick="spinRoulette()">ë£°ë › ëŒë¦¬ê¸°</button>
                </div>
            </div>
            
            <div class="result-display" id="resultDisplay">
                <div class="result-number" id="resultNumber">0</div>
                <div class="result-text" id="resultText">ê²°ê³¼</div>
                <div id="winAmount"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://glwpcuokjzfdwnsjhyuc.supabase.co';
    const SUPABASE_KEY = ''; // TODO: Add your anon key here
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let user = null;
    let selectedBets = [];
    let isSpinning = false;
    
    // Roulette system configuration - Updated per requirements
    const ROULETTE_CONFIG = {
        bettingLimits: {
            maxSpecialBets: 2,  // Changed from 3 to 2
            maxNumberBets: 3    // Changed from 5 to 3
        },
        payoutRates: {
            numberBetMultiplier: 50,  // Changed from 95 to 50
            specialBetMultipliers: {
                red: 2, black: 2, odd: 2, even: 2, high: 2, low: 2
            }
        },
        numberRange: {
            min: 0,
            max: 45  // Changed from 36 to 45
        }
    };
    
    // ë£°ë › ë²ˆí˜¸ì™€ ìƒ‰ìƒ ì •ì˜ (í™•ì¥ëœ 0-45 ë²”ìœ„)
    function getRouletteNumbers() {
        const numbers = { 0: 'green' };
        // Extended roulette numbers 1-45 with alternating red/black pattern
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36, 37, 39, 41, 43, 45];
        
        for (let i = 1; i <= ROULETTE_CONFIG.numberRange.max; i++) {
            numbers[i] = redNumbers.includes(i) ? 'red' : 'black';
        }
        
        return numbers;
    }
    
    const ROULETTE_NUMBERS = getRouletteNumbers();
    
    async function init() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = "login.html"; return; }
            
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            user = p;
            
            updateStats();
            createNumberGrid();
            setupEventListeners();
            
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('gameDiv').style.display = 'block';
        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').innerHTML = '<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
    
    function updateStats() {
        document.getElementById('userGold').innerText = (user.gold || 0).toLocaleString();
        document.getElementById('userMoney').innerText = (user.money || 0).toLocaleString();
    }
    
    function createNumberGrid() {
        const grid = document.getElementById('numberGrid');
        for (let i = 0; i <= ROULETTE_CONFIG.numberRange.max; i++) {
            const btn = document.createElement('button');
            btn.className = `number-btn ${ROULETTE_NUMBERS[i]}`;
            btn.textContent = i;
            btn.dataset.number = i;
            btn.onclick = () => toggleNumberBet(i);
            grid.appendChild(btn);
        }
    }
    
    function setupEventListeners() {
        document.querySelectorAll('.special-btn').forEach(btn => {
            btn.onclick = () => toggleSpecialBet(btn.dataset.bet);
        });
    }
    
    function toggleNumberBet(number) {
        const btn = document.querySelector(`[data-number="${number}"]`);
        const betIndex = selectedBets.findIndex(bet => bet.type === 'number' && bet.value === number);
        
        if (betIndex >= 0) {
            // Remove existing bet
            selectedBets.splice(betIndex, 1);
            btn.classList.remove('selected');
        } else {
            // Validate number betting limit before adding new bet
            const numberBets = selectedBets.filter(bet => bet.type === 'number');
            if (numberBets.length >= ROULETTE_CONFIG.bettingLimits.maxNumberBets) {
                // Show appropriate error message and maintain current selections
                showErrorMessage(`ë²ˆí˜¸ëŠ” ìµœëŒ€ ${ROULETTE_CONFIG.bettingLimits.maxNumberBets}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return; // Prevent selection without adding the new bet
            }
            
            // Add new number bet
            selectedBets.push({ type: 'number', value: number, payout: ROULETTE_CONFIG.payoutRates.numberBetMultiplier });
            btn.classList.add('selected');
        }
    }
    
    function showErrorMessage(message) {
        // Create or update error message display
        let errorDiv = document.getElementById('errorMessage');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'errorMessage';
            errorDiv.style.cssText = `
                background: #dc2626;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                margin: 10px 0;
                font-weight: 600;
                text-align: center;
                border: 2px solid #b91c1c;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            // Insert error message after betting title
            const bettingArea = document.querySelector('.betting-area');
            const specialTitle = bettingArea.querySelector('.betting-title:nth-of-type(2)');
            specialTitle.parentNode.insertBefore(errorDiv, specialTitle.nextSibling);
        }
        
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }, 3000);
    }
    
    function toggleSpecialBet(betType) {
        const btn = document.querySelector(`[data-bet="${betType}"]`);
        const betIndex = selectedBets.findIndex(bet => bet.type === betType);
        
        if (betIndex >= 0) {
            // Remove existing bet
            selectedBets.splice(betIndex, 1);
            btn.classList.remove('selected');
        } else {
            // Validate special betting limit before adding new bet
            const specialBets = selectedBets.filter(bet => bet.type !== 'number');
            if (specialBets.length >= ROULETTE_CONFIG.bettingLimits.maxSpecialBets) {
                // Show appropriate error message and maintain current selections
                showErrorMessage(`íŠ¹ìˆ˜ ë² íŒ…ì€ ìµœëŒ€ ${ROULETTE_CONFIG.bettingLimits.maxSpecialBets}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return; // Prevent selection without adding the new bet
            }
            
            // Add new special bet
            selectedBets.push({ type: betType, payout: ROULETTE_CONFIG.payoutRates.specialBetMultipliers[betType] });
            btn.classList.add('selected');
        }
    }
    
    function setBetAmount(amount) {
        document.getElementById('betAmount').value = amount;
    }
    
    function clearBets() {
        selectedBets = [];
        document.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('resultDisplay').style.display = 'none';
    }
    
    async function spinRoulette() {
        if (isSpinning) return;
        if (selectedBets.length === 0) return alert('ë² íŒ…ì„ ì„ íƒí•˜ì„¸ìš”.');
        
        const betAmount = parseInt(document.getElementById('betAmount').value) || 0;
        if (betAmount < 100) return alert('ìµœì†Œ ë² íŒ… ê¸ˆì•¡ì€ 100Gì…ë‹ˆë‹¤.');
        if (betAmount > user.gold) return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        
        const totalBet = betAmount * selectedBets.length;
        if (totalBet > user.gold) return alert('ì´ ë² íŒ… ê¸ˆì•¡ì´ ë³´ìœ  ê³¨ë“œë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
        
        isSpinning = true;
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('resultDisplay').style.display = 'none';
        
        // ê³¨ë“œ ì°¨ê°
        user.gold -= totalBet;
        updateStats();
        
        // ë£°ë › ëŒë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
        const wheel = document.getElementById('rouletteWheel');
        const winningNumber = Math.floor(Math.random() * (ROULETTE_CONFIG.numberRange.max + 1)); // 0-45
        
        wheel.classList.add('spinning');
        
        setTimeout(async () => {
            wheel.classList.remove('spinning');
            await showResult(winningNumber, betAmount);
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;
        }, 3000);
    }
    
    async function showResult(winningNumber, betAmount) {
        const winningColor = ROULETTE_NUMBERS[winningNumber];
        let totalWin = 0;
        let winningBets = [];
        
        // ë² íŒ… ê²°ê³¼ ê³„ì‚°
        selectedBets.forEach(bet => {
            let isWin = false;
            
            switch (bet.type) {
                case 'number':
                    isWin = bet.value === winningNumber;
                    break;
                case 'red':
                    isWin = winningColor === 'red';
                    break;
                case 'black':
                    isWin = winningColor === 'black';
                    break;
                case 'even':
                    isWin = winningNumber > 0 && winningNumber % 2 === 0;
                    break;
                case 'odd':
                    isWin = winningNumber > 0 && winningNumber % 2 === 1;
                    break;
                case 'low':
                    isWin = winningNumber >= 1 && winningNumber <= 22;
                    break;
                case 'high':
                    isWin = winningNumber >= 23 && winningNumber <= 45;
                    break;
            }
            
            if (isWin) {
                const winAmount = betAmount * bet.payout;
                totalWin += winAmount;
                winningBets.push({ ...bet, winAmount });
            }
        });
        
        // ê²°ê³¼ í‘œì‹œ
        const resultNumber = document.getElementById('resultNumber');
        const resultText = document.getElementById('resultText');
        const winAmountDiv = document.getElementById('winAmount');
        
        resultNumber.textContent = winningNumber;
        resultNumber.className = `result-number ${winningColor}`;
        
        if (totalWin > 0) {
            resultText.textContent = 'ğŸ‰ ë‹¹ì²¨!';
            resultText.className = 'result-text result-win';
            winAmountDiv.innerHTML = `<div style="color: #22c55e; font-weight: 700; font-size: 18px;">+${totalWin.toLocaleString()}G</div>`;
            
            // ê³¨ë“œ ì§€ê¸‰
            user.gold += totalWin;
        } else {
            resultText.textContent = 'ğŸ˜¢ ê½!';
            resultText.className = 'result-text result-lose';
            winAmountDiv.innerHTML = `<div style="color: #dc2626; font-weight: 700; font-size: 18px;">-${(betAmount * selectedBets.length).toLocaleString()}G</div>`;
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ë° ê²Œì„ ê¸°ë¡ ì €ì¥
        try {
            const netResult = totalWin - (betAmount * selectedBets.length);
            
            // ê³¨ë“œ ì—…ë°ì´íŠ¸
            const { error: goldError } = await supabaseClient
                .from('profiles')
                .update({ gold: user.gold })
                .eq('id', user.id);
            
            if (goldError) throw goldError;
            
            // ë£°ë › ê²Œì„ ê¸°ë¡ ì €ì¥
            const { error: gameError } = await supabaseClient
                .from('roulette_games')
                .insert({
                    user_id: user.id,
                    winning_number: winningNumber,
                    total_bet_amount: betAmount * selectedBets.length,
                    total_win_amount: totalWin,
                    net_result: netResult,
                    bets_placed: selectedBets
                });
            
            if (gameError) {
                console.log('ë£°ë › ê²Œì„ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', gameError);
            }
        } catch (e) {
            console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
        }
        
        updateStats();
        document.getElementById('resultDisplay').style.display = 'block';
        
        // ë² íŒ… ì´ˆê¸°í™”
        setTimeout(() => {
            clearBets();
        }, 5000);
    }
    
    init();
</script>
</body>
</html>